<!DOCTYPE html>
<html lang="vi">
<head>
  <%- include('partials/head') %>
  <link rel="stylesheet" href="/mixishop/css/account.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>

<body>
  <%- include('partials/icons') %>
  <%- include('partials/header') %>

  <%
    // ===== Guards: tránh ReferenceError khi biến không được truyền vào =====
    const _error   = (typeof error   !== 'undefined' && error)   ? error   : null;
    const _success = (typeof success !== 'undefined' && success) ? success : null;
    const u        = (typeof user    !== 'undefined' && user)    ? user    : {};
  %>

  <% if (_error) { %>
    <div class="alert alert-danger container mt-3"><%= _error %></div>
  <% } %>

  <% if (_success) { %>
    <div class="alert alert-success container mt-3"><%= _success %></div>
  <% } %>

  <main class="container my-4">
    <div class="row">
      <div class="col-lg-3 mb-4">
        <%- include('account/_sidebar') %>
      </div>

      <div class="col-lg-9">
        <div class="account-card p-3 p-md-4 bg-white rounded-3 shadow-sm">
          <!-- ====== Nội dung riêng của account_profile ====== -->
          <h3 class="mb-4">Hồ Sơ Của Tôi</h3>

          <form action="/account/profile/update" method="POST" class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Tên</label>
              <input name="full_name" class="form-control" value="<%= u.full_name || '' %>">
            </div>

            <div class="col-md-6">
              <label class="form-label">Email</label>
              <input name="email" type="email" class="form-control" value="<%= u.email || '' %>">
            </div>

            <div class="col-md-6">
              <label class="form-label">Số điện thoại</label>
              <input name="phone" class="form-control" value="<%= u.phone || '' %>">
            </div>

            <div class="col-md-6">
              <label class="form-label d-block">Giới tính</label>
              <div class="d-flex gap-3">
                <label class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="gender"
                    value="male"
                    <%= u.gender === 'male' ? 'checked' : '' %>
                  >
                  Nam
                </label>

                <label class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="gender"
                    value="female"
                    <%= u.gender === 'female' ? 'checked' : '' %>
                  >
                  Nữ
                </label>

                <label class="form-check">
                  <input
                    class="form-check-input"
                    type="radio"
                    name="gender"
                    value="other"
                    <%= u.gender === 'other' ? 'checked' : '' %>
                  >
                  Khác
                </label>
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Ngày sinh</label>
              <input
                name="birthday"
                type="date"
                class="form-control"
                value="<%= u.birthday ? new Date(u.birthday).toISOString().slice(0,10) : '' %>"
              >
            </div>

            <div class="col-12 mt-3">
              <button class="btn btn-dark btn-pill px-4">Lưu</button>
            </div>
          </form>

          <hr class="my-4">

          <div class="d-flex align-items-center justify-content-between">
            <h5 class="mb-0">Đổi mật khẩu</h5>
            <button
              class="btn btn-dark btn-sm rounded-pill px-3"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#pwCollapse"
              aria-expanded="false"
              aria-controls="pwCollapse"
            >
              Đổi mật khẩu
            </button>
          </div>

          <div class="collapse mt-3" id="pwCollapse">
            <form action="/account/profile/change-password" method="POST" class="row g-3 password-card">
              <!-- Mật khẩu hiện tại -->
              <div class="col-12 col-md-4">
                <label class="form-label small text-muted">Mật khẩu hiện tại</label>
                <div class="input-group input-eye rounded-pill shadow-sm">
                  <input name="current_password" type="password" class="form-control border-0 ps-3">
                  <button type="button" class="btn btn-eye" aria-label="Hiện/ẩn mật khẩu">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
              </div>

              <!-- Mật khẩu mới -->
              <div class="col-12 col-md-4">
                <label class="form-label small text-muted">Mật khẩu mới</label>
                <div class="input-group input-eye rounded-pill shadow-sm">
                  <input name="new_password" type="password" class="form-control border-0 ps-3">
                  <button type="button" class="btn btn-eye" aria-label="Hiện/ẩn mật khẩu">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
              </div>

              <!-- Xác nhận mật khẩu -->
              <div class="col-12 col-md-4">
                <label class="form-label small text-muted">Nhập lại mật khẩu</label>
                <div class="input-group input-eye rounded-pill shadow-sm">
                  <input name="confirm_password" type="password" class="form-control border-0 ps-3">
                  <button type="button" class="btn btn-eye" aria-label="Hiện/ẩn mật khẩu">
                    <i class="bi bi-eye"></i>
                  </button>
                </div>
              </div>

              <div class="col-12">
                <button class="btn btn-dark rounded-pill px-4">Cập nhật</button>
              </div>
            </form>
          </div>

          <script>
            // Toggle show/hide password
            document.querySelectorAll('.password-card .btn-eye').forEach((btn) => {
              btn.addEventListener('click', () => {
                const input = btn.parentElement.querySelector('input.form-control');
                const isPw = input.type === 'password';
                input.type = isPw ? 'text' : 'password';
                btn.innerHTML = isPw ? '<i class="bi bi-eye-slash"></i>' : '<i class="bi bi-eye"></i>';
              });
            });

            // Nếu server trả về lỗi/alert -> tự mở collapse đổi mật khẩu
            (function autoOpenPwCollapse() {
              const hasError = !!document.querySelector('.alert-danger');
              const block = document.getElementById('pwCollapse');
              if (hasError && block && !block.classList.contains('show')) {
                const collapse = new bootstrap.Collapse(block, { toggle: false });
                collapse.show();
              }
            })();
          </script>

        </div>
      </div>
    </div>
  </main>

  <%- include('partials/footer') %>
  <%- include('partials/cart_drawer') %>
  <%- include('partials/quick_view') %>

  <script src="/mixishop/js/plugins/bootstrap.bundle.min.js"></script>
  <script src="/mixishop/js/plugins/jquery.min.js"></script>
  <script src="/mixishop/js/theme.js"></script>
</body>
</html>
