<!DOCTYPE html>
<html lang="vi">
<head>
  <%- include('partials/head') %>

  <link rel="stylesheet" href="/mixishop/css/account.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
</head>
<body>

  <%- include('partials/icons') %>
  <%- include('partials/header') %>

  <% 
    const u = user || {}; 
    const addrs = Array.isArray(addresses) ? addresses : []; 
  %>

  <% if (error) { %>
    <div class="alert alert-danger container mt-3"><%= error %></div>
  <% } %>

  <% if (success) { %>
    <div class="alert alert-success container mt-3"><%= success %></div>
  <% } %>

  <main class="container my-4">
    <div class="row">

      <!-- Sidebar -->
      <div class="col-lg-3 mb-4">
        <%- include('account/_sidebar') %>
      </div>

      <!-- Content -->
      <div class="col-lg-9">
        <div class="account-card p-3 p-md-4 bg-white rounded-3 shadow-sm">
          
          <div class="d-flex align-items-center justify-content-between mb-3">
            <h3 class="mb-0">Địa chỉ của tôi</h3>
            <button class="btn btn-dark btn-pill px-3" data-bs-toggle="modal" data-bs-target="#addrAddModal">
              <i class="bi bi-plus-lg me-1"></i> Thêm địa chỉ mới
            </button>
          </div>

          <% if (!addrs.length) { %>
            <div class="text-center text-secondary py-5">
              Bạn chưa có địa chỉ nào.
            </div>
          <% } %>

          <div class="vstack gap-3">
            <% addrs.forEach(function (addr) { %>
              <div class="addr-card p-3 border rounded-3 d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-semibold">
                    <!-- Hiện chỉ có address_line + is_default, không có name/phone -->
                    <% if (addr.is_default) { %>
                      <span class="badge bg-warning text-dark ms-0">Mặc định</span>
                    <% } %>

                    <% if (addr.address_type) { %>
                      <span class="badge bg-light text-dark ms-2">
                        <%= addr.address_type === "office" ? "Văn phòng" : "Nhà riêng" %>
                      </span>
                    <% } %>
                  </div>

                  <div class="mt-2">
                    <% if (addr.ward_name || addr.district_name || addr.province_name) { %>
                      <div class="text-muted small">
                        <%= [addr.ward_name, addr.district_name, addr.province_name]
                          .filter(function (x) { return x; })
                          .join(", ") %>
                      </div>
                    <% } %>

                    <div><%= addr.address_line %></div>
                  </div>

                  <% if (typeof addr.lat === "number" && typeof addr.lng === "number") { %>
                    <div class="small text-muted mt-1">
                      Tọa độ: <%= addr.lat.toFixed(6) %>, <%= addr.lng.toFixed(6) %>
                    </div>
                  <% } %>
                </div>

                <div class="ms-3 d-flex gap-2">
                  <% if (!addr.is_default) { %>
                    <!-- Set default -->
                    <form action="/account/addresses/update/<%= addr._id %>" method="POST">
                      <input type="hidden" name="is_default" value="on">
                      <button class="btn btn-outline-secondary btn-sm" type="submit">
                        Thiết lập mặc định
                      </button>
                    </form>
                  <% } %>

                  <!-- Delete -->
                  <form action="/account/addresses/delete/<%= addr._id %>" method="POST"
                        onsubmit="return confirm('Xóa địa chỉ này?')">
                    <button class="btn btn-outline-danger btn-sm" type="submit">
                      Xóa
                    </button>
                  </form>
                </div>
              </div>
            <% }); %>
          </div>

        </div>
      </div>
    </div>
  </main>

  <%- include('partials/footer') %>

  <!-- Modal thêm địa chỉ -->
  <div class="modal fade address-modal" id="addrAddModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form class="modal-content" action="/account/addresses/add" method="POST">

        <div class="modal-header">
          <h5 class="modal-title">Địa chỉ mới</h5>
          <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
        </div>

        <div class="modal-body">
          <div class="row g-3">
            <!-- Hành chính: Tỉnh / Quận / Phường -->
            <div class="col-md-4">
              <label class="form-label">Tỉnh/Thành phố</label>
              <select id="addrProvince" class="form-select" required></select>
              <input type="hidden" name="province_code" id="provinceCode">
              <input type="hidden" name="province_name" id="provinceName">
            </div>

            <div class="col-md-4">
              <label class="form-label">Quận/Huyện</label>
              <select id="addrDistrict" class="form-select" disabled required></select>
              <input type="hidden" name="district_code" id="districtCode">
              <input type="hidden" name="district_name" id="districtName">
            </div>

            <div class="col-md-4">
              <label class="form-label">Phường/Xã</label>
              <select id="addrWard" class="form-select" disabled required></select>
              <input type="hidden" name="ward_code" id="wardCode">
              <input type="hidden" name="ward_name" id="wardName">
            </div>

            <!-- Địa chỉ cụ thể (sẽ được ghép lại trước khi submit) -->
            <div class="col-12">
              <label class="form-label">Địa chỉ cụ thể</label>
              <textarea name="address_line" id="addrLine" class="form-control" rows="2" required></textarea>
              <div class="form-text">
                Ví dụ: "12 Nguyễn Trãi" – hệ thống sẽ tự ghép thêm Phường/Xã, Quận/Huyện, Tỉnh/TP.
              </div>
            </div>

            <!-- Map (tùy chọn) -->
            <div class="col-12">
              <label class="form-label">Vị trí trên bản đồ (tùy chọn)</label>
              <div id="mapPicker" class="m-map__canvas collapsed"></div>
              <button class="btn btn-dark btn-sm mt-2" type="button" id="btnToggleMap">
                <i class="bi bi-geo-alt me-1"></i> Chọn vị trí
              </button>
              <div class="small text-secondary mt-1" id="coordPreview"></div>

              <input type="hidden" name="lat" id="addrLat">
              <input type="hidden" name="lng" id="addrLng">
            </div>

            <!-- Mặc định -->
            <div class="col-12 form-check">
              <input type="checkbox" id="is_default" name="is_default" class="form-check-input">
              <label class="form-check-label" for="is_default">Đặt làm mặc định</label>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal" type="button">
            Hủy
          </button>
          <button class="btn btn-dark btn-pill" type="submit">
            <i class="bi bi-check2-circle me-1"></i> Lưu
          </button>
        </div>

      </form>
    </div>
  </div>

  <!-- Scripts -->
  <script src="/mixishop/js/plugins/bootstrap.bundle.min.js"></script>
  <script src="/mixishop/js/plugins/jquery.min.js"></script>
  <script src="/mixishop/js/theme.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ===== Province -> District -> Ward cascade =====
    (function ProvinceDistrictWard() {
      var provSel = document.getElementById('addrProvince');
      var distSel = document.getElementById('addrDistrict');
      var wardSel = document.getElementById('addrWard');

      var pCode = document.getElementById('provinceCode');
      var dCode = document.getElementById('districtCode');
      var wCode = document.getElementById('wardCode');

      var pName = document.getElementById('provinceName');
      var dName = document.getElementById('districtName');
      var wName = document.getElementById('wardName');

      if (!provSel) return;

      fetch('/mixishop/data/vn-divisions.json')
        .then(function (r) { return r.json(); })
        .then(function (provinces) {
          fillSelect(provSel, provinces, 'Chọn Tỉnh/Thành phố');

          provSel.addEventListener('change', function () {
            var p = provinces.find(function (x) { return x.code === provSel.value; });
            pCode.value = p && p.code ? p.code : '';
            pName.value = p && p.name ? p.name : '';

            var districts = (p && p.districts) ? p.districts : [];
            fillSelect(distSel, districts, 'Chọn Quận/Huyện');
            distSel.disabled = !districts.length;

            clearWard();

            if (p && p.center && window.__map) {
              window.__map.setView(p.center, 10);
            }
          });

          distSel.addEventListener('change', function () {
            var p = provinces.find(function (x) { return x.code === provSel.value; });
            var d = p && p.districts
              ? p.districts.find(function (x) { return x.code === distSel.value; })
              : null;

            dCode.value = d && d.code ? d.code : '';
            dName.value = d && d.name ? d.name : '';

            var wards = (d && d.wards) ? d.wards : [];
            fillSelect(wardSel, wards, 'Chọn Phường/Xã');
            wardSel.disabled = !wards.length;

            if (d && d.center && window.__map) {
              window.__map.setView(d.center, 12);
            }
          });

          wardSel.addEventListener('change', function () {
            var p = provinces.find(function (x) { return x.code === provSel.value; });
            var d = p && p.districts
              ? p.districts.find(function (x) { return x.code === distSel.value; })
              : null;
            var w = d && d.wards
              ? d.wards.find(function (x) { return x.code === wardSel.value; })
              : null;

            wCode.value = w && w.code ? w.code : '';
            wName.value = w && w.name ? w.name : '';

            if (w && w.center && window.__map) {
              window.__map.setView(w.center, 14);
            }
          });

          function clearWard() {
            wardSel.innerHTML = '<option value="">Chọn Phường/Xã</option>';
            wardSel.disabled = true;
            wCode.value = '';
            wName.value = '';
          }

          function fillSelect(select, arr, placeholder) {
            select.innerHTML = '<option value="">' + placeholder + '</option>';
            arr.forEach(function (it) {
              var opt = document.createElement('option');
              opt.value = it.code;
              opt.textContent = it.name;
              select.appendChild(opt);
            });
          }
        })
        .catch(function () {
          // ignore
        });
    })();

    // ===== Map Picker (Leaflet) + Reverse Geocode =====
    (function MapPicker() {
      var elMap = document.getElementById('mapPicker');
      var btnToggle = document.getElementById('btnToggleMap');
      if (!elMap || !btnToggle) return;

      var map, marker, isOpen = false;
      var latInp = document.getElementById('addrLat');
      var lngInp = document.getElementById('addrLng');
      var coordPreview = document.getElementById('coordPreview');
      var addrTextarea = document.getElementById('addrLine');
      var provName = document.getElementById('provinceName');
      var distName = document.getElementById('districtName');
      var wardName = document.getElementById('wardName');

      function ensureMap() {
        if (map) return;
        map = L.map('mapPicker', { zoomControl: true }).setView([21.0278, 105.8342], 12);
        window.__map = map;
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap',
          maxZoom: 19
        }).addTo(map);

        map.on('click', function (e) {
          var latlng = e.latlng;
          if (!marker) {
            marker = L.marker(latlng, { draggable: true }).addTo(map);
            marker.on('dragend', updateFromMarker);
          } else {
            marker.setLatLng(latlng);
          }
          updateLatLng(latlng.lat, latlng.lng);
        });
      }

      function updateLatLng(lat, lng) {
        if (latInp) latInp.value = lat;
        if (lngInp) lngInp.value = lng;
        if (coordPreview) coordPreview.textContent = '(' + lat.toFixed(6) + ', ' + lng.toFixed(6) + ')';
        reverseGeocode(lat, lng);
      }

      function updateFromMarker() {
        var p = marker.getLatLng();
        updateLatLng(p.lat, p.lng);
      }

      function reverseGeocode(lat, lng) {
        try {
          var url = 'https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=' + lat + '&lon=' + lng;
          fetch(url, { headers: { 'Accept-Language': 'vi' } })
            .then(function (res) { return res.json(); })
            .then(function (data) {
              if (!data || !data.display_name) return;
              var admin = [wardName.value, distName.value, provName.value]
                .filter(function (x) { return x; })
                .join(', ');

              var road = (data.address && (data.address.road || data.address.name)) || '';
              var house = data.address && data.address.house_number ? (' ' + data.address.house_number) : '';
              var suggestion = admin
                ? (road + house + (road || house ? ', ' : '') + admin).trim()
                : data.display_name;

              if (addrTextarea && (!addrTextarea.value || addrTextarea.value.trim().length < 6)) {
                addrTextarea.value = suggestion;
              }
            })
            .catch(function () { });
        } catch (e) { }
      }

      btnToggle.addEventListener('click', function () {
        isOpen = !isOpen;
        elMap.classList.toggle('expanded', isOpen);
        elMap.classList.toggle('collapsed', !isOpen);
        btnToggle.innerHTML = isOpen
          ? '<i class="bi bi-geo-alt me-1"></i> Ẩn bản đồ'
          : '<i class="bi bi-geo-alt me-1"></i> Chọn vị trí';

        if (isOpen) {
          setTimeout(function () {
            ensureMap();
            map.invalidateSize();
          }, 150);

          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (pos) {
              var latitude = pos.coords.latitude;
              var longitude = pos.coords.longitude;
              map.setView([latitude, longitude], 15);
            }, function () { });
          }
        }
      });
    })();

    // ===== GHÉP address_line trước khi submit (chi tiết + phường + quận + tỉnh) =====
    (function BindAddressSubmit() {
      var modal = document.getElementById('addrAddModal');
      if (!modal) return;
      var form = modal.querySelector('form');
      if (!form) return;

      form.addEventListener('submit', function () {
        var ward = document.getElementById('wardName').value || '';
        var dist = document.getElementById('districtName').value || '';
        var prov = document.getElementById('provinceName').value || '';
        var textarea = document.getElementById('addrLine');
        var detail = textarea && textarea.value ? textarea.value.trim() : '';

        var parts = [];
        if (detail) parts.push(detail);
        if (ward) parts.push(ward);
        if (dist) parts.push(dist);
        if (prov) parts.push(prov);

        if (textarea) {
          textarea.value = parts.join(', ');
        }
      });
    })();
  </script>

</body>
</html>
