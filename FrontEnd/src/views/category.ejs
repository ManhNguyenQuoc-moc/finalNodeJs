<!DOCTYPE html>
<!-- Mirrored from uomo-html.flexkitux.com/Demo3/shop3.html by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 19 Oct 2024 06:53:45 GMT -->
<style>
  /* === Search compact & longer (ghi đè) === */
  .toolbar-left {
    display: flex;
    align-items: center;
    gap: 12px;
    flex-wrap: nowrap
  }

  /* rộng hơn một chút: dài hơn, nhưng không tràn */
  .search-inline {
    width: clamp(360px, 45vw, 560px);
    /* dài vừa đủ, không bị quá khổ */
    max-width: 100%;
  }


  .is-disabled {
    opacity: 0.5;
    pointer-events: none;
  }


  /* viên thuốc thấp hơn, gọn hơn */
  .search-pill {
    border-radius: 999px;
    border: 1px solid #ddd;
    overflow: hidden;
    background: #fff;
  }

  .search-pill .input-group-text {
    padding: 4px 8px;
    font-size: 14px;
    color: #6c757d;
  }

  .search-pill .form-control {
    padding: 6px 10px;
    height: 34px;
    font-size: 14px;
    border: 0;
    box-shadow: none;
  }

  .search-pill .btn-primary {
    border-radius: 999px;
    padding: 0 16px;
    font-size: 14px;
    height: 34px;
    line-height: 34px;
  }

  .search-pill .btn-clear {
    border: 0;
    background: transparent;
    font-size: 18px;
    line-height: 1;
    padding: 0 8px;
    color: #8c8c8c
  }

  .search-pill .btn-clear:hover {
    color: #555
  }

  .breadcrumb {
    margin-bottom: 0
  }

  /* Responsive nhỏ */
  @media (max-width: 991.98px) {
    .toolbar-left {
      flex-wrap: wrap;
    }

    .search-inline {
      width: 100%;
    }
  }

  /* Clamp 5 dòng – có cả thuộc tính chuẩn và -webkit- */
  .line-clamp-5 {
    /* Chuẩn mới */
    line-clamp: 5;

    /* WebKit cũ (Chrome cũ, Safari) */
    display: -webkit-box;
    -webkit-line-clamp: 5;
    -webkit-box-orient: vertical;

    overflow: hidden;
    /* ẩn phần dư */
  }

  /* Sao đánh giá */
  .rating-stars .on {
    color: #ffc107;
  }

  .rating-stars .off {
    color: #c7c7c7;
  }

  .filter-section-title {
    font-size: 0.85rem;
    letter-spacing: 0.08em;
    color: #7c7c7c;
  }

  .category-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .category-pill {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border: 1px solid #f0f0f0;
    border-radius: 999px;
    text-decoration: none;
    color: #1a1a1a;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .category-pill:hover {
    border-color: #d0d0d0;
    box-shadow: 0 3px 10px rgba(0, 0, 0, 0.04);
  }

  .category-pill-active {
    border-color: #111;
    background: #111;
    color: #fff;
  }

  .category-thumb {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    overflow: hidden;
    flex-shrink: 0;
    background: #f5f5f5;
  }

  .category-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .brand-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
  }

  .brand-chip {
    position: relative;
    border-radius: 999px;
    border: 1px solid #e6e6e6;
    padding: 8px 14px;
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    background: #fff;
    cursor: pointer;
    transition: border-color 0.2s ease, color 0.2s ease, background 0.2s ease;
  }

  .brand-chip:hover {
    border-color: #bfbfbf;
  }

  .brand-chip input {
    position: absolute;
    opacity: 0;
    pointer-events: none;
  }

  .brand-chip .checkmark {
    display: none;
    font-size: 0.85rem;
  }

  .brand-chip-active {
    border-color: #111;
    background: #111;
    color: #fff;
  }

  .brand-chip-active .checkmark {
    display: inline;
  }

  .brand-name-truncate {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 90px;
  }

  .color-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 12px 10px;
  }

  .color-swatch {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    min-width: 72px;
  }

  .color-swatch .color-name {
    font-size: 12px;
    color: #111;
    text-align: center;
    line-height: 1.2;
    font-weight: 500;
  }

  .color-selected {
    min-height: 20px;
  }

  .visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0 0 0 0);
    white-space: nowrap;
    border: 0;
  }

  .color-swatch .swatch-color {
    display: inline-flex;
    width: 34px;
    height: 34px;
    border-radius: 50%;
    border: 2px solid transparent;
    box-shadow:
      inset 0 0 0 1px rgba(0, 0, 0, 0.2),
      0 2px 6px rgba(0, 0, 0, 0.08);
    transition: transform 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .color-swatch .swatch-color::after {
    content: "";
    flex: 1;
    border-radius: 50%;
    background: currentColor;
  }

  .color-swatch .swatch-color.swatch_active {
    border-color: #111;
    transform: scale(1.08);
    box-shadow:
      inset 0 0 0 1px rgba(255, 255, 255, 0.6),
      0 4px 12px rgba(0, 0, 0, 0.15);
  }
</style>

<%
  const safeProducts = Array.isArray(products?.content) ? products.content : [];
  const normalizeSlug = (text) => (text || "").toString().trim().toLowerCase();
  const brandOptions = (Array.isArray(brands) ? brands : [])
    .map((br) => {
      if (typeof br === "string") {
        return { name: br, slug: normalizeSlug(br) };
      }
      return {
        name: br?.name || "",
        slug: normalizeSlug(br?.slug || br?.name || br?._id || ""),
      };
    })
    .filter((item) => item.name && item.slug);
  const selectedBrandSet = new Set(
    String(brand || "")
      .split(",")
      .map((b) => normalizeSlug(b))
      .filter(Boolean)
  );
  const brandNameMap = new Map(brandOptions.map((opt) => [opt.slug, opt.name]));
  const brandSelectionText = selectedBrandSet.size
    ? Array.from(selectedBrandSet)
        .map((slug) => brandNameMap.get(slug) || slug)
        .join(", ")
    : "Tất cả";
  const namedColorMap = {
  "đen": "#000000",
  "black": "#000000",
  "trắng": "#ffffff",
  "white": "#ffffff",
  "xám": "#bdbdbd",
  "xám đậm": "#555555",
  "xám nhạt": "#dcdcdc",
  "nâu": "#8b4513",
  "nâu nhạt": "#c49a6c",
  "xanh dương": "#1757ff",
  "xanh dương nhạt": "#88b8ff",
  "xanh dương đậm": "#0a2a7a",
  "xanh lá": "#1f8b24",
  "xanh lá đậm": "#0a5221",
  "cam": "#ff7f11",
  "cam đậm": "#d35400",
  "đỏ": "#d7263d",
  "hồng": "#f889b6",
  "be": "#f8e3c4",
  "default": "#d9d9d9"
};
const resolveColorHex = (code, name) => {
  const normalized = (code || "").trim();
  if (/^#([0-9a-f]{3}){1,2}$/i.test(normalized)) return normalized;
  const fallback = namedColorMap[(name || "").toLowerCase()];
  return fallback || namedColorMap.default;
};
  const colorMap = new Map();
  safeProducts.forEach((product) => {
    (Array.isArray(product?.colors) ? product.colors : []).forEach((color) => {
      const key =
        color?.color_id?._id ||
        color?.color ||
        color?.color_code ||
        color?.color_id?.color_name;
      if (!key) return;
      const mapKey = String(key);
      const existing = colorMap.get(mapKey);
      const previewImage = (() => {
        const imgs = Array.isArray(color?.imageUrls) ? color.imageUrls.filter(Boolean) : [];
        if (imgs.length) return imgs[0];
        if (Array.isArray(product?.images) && product.images.length) {
          const firstImage = product.images[0];
          if (typeof firstImage === "string") return firstImage;
          return firstImage?.url || null;
        }
        return null;
      })();
      if (!existing) {
        colorMap.set(mapKey, {
          key: mapKey,
          name: color?.color || color?.color_id?.color_name || "Không rõ",
          code: resolveColorHex(color?.color_code, color?.color || color?.color_id?.color_name),
          preview: previewImage,
        });
      } else if (!existing.preview && previewImage) {
        existing.preview = previewImage;
      }
    });
  });
  const colorOptions = Array.from(colorMap.values());
  const colorFoldLimit = 10;
  const hasMoreColors = colorOptions.length > colorFoldLimit;
  const selectedColorKey = String(color || "");
  const currentColorLabel = (() => {
    if (!selectedColorKey) return "Tất cả";
    const found = colorOptions.find((opt) => String(opt.key) === selectedColorKey);
    return found?.name || "Tất cả";
  })();
  const initialSearch = (q || "").trim();
  const initialSort = sort || "";
  const defaultCategoryImage = "/mixishop/images/logo_mixishop.png";
  const buildFilterQuery = (overrides = {}) => {
    const params = new URLSearchParams();
    const baseEntries = {
      sort,
      price_range,
      brand,
      rating,
      color,
      q,
      pageNo: "1",
      ...overrides,
    };
    Object.entries(baseEntries).forEach(([key, value]) => {
      if (value === undefined || value === null) return;
      const text = String(value).trim();
      if (text) params.set(key, text);
    });
    return params.toString() ? `?${params.toString()}` : "";
  };
  const queryForLinks = (extra = {}) => buildFilterQuery(extra);
%>

<%- include('partials/head') %>

  <body data-category-view="category" data-page-size="8">
    <%- include('partials/header') %>

      <main>
        <section class="shop-main container d-flex pt-4 pt-xl-5">
          <div class="shop-sidebar side-sticky bg-body" id="shopFilter">
            <div class="aside-header d-flex d-lg-none align-items-center">
              <h3 class="text-uppercase fs-6 mb-0">Lọc theo</h3>
              <button class="btn-close-lg js-close-aside btn-close-aside ms-auto"></button>
            </div>

            <div class="pt-4 pt-lg-0"></div>

            <div class="accordion" id="categories-list">
              <div class="accordion-item mb-4 pb-3">
                <h5 class="accordion-header" id="accordion-heading-11">
                  <button class="accordion-button p-0 border-0 fs-5 text-uppercase" type="button"
                    data-bs-toggle="collapse" data-bs-target="#accordion-filter-1" aria-expanded="true"
                    aria-controls="accordion-filter-1">
                    Đồ Hiệu Mixi
                    <svg class="accordion-button__icon type2" viewBox="0 0 10 6" xmlns="http://www.w3.org/2000/svg">
                      <g aria-hidden="true" stroke="none" fill-rule="evenodd">
                        <path
                          d="M5.35668 0.159286C5.16235 -0.053094 4.83769 -0.0530941 4.64287 0.159286L0.147611 5.05963C-0.0492049 5.27473 -0.049205 5.62357 0.147611 5.83813C0.344427 6.05323 0.664108 6.05323 0.860924 5.83813L5 1.32706L9.13858 5.83867C9.33589 6.05378 9.65507 6.05378 9.85239 5.83867C10.0492 5.62357 10.0492 5.27473 9.85239 5.06018L5.35668 0.159286Z" />
                      </g>
                    </svg>
                  </button>
                </h5>
                <div id="accordion-filter-1" class="accordion-collapse collapse show border-0"
                  aria-labelledby="accordion-heading-11" data-bs-parent="#categories-list">
                  <div class="accordion-body px-0 pb-0 pt-3">
                    <div class="category-list">
                      <% const categoryAllHref = `/category/alls${queryForLinks()}`; %>
                      <a href="<%= categoryAllHref %>"
                        data-category-url="/category/alls"
                        class="category-pill js-category-link <%= (!selectedCategoryId || selectedCategoryId === 'alls') ? 'category-pill-active' : '' %>">
                        <span class="category-thumb">
                          <img src="<%= defaultCategoryImage %>" alt="Tất cả">
                        </span>
                        <span class="fw-medium">Tất cả</span>
                      </a>
                      <% categories.forEach(category=> {
                        const isActive = String(selectedCategoryId || '') === String(category._id);
                        const categoryHref = `/category/${category._id}${queryForLinks()}`;
                      %>
                        <a href="<%= categoryHref %>"
                          data-category-url="/category/<%= category._id %>"
                          class="category-pill js-category-link <%= isActive ? 'category-pill-active' : '' %>">
                          <span class="category-thumb">
                            <% if (category.image) { %>
                              <img src="<%= category.image %>" alt="<%= category.name %>" />
                            <% } else { %>
                              <img src="<%= defaultCategoryImage %>" alt="<%= category.name %>" />
                            <% } %>
                          </span>
                          <span class="fw-medium"><%= category.name %></span>
                        </a>
                      <% }) %>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="accordion" id="brand-filters">
              <div class="accordion-item mb-4 pb-3">
                <h5 class="accordion-header" id="accordion-heading-brand">
                  <button class="accordion-button p-0 border-0 fs-5 text-uppercase" type="button"
                    data-bs-toggle="collapse" data-bs-target="#accordion-filter-brand" aria-expanded="true"
                    aria-controls="accordion-filter-brand">
                    Thương hiệu
                    <svg class="accordion-button__icon type2" viewBox="0 0 10 6" xmlns="http://www.w3.org/2000/svg">
                      <g aria-hidden="true" stroke="none" fill-rule="evenodd">
                        <path
                          d="M5.35668 0.159286C5.16235 -0.053094 4.83769 -0.0530941 4.64287 0.159286L0.147611 5.05963C-0.0492049 5.27473 -0.049205 5.62357 0.147611 5.83813C0.344427 6.05323 0.664108 6.05323 0.860924 5.83813L5 1.32706L9.13858 5.83867C9.33589 6.05378 9.65507 6.05378 9.85239 5.83867C10.0492 5.62357 10.0492 5.27473 9.85239 5.06018L5.35668 0.159286Z" />
                      </g>
                    </svg>
                  </button>
                </h5>

                <div id="accordion-filter-brand" class="accordion-collapse collapse show border-0"
                  data-bs-parent="#brand-filters">
                  <div class="accordion-body px-0 pb-0">
                    <% if (!brandOptions.length) { %>
                      <span class="text-muted small">Chưa có thương hiệu</span>
                    <% } else { %>
                      <div class="brand-grid">
                        <button type="button"
                          class="brand-chip js-brand-clear <%= selectedBrandSet.size ? '' : 'brand-chip-active' %>">
                          <span class="brand-name-truncate">Tất cả</span>
                          <span class="checkmark">✓</span>
                        </button>
                        <% brandOptions.forEach((opt) => {
                          const isChecked = selectedBrandSet.has(opt.slug);
                        %>
                          <label class="brand-chip <%= isChecked ? 'brand-chip-active' : '' %>">
                            <input
                              type="checkbox"
                              class="js-brand"
                              value="<%= opt.slug %>"
                              data-label="<%= opt.name %>"
                              <%= isChecked ? "checked" : "" %>
                            />
                            <span class="brand-name-truncate"><%= opt.name %></span>
                            <span class="checkmark">✓</span>
                          </label>
                        <% }) %>
                      </div>
                      <div class="text-muted small mt-2" id="brandSelectionDisplay">
                        Đang chọn: <%= brandSelectionText %>
                      </div>
                    <% } %>
                  </div>
                </div>

              </div>
            </div>


            <div class="accordion" id="color-filters">
              <div class="accordion-item mb-4 pb-3">
                <h5 class="accordion-header" id="accordion-heading-1">
                  <button class="accordion-button p-0 border-0 fs-5 text-uppercase" type="button"
                    data-bs-toggle="collapse" data-bs-target="#accordion-filter-2" aria-expanded="true"
                    aria-controls="accordion-filter-2">
                    Màu sắc
                    <svg class="accordion-button__icon type2" viewBox="0 0 10 6" xmlns="http://www.w3.org/2000/svg">
                      <g aria-hidden="true" stroke="none" fill-rule="evenodd">
                        <path
                          d="M5.35668 0.159286C5.16235 -0.053094 4.83769 -0.0530941 4.64287 0.159286L0.147611 5.05963C-0.0492049 5.27473 -0.049205 5.62357 0.147611 5.83813C0.344427 6.05323 0.664108 6.05323 0.860924 5.83813L5 1.32706L9.13858 5.83867C9.33589 6.05378 9.65507 6.05378 9.85239 5.83867C10.0492 5.62357 10.0492 5.27473 9.85239 5.06018L5.35668 0.159286Z" />
                      </g>
                    </svg>
                  </button>
                </h5>
                <div id="accordion-filter-2" class="accordion-collapse collapse show border-0"
                  aria-labelledby="accordion-heading-1" data-bs-parent="#color-filters">
                  <div class="accordion-body px-0 pb-0">
                    <div class="color-grid" id="colorGrid" data-collapsed="<%= hasMoreColors ? 'true' : 'false' %>">
                      <% if (!colorOptions.length) { %>
                        <span class="text-muted small">Chưa có dữ liệu màu sắc.</span>
                      <% } else { %>
                        <label class="color-swatch text-center">
                          <input
                            type="radio"
                            name="colorFilter"
                            class="visually-hidden js-color-radio"
                            value=""
                            data-label="Tất cả"
                            <%= !selectedColorKey ? 'checked' : '' %>
                          />
                          <span class="swatch-color js-color-swatch <%= !selectedColorKey ? 'swatch_active' : '' %>"
                            data-color-code="#ffffff"
                            title="Tất cả"></span>
                          <div class="color-name">Tất cả</div>
                        </label>
                        <% colorOptions.forEach((opt, idx) => { %>
                          <label class="color-swatch text-center" <%= idx >= colorFoldLimit ? 'data-extra="true" style="display:none;"' : '' %>>
                            <input
                              type="radio"
                              name="colorFilter"
                              class="visually-hidden js-color-radio"
                              value="<%= opt.key %>"
                              data-label="<%= opt.name %>"
                              data-color-code="<%= opt.code || '#bdbdbd' %>"
                              <%= selectedColorKey === opt.key ? 'checked' : '' %>
                            />
                            <span
                              class="swatch-color js-color-swatch <%= selectedColorKey === opt.key ? 'swatch_active' : '' %>"
                              data-color-code="<%= opt.code || '#bdbdbd' %>"
                              title="<%= opt.name %>"
                            ></span>
                            <div class="color-name"><%= opt.name %></div>
                          </label>
                        <% }) %>
                      <% } %>
                    </div>
                    <div class="color-selected text-muted small mt-2" id="colorSelectionDisplay">
                      Đang chọn: <%= currentColorLabel %>
                    </div>
                    <div id="colorToggleWrapper">
                      <% if (hasMoreColors) { %>
                        <button type="button" class="btn btn-link px-0 small js-toggle-color-grid" id="toggleColorGrid">
                          Xem thêm màu
                        </button>
                      <% } %>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="accordion" id="rating-filters">
              <div class="accordion-item mb-4 pb-3">
                <h5 class="accordion-header" id="accordion-heading-rating">
                  <button class="accordion-button p-0 border-0 fs-5 text-uppercase" type="button"
                    data-bs-toggle="collapse" data-bs-target="#accordion-filter-rating" aria-expanded="true"
                    aria-controls="accordion-filter-rating">
                    Đánh giá
                    <svg class="accordion-button__icon type2" viewBox="0 0 10 6" xmlns="http://www.w3.org/2000/svg">
                      <g aria-hidden="true" stroke="none" fill-rule="evenodd">
                        <path
                          d="M5.35668 0.159286C5.16235 -0.053094 4.83769 -0.0530941 4.64287 0.159286L0.147611 5.05963C-0.0492049 5.27473 -0.049205 5.62357 0.147611 5.83813C0.344427 6.05323 0.664108 6.05323 0.860924 5.83813L5 1.32706L9.13858 5.83867C9.33589 6.05378 9.65507 6.05378 9.85239 5.83867C10.0492 5.62357 10.0492 5.27473 9.85239 5.06018L5.35668 0.159286Z" />
                      </g>
                    </svg>
                  </button>
                </h5>

                <div id="accordion-filter-rating" class="accordion-collapse collapse show border-0"
                  data-bs-parent="#rating-filters">
                  <ul class="list-unstyled mb-0">
                    <% const r=parseInt(rating || '0' , 10); %>
                      <% [5,4,3,2,1].forEach(st=> { %>
                        <li class="mb-2">
                          <label class="d-flex align-items-center gap-2">
                            <input type="radio" name="rating" class="form-check-input js-rating" value="<%= st %>"
                              <%=r===st ? 'checked' : '' %> >
                            <span>
                              <% for(let i=1;i<=5;i++){ %>
                                <span class="<%= i<=st ? 'text-warning' : 'text-muted' %>">★</span>
                                <% } %>
                                  <small class="text-muted">từ <%= st %> sao</small>
                            </span>
                          </label>
                        </li>
                        <% }) %>
                          <li><button class="btn btn-sm btn-outline-secondary mt-1" id="clearRating">Xóa đánh
                              giá</button></li>
                  </ul>
                </div>
              </div>
            </div>


            <div class="accordion" id="price-filters">
              <div class="accordion-item mb-4">
                <h5 class="accordion-header mb-2" id="accordion-heading-price">
                  <button class="accordion-button p-0 border-0 fs-5 text-uppercase" type="button"
                    data-bs-toggle="collapse" data-bs-target="#accordion-filter-price" aria-expanded="true"
                    aria-controls="accordion-filter-price">
                    Mức giá
                    <svg class="accordion-button__icon type2" viewBox="0 0 10 6">
                      <path
                        d="M5.35668 0.159286C5.16235 -0.053094 4.83769 -0.0530941 4.64287 0.159286L0.147611 5.05963C-0.0492049 5.27473-0.049205 5.62357 0.147611 5.83813C0.344427 6.05323 0.664108 6.05323 0.860924 5.83813L5 1.32706L9.13858 5.83867C9.33589 6.05378 9.65507 6.05378 9.85239 5.83867C10.0492 5.62357 10.0492 5.27473 9.85239 5.06018L5.35668 0.159286Z" />
                    </svg>
                  </button>
                </h5>

                <div id="accordion-filter-price" class="accordion-collapse collapse show border-0">
                  <!-- Ô nhập -->
                  <div class="d-flex align-items-center gap-2">
                    <input type="number" min="0" class="form-control" id="minPrice" placeholder="Từ"
                      value="<%= (price_range && price_range.split(',')[0]) || '' %>">
                    <span class="text-muted">—</span>
                    <input type="number" min="0" class="form-control" id="maxPrice" placeholder="Đến"
                      value="<%= (price_range && price_range.split(',')[1]) || '' %>">
                  </div>
                  <div class="d-flex gap-2 mt-2">
                    <button class="btn btn-sm btn-primary" id="applyPrice">Áp dụng</button>
                    <button class="btn btn-sm btn-outline-secondary" id="clearPrice">Xóa</button>
                  </div>

                  <!-- Quick range đổi thành checkbox -->
                  <ul class="mt-3 list-unstyled">
                    <li>
                      <label class="d-flex align-items-center gap-2">
                        <input type="checkbox" class="form-check-input js-quick-price" data-min="" data-max="">
                        <span>Tất cả</span>
                      </label>
                    </li>
                    <li>
                      <label class="d-flex align-items-center gap-2">
                        <input type="checkbox" class="form-check-input js-quick-price" data-min="0" data-max="100000">
                        <span>Dưới 1 trăm</span>
                      </label>
                    </li>
                    <li>
                      <label class="d-flex align-items-center gap-2">
                        <input type="checkbox" class="form-check-input js-quick-price" data-min="100000"
                          data-max="200000">
                        <span>1 trăm - 2 trăm</span>
                      </label>
                    </li>
                    <li>
                      <label class="d-flex align-items-center gap-2">
                        <input type="checkbox" class="form-check-input js-quick-price" data-min="200000"
                          data-max="500000">
                        <span>2 trăm - 5 trăm</span>
                      </label>
                    </li>
                    <li>
                      <label class="d-flex align-items-center gap-2">
                        <input type="checkbox" class="form-check-input js-quick-price" data-min="500000" data-max="">
                        <span>Trên 5 trăm</span>
                      </label>
                    </li>
                  </ul>
                </div>
              </div>

            </div>

          </div>

          <div class="shop-list flex-grow-1">
            <div class="swiper-container js-swiper-slider slideshow slideshow_small slideshow_split" data-settings='{
                "autoplay": {
                  "delay": 5000
                },
                "slidesPerView": 1,
                "effect": "fade",
                "loop": true,
                "pagination": {
                  "el": ".slideshow-pagination",
                  "type": "bullets",
                  "clickable": true
                }
              }'>
              <div class="swiper-wrapper">
                <div class="swiper-slide">
                  <div class="slide-split h-100 d-block d-md-flex overflow-hidden">
                    <div class="slide-split_text position-relative d-flex align-items-center"
                      style="background-color: #d9c8c7;">
                      <div class="slideshow-text container p-3 p-xl-5">
                        <h2
                          class="text-uppercase section-title fw-normal mb-3 animate animate_fade animate_btt animate_delay-2">
                          Women's <br><strong>ACCESSORIES</strong></h2>
                        <p class="mb-0 animate animate_fade animate_btt animate_delay-5">Accessories are the best way to
                          update your look. Add a title edge with new styles and new colors, or go for timeless pieces.
                        </p>
                      </div>
                    </div>
                    <div class="slide-split_media position-relative">
                      <div class="slideshow-bg" style="background-color: #d9c8c7;">
                        <img loading="lazy" src="/mixishop/images/shop/banner_list1.jpg" width="630" height="450"
                          alt="Women's accessories" class="slideshow-bg__img object-fit-cover">
                      </div>
                    </div>
                  </div>
                </div>
                <div class="swiper-slide">
                  <div class="slide-split h-100 d-block d-md-flex overflow-hidden">
                    <div class="slide-split_text position-relative d-flex align-items-center"
                      style="background-color: #aac6e0;">
                      <div class="slideshow-text container p-3 p-xl-5">
                        <h2
                          class="text-uppercase section-title fw-normal mb-3 animate animate_fade animate_btt animate_delay-2">
                          Choose <br><strong>Your Best Suits</strong></h2>
                        <p class="mb-0 animate animate_fade animate_btt animate_delay-5">Lorem ipsum dolor sit amet,
                          consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna
                          aliqua.</p>
                      </div>
                    </div>
                    <div class="slide-split_media position-relative">
                      <div class="slideshow-bg" style="background-color: #aac6e0;">
                        <img loading="lazy" src="/mixishop/images/shop/banner_list2.jpg" width="630" height="450"
                          alt="Women's accessories" class="slideshow-bg__img object-fit-cover">
                      </div>
                    </div>
                  </div>
                </div>
                <div class="swiper-slide">
                  <div class="slide-split h-100 d-block d-md-flex overflow-hidden">
                    <div class="slide-split_text position-relative d-flex align-items-center"
                      style="background-color: #d4d2d0;">
                      <div class="slideshow-text container p-3 p-xl-5">
                        <h2
                          class="text-uppercase section-title fw-normal mb-3 animate animate_fade animate_btt animate_delay-2">
                          World's <br><strong>Leading Quality</strong></h2>
                        <p class="mb-0 animate animate_fade animate_btt animate_delay-5">Lorem ipsum dolor sit amet,
                          consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna
                          aliqua.</p>
                      </div>
                    </div>
                    <div class="slide-split_media position-relative">
                      <div class="slideshow-bg" style="background-color: #d4d2d0;">
                        <img loading="lazy" src="/mixishop/images/shop/banner_list3.jpg" width="630" height="450"
                          alt="Women's accessories" class="slideshow-bg__img object-fit-cover">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="container p-3 p-xl-5">
                <div class="slideshow-pagination d-flex align-items-center position-absolute bottom-0 mb-4 pb-xl-2">
                </div>
              </div>
            </div>

            <div class="mb-3 pb-2 pb-xl-3"></div>

            <div class="d-flex justify-content-between mb-4 pb-md-2">
              <div class="toolbar-left">

                <!-- Breadcrumb -->
                <div class="breadcrumb mb-0 d-none d-md-flex align-items-center">
                  <a href="#" class="menu-link menu-link_us-s text-uppercase fw-medium">Danh mục</a>
                  <span class="breadcrumb-separator menu-link fw-medium ps-1 pe-1">/</span>
                  <a href="#" class="menu-link menu-link_us-s text-uppercase fw-medium">
                    <%= selectedCategoryName %>
                  </a>
                </div>

                <!-- Search nằm ngay sau breadcrumb -->
                <form class="search-inline js-search-form" autocomplete="off">
                  <div class="input-group search-pill">
                    <span class="input-group-text border-0 bg-transparent">
                      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M21 21l-4.2-4.2M10.8 18a7.2 7.2 0 1 1 0-14.4 7.2 7.2 0 0 1 0 14.4z"
                          stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                      </svg>
                    </span>
                    <input type="text" name="q" class="form-control border-0 js-search-input" placeholder="Tìm sản phẩm..."
                      value="<%= initialSearch %>" aria-label="Tìm sản phẩm" />
                    <% if (q && q.trim() !=='' ) { %>
                      <button class="btn btn-clear" type="button" id="btnClearKeyword" title="Xóa tìm kiếm">×</button>
                      <% } %>
                        <button class="btn btn-primary px-4" type="submit">Tìm</button>
                  </div>
                </form>
              </div>

              <form class="js-sort-form">
                <div
                  class="shop-acs d-flex align-items-center justify-content-between justify-content-md-end flex-grow-1">
                  <select class="shop-acs__select form-select w-auto border-0 py-0 order-1 order-md-0"
                    aria-label="Sắp xếp" name="sort" id="sortSelect">
                    <option <%=initialSort==='' ? 'selected' : '' %> value="">Mặc định</option>
                    <option <%=initialSort==='a_z' ? 'selected' : '' %> value="a_z">Tên A-Z</option>
                    <option <%=initialSort==='z_a' ? 'selected' : '' %> value="z_a">Tên Z-A</option>
                    <option <%=initialSort==='price_low_to_high' ? 'selected' : '' %> value="price_low_to_high">Giá tăng dần
                    </option>
                    <option <%=initialSort==='price_high_to_low' ? 'selected' : '' %> value="price_high_to_low">Giá giảm dần
                    </option>
                  </select>

                  <div class="shop-asc__seprator mx-3 bg-light d-none d-md-block order-md-0"></div>

                  <div class="col-size align-items-center order-1 d-none d-lg-flex">
                    <span class="text-uppercase fw-medium me-2"></span>
                    <button class="btn-link fw-medium me-2 js-cols-size" data-target="products-grid"
                      data-cols="2">2</button>
                    <button class="btn-link fw-medium me-2 js-cols-size" data-target="products-grid"
                      data-cols="3">3</button>
                    <button class="btn-link fw-medium js-cols-size" data-target="products-grid" data-cols="4">4</button>
                  </div>

                  <div class="shop-filter d-flex align-items-center order-0 order-md-3 d-lg-none">
                    <button class="btn-link btn-link_f d-flex align-items-center ps-0 js-open-aside"
                      data-aside="shopFilter">
                      <svg class="d-inline-block align-middle me-2" width="14" height="10" viewBox="0 0 14 10"
                        fill="none" xmlns="http://www.w3.org/2000/svg">
                        <use href="/images/sprite.svg#icon_filter" />
                      </svg>
                      <span class="text-uppercase fw-medium d-inline-block align-middle">Lọc</span>
                    </button>
                  </div>
                </div>
              </form>
            </div>



            <div class="products-grid row row-cols-2 row-cols-md-4 g-3" id="products-grid">
              <div class="col-12 text-center text-muted py-5" data-placeholder="true">
                Đang tải sản phẩm...
                          </div>
                    </div>

            <nav class="shop-pages d-flex justify-content-between mt-3" id="categoryPagination" aria-label="Phân trang">
              </nav>

          </div>
        </section>
      </main>

      <div class="mb-5 pb-xl-5"></div>

      <%- include('partials/footer') %>
        <%- include('partials/icons') %>
          <%- include('partials/login_form') %>
            <%- include('partials/cart_drawer') %>
              <%- include('partials/quick_view') %>
                <%- include('partials/sitemap') %>
                  <!-- Go To Top -->
                  <div id="scrollTop" class="visually-hidden end-0"></div>

                  <!-- Page Overlay -->
                  <div class="page-overlay"></div><!-- /.page-overlay -->


                  <!-- External JavaScripts -->
                  <script src="/mixishop/js/plugins/jquery.min.js"></script>
                  <script src="/mixishop/js/plugins/bootstrap.bundle.min.js"></script>
                  <script src="/mixishop/js/plugins/bootstrap-slider.min.js"></script>

                  <script src="/mixishop/js/plugins/swiper.min.js"></script>
                  <script src="/mixishop/js/plugins/countdown.js"></script>

                  <!-- Footer Scripts -->
                  <script src="/mixishop/js/theme.js"></script>

                  <script id="products-json" type="application/json">
                    <%- JSON.stringify(safeProducts) %>
                  </script>
                  <script id="color-meta-json" type="application/json">
                    <%- JSON.stringify({ foldLimit: colorFoldLimit, namedMap: namedColorMap }) %>
                  </script>

                  <script>
                    (() => {
                      const dataEl = document.getElementById('products-json');
                      if (!dataEl) return;
                      let products = [];
                      try {
                        products = JSON.parse(dataEl.textContent || '[]');
                      } catch (err) {
                        console.warn('Không thể parse dữ liệu sản phẩm:', err);
                        products = [];
                      }

                      const dom = {
                        grid: document.getElementById('products-grid'),
                        pagination: document.getElementById('categoryPagination'),
                        searchForm: document.querySelector('.js-search-form'),
                        searchInput: document.querySelector('.js-search-input'),
                        clearKeyword: document.getElementById('btnClearKeyword'),
                        sortSelect: document.getElementById('sortSelect'),
                        minPrice: document.getElementById('minPrice'),
                        maxPrice: document.getElementById('maxPrice'),
                        applyPrice: document.getElementById('applyPrice'),
                        clearPrice: document.getElementById('clearPrice'),
                        ratingRadios: Array.from(document.querySelectorAll('.js-rating')),
                        clearRating: document.getElementById('clearRating'),
                        brandCheckboxes: Array.from(document.querySelectorAll('.js-brand')),
                        brandClear: document.querySelector('.js-brand-clear'),
                        brandDisplay: document.getElementById('brandSelectionDisplay'),
                        categoryLinks: Array.from(document.querySelectorAll('.js-category-link')),
                        colorRadios: Array.from(document.querySelectorAll('.js-color-radio')),
                        colorSwatches: Array.from(document.querySelectorAll('.js-color-swatch')),
                        colorDisplay: document.getElementById('colorSelectionDisplay'),
                        colorToggle: document.getElementById('toggleColorGrid'),
                        colorToggleWrapper: document.getElementById('colorToggleWrapper'),
                        colorExtras: Array.from(document.querySelectorAll('.color-swatch[data-extra="true"]')),
                        colorGrid: document.getElementById('colorGrid'),
                        quickPriceBoxes: Array.from(document.querySelectorAll('.js-quick-price')),
                      };
                      const colorMetaEl = document.getElementById('color-meta-json');
                      let colorFoldLimitClient = 10;
                      let namedColorMapClient = {};
                      if (colorMetaEl) {
                        try {
                          const meta = JSON.parse(colorMetaEl.textContent || '{}');
                          if (meta && typeof meta === 'object') {
                            const parsedLimit = Number(meta.foldLimit);
                            if (Number.isFinite(parsedLimit) && parsedLimit > 0) {
                              colorFoldLimitClient = parsedLimit;
                            }
                            if (meta.namedMap && typeof meta.namedMap === 'object') {
                              namedColorMapClient = meta.namedMap;
                            }
                          }
                        } catch (err) {
                          console.warn('Không thể parse metadata màu:', err);
                        }
                      }

                      const applyStaticSwatchColors = () => {
                        (dom.colorSwatches || []).forEach((el) => {
                          const code = el.dataset.colorCode || '#bdbdbd';
                          const image = el.dataset.colorImage;
                          if (image) {
                            el.style.backgroundImage = `url('${image}')`;
                            el.style.backgroundSize = 'cover';
                            el.style.backgroundColor = '#f8f8f8';
                            el.style.borderColor = '#fff';
                          } else {
                            el.style.backgroundImage = 'none';
                            el.style.backgroundColor = code;
                            el.style.borderColor = code;
                          }
                          el.style.color = code;
                        });
                      };
                      const syncColorSwatchState = () => {
                        (dom.colorRadios || []).forEach((radio) => {
                          const swatch = radio.closest('.color-swatch')?.querySelector('.js-color-swatch');
                          if (swatch) swatch.classList.toggle('swatch_active', radio.checked);
                        });
                      };
                      const updateColorDisplay = () => {
                        if (!dom.colorDisplay) return;
                        if (!state.color) {
                          dom.colorDisplay.textContent = 'Đang chọn: Tất cả';
                          return;
                        }
                        const current = dom.colorRadios.find((radio) => radio.value === state.color);
                        const label = current?.dataset.label || state.color;
                        dom.colorDisplay.textContent = `Đang chọn: ${label}`;
                      };
                      const toggleExtraColors = (expand) => {
                        if (!dom.colorExtras?.length) return;
                        dom.colorExtras.forEach((item) => {
                          item.style.display = expand ? '' : 'none';
                        });
                        if (dom.colorToggle) {
                          dom.colorToggle.dataset.expanded = expand ? 'true' : 'false';
                          dom.colorToggle.textContent = expand ? 'Thu gọn' : 'Xem thêm màu';
                        }
                      };

                      const syncBrandChipState = () => {
                        (dom.brandCheckboxes || []).forEach((checkbox) => {
                          const chip = checkbox.closest('.brand-chip');
                          if (chip) chip.classList.toggle('brand-chip-active', checkbox.checked);
                        });
                        if (dom.brandClear) {
                          dom.brandClear.classList.toggle('brand-chip-active', state.brands.size === 0);
                        }
                      };

                      const updateBrandDisplay = () => {
                        if (!dom.brandDisplay) return;
                        if (!state.brands.size) {
                          dom.brandDisplay.textContent = 'Đang chọn: Tất cả';
                          return;
                        }
                        const labels = dom.brandCheckboxes
                          .filter((cb) => state.brands.has(cb.value))
                          .map((cb) => cb.dataset.label || cb.value);
                        dom.brandDisplay.textContent = `Đang chọn: ${labels.join(', ')}`;
                      };

                      const ensureColorVisibility = () => {
                        if (!dom.colorExtras?.length) return;
                        if (!state.color) {
                          toggleExtraColors(false);
                          return;
                        }
                        const match = dom.colorExtras.some((item) => {
                          const radio = item.querySelector('.js-color-radio');
                          return radio?.value === state.color;
                        });
                        toggleExtraColors(match);
                      };

                      applyStaticSwatchColors();
                      ensureColorVisibility();

                      const viewMode = document.body.dataset.categoryView || 'category';
                      const pageSize = Number(document.body.dataset.pageSize || 8);
                      let lastTotalPages = 1;

                      const normalize = (text = '') => text.toString().trim().toLowerCase();
                      const escapeHtml = (value = '') =>
                        value
                          .toString()
                          .replace(/[&<>"']/g, (char) => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[char] || char));
                      const formatCurrency = (val) =>
                        new Intl.NumberFormat('vi-VN').format(Math.max(0, Number(val) || 0)) + ' đ';
                      const getBrandSlug = (product) => normalize(product?.brand?.slug || product?.brand?.name || product?.brand?._id || '');
                      const getCategoryName = (product) =>
                        product?.category?.name || product?.category_id?.name || product?.category_name || '';
                      const getPriceNumber = (product) =>
                        Number(product?.price ?? product?.price_min ?? product?.price_max ?? product?.base_price ?? 0);
                      const getColorKeys = (product) =>
                        (Array.isArray(product?.colors) ? product.colors : []).map((color) =>
                          String(color?.color_id?._id || color?.color || color?.color_code || color?.color_id?.color_name || '')
                        );
                      const encodeImages = (imgs = []) => encodeURIComponent(JSON.stringify(imgs));
                      const getImages = (product) => {
                        const color = Array.isArray(product?.colors) && product.colors.length ? product.colors[0] : null;
                        const fallback = (product?.images?.[0]?.url) || '/images/default.png';
                        const first = color?.imageUrls?.[0] || fallback;
                        const second = color?.imageUrls?.[1] || color?.imageUrls?.[0] || product?.images?.[1]?.url || first;
                        return { first, second };
                      };
                      const getStatusFrame = (statusName = '') => {
                        if (statusName === 'Bán chạy') return '/mixishop/images/frame_banchay.png';
                        if (statusName === 'Trending') return '/mixishop/images/frame_trending.png';
                        return '/mixishop/images/frame_new.png';
                      };
                      const buildRatingStars = (avg) => {
                        const rounded = Math.round(Number(avg) || 0);
                        let stars = '';
                        for (let i = 1; i <= 5; i += 1) {
                          stars += `<span class="${i <= rounded ? 'on' : 'off'}">★</span>`;
                        }
                        return stars;
                      };

                      const urlParams = new URLSearchParams(window.location.search || '');
                      const initialPage = Math.max(1, Number(urlParams.get('pageNo') || '1'));

                      const state = {
                        page: initialPage,
                        search: dom.searchInput ? dom.searchInput.value.trim() : '',
                        sort: dom.sortSelect ? dom.sortSelect.value : '',
                        brands: new Set(dom.brandCheckboxes.filter((cb) => cb.checked).map((cb) => cb.value)),
                        color: dom.colorRadios.find((r) => r.checked)?.value || '',
                        rating: dom.ratingRadios.find((r) => r.checked)?.value || '',
                        minPrice: dom.minPrice?.value || '',
                        maxPrice: dom.maxPrice?.value || '',
                      };
                      const resolveColorHexClient = (code, name) => {
                        const normalized = (code || '').trim();
                        if (/^#([0-9a-f]{3}){1,2}$/i.test(normalized)) return normalized;
                        const fallback = namedColorMapClient[(name || '').toLowerCase()];
                        return fallback || namedColorMapClient.default || '#d9d9d9';
                      };
                      const buildColorOptionsFromProducts = (list) => {
                        const map = new Map();
                        list.forEach((product) => {
                          (Array.isArray(product?.colors) ? product.colors : []).forEach((color) => {
                            const key =
                              color?.color_id?._id ||
                              color?.color ||
                              color?.color_code ||
                              color?.color_id?.color_name;
                            if (!key) return;
                            const mapKey = String(key);
                            if (!map.has(mapKey)) {
                              map.set(mapKey, {
                                key: mapKey,
                                name: color?.color || color?.color_id?.color_name || 'Không rõ',
                                code: resolveColorHexClient(color?.color_code, color?.color || color?.color_id?.color_name),
                              });
                            }
                          });
                        });
                        return Array.from(map.values());
                      };
                      const buildColorGridHtml = (options) => {
                        const parts = [];
                        const selectedKey = state.color || '';
                        parts.push(`
                          <label class="color-swatch text-center">
                            <input
                              type="radio"
                              name="colorFilter"
                              class="visually-hidden js-color-radio"
                              value=""
                              data-label="Tất cả"
                              ${selectedKey ? '' : 'checked'}
                            />
                            <span class="swatch-color js-color-swatch ${selectedKey ? '' : 'swatch_active'}"
                              data-color-code="#ffffff"
                              title="Tất cả"></span>
                            <div class="color-name">Tất cả</div>
                          </label>
                        `);
                        options.forEach((opt, idx) => {
                          const key = String(opt.key);
                          const extraAttr = idx >= colorFoldLimitClient ? ' data-extra="true" style="display:none;"' : '';
                          const isSelected = selectedKey === key;
                          parts.push(`
                            <label class="color-swatch text-center"${extraAttr}>
                              <input
                                type="radio"
                                name="colorFilter"
                                class="visually-hidden js-color-radio"
                                value="${escapeHtml(key)}"
                                data-label="${escapeHtml(opt.name || '')}"
                                data-color-code="${escapeHtml(opt.code || '#d9d9d9')}"
                                ${isSelected ? 'checked' : ''}
                              />
                              <span
                                class="swatch-color js-color-swatch ${isSelected ? 'swatch_active' : ''}"
                                data-color-code="${escapeHtml(opt.code || '#d9d9d9')}"
                                title="${escapeHtml(opt.name || '')}"
                              ></span>
                              <div class="color-name">${escapeHtml(opt.name || '')}</div>
                            </label>
                          `);
                        });
                        return { html: parts.join(''), hasMore: options.length > colorFoldLimitClient };
                      };
                      const handleColorChange = (radio) => {
                        if (!radio?.checked) return;
                        state.color = radio.value;
                        syncColorSwatchState();
                        updateColorDisplay();
                        ensureColorVisibility();
                        state.page = 1;
                        renderProducts();
                      };
                      const bindColorRadioEvents = () => {
                        (dom.colorRadios || []).forEach((radio) => {
                          radio.addEventListener('change', () => handleColorChange(radio));
                        });
                      };
                      const refreshColorFilters = (productsForColor) => {
                        if (!dom.colorGrid) return;
                        const options = buildColorOptionsFromProducts(productsForColor);
                        if (!options.length) {
                          dom.colorGrid.innerHTML = '<span class="text-muted small">Không có màu phù hợp.</span>';
                          if (dom.colorToggleWrapper) dom.colorToggleWrapper.innerHTML = '';
                          state.color = '';
                          dom.colorRadios = [];
                          dom.colorSwatches = [];
                          dom.colorExtras = [];
                          dom.colorToggle = null;
                          updateColorDisplay();
                          return;
                        }
                        const keySet = new Set(options.map((opt) => String(opt.key)));
                        if (state.color && !keySet.has(state.color)) {
                          state.color = '';
                        }
                        const { html, hasMore } = buildColorGridHtml(options);
                        dom.colorGrid.innerHTML = html;
                        if (dom.colorToggleWrapper) {
                          dom.colorToggleWrapper.innerHTML = hasMore
                            ? '<button type="button" class="btn btn-link px-0 small js-toggle-color-grid" id="toggleColorGrid">Xem thêm màu</button>'
                            : '';
                        }
                        dom.colorRadios = Array.from(dom.colorGrid.querySelectorAll('.js-color-radio'));
                        dom.colorSwatches = Array.from(dom.colorGrid.querySelectorAll('.js-color-swatch'));
                        dom.colorExtras = Array.from(dom.colorGrid.querySelectorAll('.color-swatch[data-extra="true"]'));
                        dom.colorToggle = document.getElementById('toggleColorGrid');
                        applyStaticSwatchColors();
                        syncColorSwatchState();
                        updateColorDisplay();
                        bindColorRadioEvents();
                        if (dom.colorToggle && dom.colorExtras?.length) {
                          dom.colorToggle.addEventListener('click', () => {
                            const expanded = dom.colorToggle.dataset.expanded === 'true';
                            toggleExtraColors(!expanded);
                          });
                        }
                        ensureColorVisibility();
                      };

                      const getProductsForColorFilters = () => {
                        if (!state.brands.size) return products;
                        return products.filter((product) => state.brands.has(getBrandSlug(product)));
                      };

                      const refreshColorsForBrandSelection = () => {
                        refreshColorFilters(getProductsForColorFilters());
                      };

                      const buildSearchFromState = (overrides = {}) => {
                        const params = new URLSearchParams();
                        const entries = {
                          q: state.search,
                          sort: state.sort,
                          color: state.color,
                          rating: state.rating,
                          price_range:
                            (state.minPrice || state.maxPrice)
                              ? `${state.minPrice || ''},${state.maxPrice || ''}`
                              : '',
                          brand: state.brands.size ? Array.from(state.brands).join(',') : '',
                          ...overrides,
                        };
                        Object.entries(entries).forEach(([key, value]) => {
                          if (value === undefined || value === null) return;
                          const text = String(value).trim();
                          if (text) params.set(key, text);
                        });
                        return params.toString();
                      };

                      const syncUrlWithState = () => {
                        const query = buildSearchFromState({ pageNo: state.page });
                        const newUrl = query ? `${window.location.pathname}?${query}` : window.location.pathname;
                        window.history.replaceState({}, '', newUrl);
                      };

                      const navigateWithState = (basePath) => {
                        const query = buildSearchFromState({ pageNo: '1' });
                        window.location.href = query ? `${basePath}?${query}` : basePath;
                      };

                      const applyFilters = () =>
                        products.filter((product) => {
                          if (state.brands.size && !state.brands.has(getBrandSlug(product))) return false;
                          if (state.color) {
                            const keys = getColorKeys(product);
                            if (!keys.includes(state.color)) return false;
                          }
                          const price = getPriceNumber(product);
                          if (state.minPrice && price < Number(state.minPrice)) return false;
                          if (state.maxPrice && price > Number(state.maxPrice)) return false;
                          if (state.search) {
                            const haystack = [
                              product?.name,
                              product?.short_description,
                              product?.long_description,
                              product?.brand?.name,
                              getCategoryName(product),
                            ]
                              .filter(Boolean)
                              .join(' ')
                              .toLowerCase();
                            if (!haystack.includes(state.search.toLowerCase())) return false;
                          }
                          if (state.rating && Number(product?.avg_rating || 0) < Number(state.rating)) return false;
                          return true;
                        });

                      const sortProducts = (list) => {
                        const sorted = [...list];
                        switch (state.sort) {
                          case 'a_z':
                            sorted.sort((a, b) => a.name.localeCompare(b.name));
                            break;
                          case 'z_a':
                            sorted.sort((a, b) => b.name.localeCompare(a.name));
                            break;
                          case 'price_low_to_high':
                            sorted.sort((a, b) => getPriceNumber(a) - getPriceNumber(b));
                            break;
                          case 'price_high_to_low':
                            sorted.sort((a, b) => getPriceNumber(b) - getPriceNumber(a));
                            break;
                          default:
                            break;
                        }
                        return sorted;
                      };

                      const buildSwatches = (product) => {
                        const colors = (Array.isArray(product?.colors) ? product.colors : []).slice(0, 6);
                        if (!colors.length) return '';
                        return `
                          <div class="d-flex align-items-center mt-1 custom-swatch-container">
                            ${colors
                              .map((color, index) => {
                                const imgs = (Array.isArray(color?.imageUrls) ? color.imageUrls : []).filter(Boolean);
                                const preview = encodeURI(imgs[0] || '/images/default.png');
                                return `<a href="#"
                                  class="swatch-color custom-swatch-color ${index === 0 ? 'swatch_active' : ''}"
                                  data-action="swap-color"
                                  data-images="${encodeImages(imgs)}"
                                  style="background-image:url('${preview}');background-size:cover;"
                                  title="${escapeHtml(color?.color || color?.color_id?.color_name || 'Màu sắc')}"></a>`;
                              })
                              .join('')}
                          </div>
                        `;
                      };

                      const buildCard = (product) => {
                        const { first, second } = getImages(product);
                        const priceText = formatCurrency(getPriceNumber(product));
                        const categoryName = escapeHtml(getCategoryName(product));
                        const brandName = escapeHtml(product?.brand?.name || '');
                        const statusFrame = getStatusFrame(product?.productStatus?.statusName);
                        const description = escapeHtml(product?.short_description || '');
                        const ratingStars = buildRatingStars(product?.avg_rating);
                        const ratingCount = Number(product?.rating_count || 0);
                        const detailUrl = `/product_detail/${product?._id || product?.id || ''}`;
                        const wishlistBtn = `
                          <button class="pc__btn-wl position-absolute top-0 end-0 bg-transparent border-0 js-add-wishlist" title="Thêm vào danh sách yêu thích">
                            <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <use href="/images/sprite.svg#icon_heart"></use>
                            </svg>
                          </button>
                        `;

                        const baseInfo = `
                          <div class="pc__info position-relative">
                            <p class="pc__category">${categoryName}</p>
                            <h6 class="pc__title">
                              <a href="${detailUrl}">
                                ${escapeHtml(product?.name || 'Sản phẩm')}
                              </a>
                            </h6>
                            <p class="small text-muted mb-1 line-clamp-5">${description}</p>
                            <div class="rating-stars d-flex align-items-center mb-2">
                              ${ratingStars}
                              <small class="ms-2 text-muted">(${ratingCount} đánh giá)</small>
                            </div>
                            <div class="product-card__price d-flex">
                              <span class="money price text-primary">${priceText}</span>
                            </div>
                            ${brandName ? `<div class="small text-muted">Thương hiệu: <strong>${brandName}</strong></div>` : ''}
                            ${wishlistBtn}
                          </div>
                        `;

                        if (viewMode === 'collections') {
                          return `
                            <div class="product-card-wrapper" data-brand="${getBrandSlug(product)}">
                              <div class="product-card mb-3 mb-md-4 mb-xxl-5">
                                <div class="pc__img-wrapper">
                                  <a href="${detailUrl}">
                                    <img loading="lazy" src="${first}" width="258" height="313" alt="${escapeHtml(product?.name || '')}" class="pc__img">
                                    <img loading="lazy" src="${second}" width="258" height="313" alt="${escapeHtml(product?.name || '')}" class="pc__img pc__img-second">
                                    <img class="category-banner__frame" src="${statusFrame}" alt="Trạng thái">
                                  </a>
                                </div>
                                ${buildSwatches(product)}
                                ${baseInfo}
                              </div>
                            </div>
                          `;
                        }

                        return `
                          <div class="product-card-wrapper" data-brand="${getBrandSlug(product)}">
                            <div class="product-card mb-3 mb-md-4 mb-xxl-5">
                              <div class="pc__img-wrapper">
                                <div class="swiper-container background-img js-swiper-slider" data-settings='{"resizeObserver": true}'>
                                  <div class="swiper-wrapper">
                                    <div class="swiper-slide">
                                      <a href="${detailUrl}">
                                        <img loading="lazy" src="${first}" width="258" height="313" alt="${escapeHtml(product?.name || '')}" class="pc__img">
                                        <img loading="lazy" src="${second}" width="258" height="313" alt="${escapeHtml(product?.name || '')}" class="pc__img pc__img-second">
                                        <img class="category-banner__frame" src="${statusFrame}" alt="Trạng thái">
                                      </a>
                                    </div>
                                  </div>
                                </div>
                                <a href="${detailUrl}" class="pc__atc btn anim_appear-bottom position-absolute border-0 fw-medium" title="Xem chi tiết">
                                  Xem chi tiết
                                </a>
                              </div>
                              ${buildSwatches(product)}
                              ${baseInfo}
                            </div>
                          </div>
                        `;
                      };

                      const renderPagination = (totalPages) => {
                        if (!dom.pagination) return;
                        lastTotalPages = totalPages;
                        dom.pagination.dataset.totalPages = totalPages;
                        dom.pagination.dataset.totalItems = totalPages ? totalPages * pageSize : 0;
                        if (totalPages <= 1) {
                          dom.pagination.innerHTML = '';
                          return;
                        }
                        const maxButtons = 5;
                        let start = Math.max(1, state.page - Math.floor(maxButtons / 2));
                        let end = Math.min(totalPages, start + maxButtons - 1);
                        if (end - start < maxButtons - 1) {
                          start = Math.max(1, end - maxButtons + 1);
                        }
                        const pages = [];
                        for (let i = start; i <= end; i += 1) {
                          pages.push(`
                            <li class="page-item">
                              <button class="btn-link px-1 mx-1 ${i === state.page ? 'btn-link_active' : ''}" data-page="${i}">
                                ${i}
                              </button>
                            </li>
                          `);
                        }
                        dom.pagination.innerHTML = `
                          <button class="btn-link d-inline-flex align-items-center ${state.page === 1 ? 'is-disabled' : ''}"
                            data-page="${state.page - 1}" ${state.page === 1 ? 'disabled' : ''}>
                            <svg class="me-1" width="7" height="11" viewBox="0 0 7 11" xmlns="http://www.w3.org/2000/svg">
                              <use href="/images/sprite.svg#icon_prev_sm"></use>
                            </svg>
                            <span class="fw-medium">TRƯỚC</span>
                          </button>
                          <ul class="pagination mb-0 d-flex align-items-center">
                            ${pages.join('')}
                          </ul>
                          <button class="btn-link d-inline-flex align-items-center ${state.page === totalPages ? 'is-disabled' : ''}"
                            data-page="${state.page + 1}" ${state.page === totalPages ? 'disabled' : ''}>
                            <span class="fw-medium me-1">TIẾP</span>
                            <svg width="7" height="11" viewBox="0 0 7 11" xmlns="http://www.w3.org/2000/svg">
                              <use href="/images/sprite.svg#icon_next_sm"></use>
                            </svg>
                          </button>
                        `;
                      };

                      const renderProducts = () => {
                        if (!dom.grid) return;
                        const filtered = sortProducts(applyFilters());
                        const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
                        state.page = Math.min(state.page, totalPages);
                        const start = (state.page - 1) * pageSize;
                        const slice = filtered.slice(start, start + pageSize);
                        if (!slice.length) {
                          dom.grid.innerHTML = `
                            <div class="col-12 text-center text-muted py-5">
                              Không tìm thấy sản phẩm phù hợp.
                            </div>
                          `;
                        } else {
                          dom.grid.innerHTML = slice.map((item) => buildCard(item)).join('');
                        }
                        renderPagination(totalPages);
                        syncUrlWithState();
                      };

                      // EVENT BINDINGS
                      dom.grid?.addEventListener('click', (event) => {
                        const swatch = event.target.closest('[data-action="swap-color"]');
                        if (!swatch) return;
                        event.preventDefault();
                        let images = [];
                        try {
                          images = JSON.parse(decodeURIComponent(swatch.dataset.images || '%5B%5D'));
                        } catch {
                          images = [];
                        }
                        const card = swatch.closest('.product-card');
                        if (!card) return;
                        const primary = card.querySelector('.pc__img');
                        const secondary = card.querySelector('.pc__img-second');
                        if (primary && images[0]) primary.src = images[0];
                        if (secondary) secondary.src = images[1] || images[0] || secondary.src;
                        swatch
                          .closest('.custom-swatch-container')
                          ?.querySelectorAll('[data-action="swap-color"]')
                          .forEach((node) => node.classList.remove('swatch_active'));
                        swatch.classList.add('swatch_active');
                      });

                      dom.pagination?.addEventListener('click', (event) => {
                        const btn = event.target.closest('[data-page]');
                        if (!btn) return;
                        const targetPage = Number(btn.dataset.page);
                        if (!Number.isFinite(targetPage) || targetPage < 1 || targetPage > lastTotalPages) return;
                        event.preventDefault();
                        state.page = targetPage;
                        renderProducts();
                      });

                      dom.searchForm?.addEventListener('submit', (event) => {
                        event.preventDefault();
                        state.search = dom.searchInput ? dom.searchInput.value.trim() : '';
                        state.page = 1;
                        renderProducts();
                      });
                      dom.clearKeyword?.addEventListener('click', () => {
                        if (dom.searchInput) dom.searchInput.value = '';
                        state.search = '';
                        state.page = 1;
                        renderProducts();
                      });
                      dom.searchInput?.addEventListener('input', () => {
                        const value = dom.searchInput.value.trim();
                        const nextSearch = value;
                        if (state.search === nextSearch) return;
                        state.search = nextSearch;
                        state.page = 1;
                        renderProducts();
                      });

                      dom.sortSelect?.addEventListener('change', () => {
                        state.sort = dom.sortSelect.value;
                        state.page = 1;
                        renderProducts();
                      });

                      dom.brandCheckboxes.forEach((checkbox) => {
                        checkbox.addEventListener('change', () => {
                          if (checkbox.checked) state.brands.add(checkbox.value);
                          else state.brands.delete(checkbox.value);
                          syncBrandChipState();
                          updateBrandDisplay();
                          refreshColorsForBrandSelection();
                          state.page = 1;
                          renderProducts();
                        });
                      });

                      dom.brandClear?.addEventListener('click', () => {
                        if (!state.brands.size) return;
                        dom.brandCheckboxes.forEach((checkbox) => {
                          checkbox.checked = false;
                        });
                        state.brands.clear();
                        syncBrandChipState();
                        updateBrandDisplay();
                        refreshColorsForBrandSelection();
                        state.page = 1;
                        renderProducts();
                      });

                      syncBrandChipState();
                      updateBrandDisplay();
                      refreshColorsForBrandSelection();

                      dom.categoryLinks.forEach((link) => {
                        link.addEventListener('click', (event) => {
                          event.preventDefault();
                          const basePath = link.dataset.categoryUrl || link.getAttribute('href');
                          if (!basePath) return;
                          navigateWithState(basePath);
                        });
                      });

                      syncColorSwatchState();
                      updateColorDisplay();

                      dom.ratingRadios.forEach((radio) => {
                        radio.addEventListener('change', () => {
                          state.rating = radio.checked ? radio.value : '';
                          state.page = 1;
                          renderProducts();
                        });
                      });
                      dom.clearRating?.addEventListener('click', (event) => {
                        event.preventDefault();
                        state.rating = '';
                        dom.ratingRadios.forEach((radio) => {
                          radio.checked = false;
                        });
                        state.page = 1;
                        renderProducts();
                      });

                      const syncQuickPrice = () => {
                        dom.quickPriceBoxes.forEach((box) => {
                          const min = box.dataset.min || '';
                          const max = box.dataset.max || '';
                          box.checked =
                            state.minPrice === min &&
                            state.maxPrice === max &&
                            (min !== '' || max !== '');
                          if (!state.minPrice && !state.maxPrice && min === '' && max === '') {
                            box.checked = true;
                          }
                        });
                      };

                      dom.quickPriceBoxes.forEach((box) => {
                        box.addEventListener('change', () => {
                          if (!box.checked) return;
                          dom.quickPriceBoxes.forEach((other) => {
                            if (other !== box) other.checked = false;
                          });
                          state.minPrice = box.dataset.min || '';
                          state.maxPrice = box.dataset.max || '';
                          if (dom.minPrice) dom.minPrice.value = state.minPrice;
                          if (dom.maxPrice) dom.maxPrice.value = state.maxPrice;
                          state.page = 1;
                          renderProducts();
                        });
                      });

                      dom.applyPrice?.addEventListener('click', () => {
                        state.minPrice = dom.minPrice?.value || '';
                        state.maxPrice = dom.maxPrice?.value || '';
                        dom.quickPriceBoxes.forEach((box) => (box.checked = false));
                        syncQuickPrice();
                        state.page = 1;
                        renderProducts();
                      });
                      dom.clearPrice?.addEventListener('click', () => {
                        if (dom.minPrice) dom.minPrice.value = '';
                        if (dom.maxPrice) dom.maxPrice.value = '';
                        state.minPrice = '';
                        state.maxPrice = '';
                        dom.quickPriceBoxes.forEach((box) => {
                          const isAll = !box.dataset.min && !box.dataset.max;
                          box.checked = isAll;
                        });
                        state.page = 1;
                        renderProducts();
                      });

                      syncQuickPrice();
                      renderProducts();
                    })();
                  </script>


  </body>

  <!-- Mirrored from uomo-html.flexkitux.com/Demo3/shop3.html by HTTrack Website Copier/3.x [XR&CO'2014], Sat, 19 Oct 2024 06:53:45 GMT -->

  </html>