<!-- views/partials/cart_drawer.ejs -->
<style>
  /* ===== Cart Drawer (scoped by #cartDrawer) ===== */
  #cartDrawer {
    max-width: 440px;
    background: #fff;
    border-left: 1px solid #eef2f7;
    box-shadow: -8px 0 24px rgba(16,24,40,.08);
  }
  #cartDrawer .aside-header {
    position: sticky; top: 0; z-index: 2;
    padding: 14px 16px; background: #fff;
    border-bottom: 1px solid #eef2f7;
  }
  #cartDrawer .cdr-badge {
    display:inline-flex; align-items:center; justify-content:center;
    min-width: 22px; height: 22px; padding: 0 6px;
    font-size: 12px; font-weight: 700; color: #fff;
    background: #111827; border-radius: 999px;
  }
  #cartDrawer .cart-drawer-items {
    padding: 12px 16px 188px; /* ch·ª´a ch·ªó cho footer */
    overflow: auto;
  }
  #cartDrawer .empty {
    text-align:center; color:#6b7280; padding: 32px 12px;
    border:1px dashed #e5e7eb; border-radius: 12px; background:#fafafa;
  }

  /* Item */
  .cdi { display:flex; gap:12px; padding:12px; border:1px solid #eef2f7;
         border-radius: 14px; background:#fff; box-shadow: 0 1px 2px rgba(16,24,40,.04); }
  .cdi + .cdi { margin-top:12px; }
  .cdi-thumb { width:72px; height:72px; flex:0 0 72px; border-radius: 12px;
               overflow:hidden; background:#f9fafb; border:1px solid #eef2f7; }
  .cdi-thumb img { width:100%; height:100%; object-fit:cover; display:block; }

  .cdi-ttl { margin:0 0 4px 0; line-height:1.35; font-size:14px; font-weight:700; color:#111827; }
  .cdi-ttl a { color:inherit; text-decoration:none; }
  .cdi-ttl a:hover { text-decoration:underline; }

  .cdi-meta { display:flex; flex-wrap:wrap; gap:6px 12px; font-size:12px; color:#6b7280; }
  .cdi-meta b { color:#111827; font-weight:700; }

  /* H√†ng ƒëi·ªÅu khi·ªÉn s·ªë l∆∞·ª£ng + ƒë∆°n gi√° (ƒë∆°n gi√° ƒë·∫∑t b√™n ph·∫£i qty) */
  .cdi-row { margin-top:10px; display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
  .cdi-qty { display:flex; align-items:center; border:1px solid #e5e7eb; border-radius: 10px; overflow:hidden; }
  .cdi-qty button { width:36px; height:36px; border:0; background:#fafafa; cursor:pointer; }
  .cdi-qty input { width:58px; height:36px; border:0; text-align:center; outline:none; }
  .cdi-unit { margin-left:auto; font-size:12px; color:#6b7280; white-space:nowrap; }

  /* === T·ªïng gi√° (ƒë·∫πp h∆°n) === */
  .cdi-total {
    margin-top: 10px;
    padding: 10px 12px;
    background: #f9fafb;
    border: 1px solid #eef2f7;
    border-radius: 12px;
    display: flex; align-items: center; justify-content: space-between; gap: 12px;
    box-shadow: 0 1px 2px rgba(16,24,40,.04);
  }
  .cdi-total .label { font-size:12px; color:#6b7280; letter-spacing:.2px; }
  .cdi-total .price { font-size:18px; line-height:1.1; font-weight:800; color:#111827; }

  .cdi-remove {
    position:absolute; top:8px; right:8px; width:28px; height:28px;
    display:inline-flex; align-items:center; justify-content:center;
    border-radius:8px; border:1px solid #e5e7eb; background:#fff; cursor:pointer;
  }
  .cdi-remove:hover { background:#f9fafb; }

  /* Footer */
  .cdr-footer {
    background:#fff; border-top:1px solid #eef2f7;
    padding: 14px 16px 16px; box-shadow: 0 -6px 16px rgba(16,24,40,.06);
  }
  .cdr-coupon { display:flex; gap:8px; margin-bottom:10px; }
  .cdr-coupon input {
    flex:1; height:42px; border-radius: 10px; border:1px solid #e5e7eb; padding:0 12px;
  }
  .cdr-coupon .btn-apply {
    height:42px; border-radius: 10px; font-weight:700; padding:0 14px;
    background:#111827; color:#fff; border:1px solid #111827;
  }
  .cdr-row { display:flex; align-items:center; justify-content:space-between; font-weight:700; color:#111827; }
  .cdr-actions .btn { height:44px; border-radius:12px; font-weight:700; width:100%; }
  .cdr-actions .btn-outline { background:#f3f4f6; border-color:#e5e7eb; color:#111827; }
  .cdr-actions .btn-primary { background:#111827; border-color:#111827; color:#fff; }
  .cdr-actions .btn + .btn { margin-top:8px; }
  @media (max-width: 480px){
    #cartDrawer { max-width: 100vw; }
    #cartDrawer .cart-drawer-items { padding-bottom: 210px; }
    .cdi-total { padding:8px 10px; }
    .cdi-total .price { font-size:16px; }
  }

  /* === ONLY ADD: ƒë·∫£m b·∫£o v√πng items cu·ªôn ƒë∆∞·ª£c theo chi·ªÅu cao m√†n h√¨nh ===
     Kh√¥ng ch·ªânh s·ª≠a rule c≈© n√†o; ch·ªâ b·ªï sung max-height cho .cart-drawer-items */
  #cartDrawer .cart-drawer-items{
    /* 56px ~ chi·ªÅu cao header, 188px ~ kho·∫£ng ch·ª´a footer b·∫°n ƒëang d√πng */
    max-height: calc(100vh - 56px - 188px);
  }

  /* Tu·ª≥ ch·ªçn: scrollbar g·ªçn g√†ng h∆°n cho v√πng items (c≈©ng ch·ªâ √°p v√†o items) */
  #cartDrawer .cart-drawer-items::-webkit-scrollbar{ width:8px; }
  #cartDrawer .cart-drawer-items::-webkit-scrollbar-thumb{
    background:#e5e7eb; border-radius:999px;
  }
</style>

<%
  // ===== Normalize cart lines for drawer (support both middleware & getRenderData shapes) =====
  const raw = (typeof carts !== 'undefined' && Array.isArray(carts)) ? carts : [];
  const normalized = raw.map((c, idx) => {
    const fromA = c && c.productColor && c.productColor.product;

    const idIdx   = (typeof c.id !== 'undefined') ? c.id : idx;
    const pid     = fromA ? (c.productColor.product.id || c.productColor.product._id) : (c.productId || c.product_id || '');
    const name    = fromA ? (c.productColor.product.name) : (c.productName || c.name_snapshot || 'S·∫£n ph·∫©m');
    const brand   = c.brand_name_snapshot || c.brand || '';
    const typ     = c.category_name_snapshot || c.type || '';
    const color   = fromA ? (c.productColor.color || '‚Äî') : (c.color_name_snapshot || '‚Äî');
    const size    = fromA ? ((c.productSize && (c.productSize.size || c.productSize.name)) || '‚Äî') : (c.size_name_snapshot || '‚Äî');
    const img     = fromA ? ((c.productColor.imageUrls && c.productColor.imageUrls[0]) || '/images/default.png')
                          : (c.img_snapshot || '/images/default.png');
    const qty     = Number(c.quantity || c.qty || 1);
    const unit    = Number(fromA ? (c.productColor.product.price) : (c.unitPrice || c.price_at_time || 0));
    const line    = unit * qty;

    return {
      idx: idIdx,
      pid, name, brand, typ, color, size, qty, unit, line,
      img,
      url: pid ? `/product_detail/${pid}` : '#'
    };
  });

  const drawerCount = normalized.length;
  const drawerTotal = normalized.reduce((s, it)=> s + it.line, 0);
  function vnd(n){ try { return Number(n||0).toLocaleString('vi-VN') + 'ƒë'; } catch(e){ return (n||0)+'ƒë'; } }
%>

<div class="aside aside_right overflow-hidden cart-drawer" id="cartDrawer" role="dialog" aria-label="Gi·ªè h√†ng">
  <!-- Header -->
  <div class="aside-header d-flex align-items-center">
    <h3 class="text-uppercase fs-6 mb-0 d-flex align-items-center gap-2">
      <svg class="me-1" width="20" height="20" aria-hidden="true">
        <use href="/images/sprite.svg#icon_cart"></use>
      </svg>
      GI·ªé H√ÄNG
      <span class="cdr-badge js-cart-items-count"><%= drawerCount %></span>
    </h3>
    <button class="btn-close-lg js-close-aside btn-close-aside ms-auto" aria-label="ƒê√≥ng gi·ªè h√†ng"></button>
  </div>

  <!-- Items -->
  <div class="cart-drawer-items">
    <% if (!drawerCount) { %>
      <div class="empty">
        <div class="mb-2" style="font-size:40px; line-height:1;">üõçÔ∏è</div>
        <div class="fw-semibold mb-1">Gi·ªè h√†ng tr·ªëng</div>
        <div class="small">Ti·∫øp t·ª•c mua s·∫Øm ƒë·ªÉ t√¨m m√≥n b·∫°n th√≠ch nh√©!</div>
      </div>
    <% } %>

    <% normalized.forEach(function(it){ %>
      <div class="cdi position-relative" id="cdr-item-<%= it.idx %>">
        <a class="cdi-thumb" href="<%= it.url %>" aria-label="<%= it.name %>">
          <img loading="lazy" src="<%= it.img %>" alt="<%= it.name %>">
        </a>

        <div class="flex-grow-1">
          <h6 class="cdi-ttl"><a href="<%= it.url %>"><%= it.name %></a></h6>

          <div class="cdi-meta">
            <% if (it.brand) { %><span>Th∆∞∆°ng hi·ªáu: <b><%= it.brand %></b></span><% } %>
            <% if (it.typ)   { %><span>Lo·∫°i: <b><%= it.typ %></b></span><% } %>
            <span>M√†u: <b><%= it.color %></b></span>
            <span>Size: <b><%= it.size %></b></span>
          </div>

          <!-- H√†ng: Qty + ƒê∆°n gi√° (ƒë∆°n gi√° ·ªü b√™n ph·∫£i) -->
          <div class="cdi-row">
            <div class="cdi-qty">
              <button type="button" class="js-cdr-dec" data-idx="<%= it.idx %>">‚àí</button>
              <input id="cdr-qty-<%= it.idx %>" type="number" min="1" value="<%= it.qty %>">
              <button type="button" class="js-cdr-inc" data-idx="<%= it.idx %>">+</button>
            </div>

            <div class="cdi-unit">ƒê∆°n gi√°: <b><%= vnd(it.unit) %></b></div>
          </div>

          <!-- Thanh T·ªïng gi√° -->
          <div class="cdi-total">
            <span class="label">T·ªïng gi√°</span>
            <div class="price" id="cdr-line-<%= it.idx %>"><%= vnd(it.line) %></div>
          </div>
        </div>

        <!-- Remove -->
        <button class="cdi-remove js-cdr-remove" title="Xo√° s·∫£n ph·∫©m n√†y" aria-label="Xo√°" data-idx="<%= it.idx %>">&times;</button>
      </div>
    <% }) %>
  </div>

  <!-- Footer / Actions -->
  <div class="cdr-footer position-absolute start-0 bottom-0 w-100">
    <!-- Coupon -->
    <form class="cdr-coupon" method="post" action="/cart/apply-coupon">
      <input type="text" name="coupon" placeholder="Nh·∫≠p m√£ gi·∫£m gi√° (VD: MIXI10)" autocomplete="off">
      <button type="submit" class="btn-apply">√Åp d·ª•ng</button>
    </form>

    <!-- Totals -->
    <div class="cdr-row mb-2">
      <span>T·ªïng gi√°</span>
      <span id="cdr-subtotal"><%= vnd(drawerTotal) %></span>
    </div>

    <!-- Actions -->
    <div class="cdr-actions">
      <a href="/shop-cart" class="btn btn-outline">Xem gi·ªè h√†ng</a>
      <a href="/shop-cart/checkout" class="btn btn-primary">Thanh to√°n</a>
    </div>
  </div>
</div>

<script>
  (function CartDrawer(){
    const fmt = (n) => (Number(n||0)).toLocaleString('vi-VN') + 'ƒë';
    const $subtotal = document.getElementById('cdr-subtotal');

    async function updateQty(idx, qty){
      try{
        if (qty < 1) qty = 1;
        const res = await fetch(`/cart/update/${idx}`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ quantity: qty })
        });
        const data = await res.json();
        if(!data?.ok) throw new Error(data?.message || 'C·∫≠p nh·∫≠t th·∫•t b·∫°i');

        // set UI
        const ip = document.getElementById(`cdr-qty-${idx}`);
        if (ip) ip.value = qty;
        const line = document.getElementById(`cdr-line-${idx}`);
        if (line) line.textContent = fmt(data.lineTotal);
        if ($subtotal) $subtotal.textContent = fmt(data.totals?.total || 0);

        // also update header badge if exists
        const badge = document.querySelector('#cartDrawer .js-cart-items-count');
        if (badge) {
          const count = document.querySelectorAll('#cartDrawer .cdi').length;
          badge.textContent = count;
        }
      }catch(err){
        console.error(err);
        alert('Kh√¥ng c·∫≠p nh·∫≠t ƒë∆∞·ª£c s·ªë l∆∞·ª£ng. Vui l√≤ng th·ª≠ l·∫°i!');
      }
    }

    async function removeLine(idx){
      try{
        const res = await fetch(`/cart/remove/${idx}`, { method:'POST' });
        const data = await res.json();
        if(!data?.ok) throw new Error(data?.message || 'Xo√° th·∫•t b·∫°i');

        const row = document.getElementById(`cdr-item-${idx}`);
        if (row) row.remove();

        if ($subtotal) $subtotal.textContent = fmt(data.totals?.total || 0);

        const badge = document.querySelector('#cartDrawer .js-cart-items-count');
        if (badge) {
          const count = document.querySelectorAll('#cartDrawer .cdi').length;
          badge.textContent = count;
        }

        if (document.querySelectorAll('#cartDrawer .cdi').length === 0) {
          const list = document.querySelector('#cartDrawer .cart-drawer-items');
          const empty = document.createElement('div');
          empty.className = 'empty';
          empty.innerHTML = '<div class="mb-2" style="font-size:40px;line-height:1;">üõçÔ∏è</div><div class="fw-semibold mb-1">Gi·ªè h√†ng tr·ªëng</div><div class="small">Ti·∫øp t·ª•c mua s·∫Øm ƒë·ªÉ t√¨m m√≥n b·∫°n th√≠ch nh√©!</div>';
          list.appendChild(empty);
        }
      }catch(err){
        console.error(err);
        alert('Kh√¥ng xo√° ƒë∆∞·ª£c s·∫£n ph·∫©m. Vui l√≤ng th·ª≠ l·∫°i!');
      }
    }

    document.addEventListener('click', (e)=>{
      const dec = e.target.closest('.js-cdr-dec');
      if (dec){
        const idx = dec.dataset.idx;
        const ip = document.getElementById(`cdr-qty-${idx}`);
        updateQty(idx, parseInt(ip.value || '1',10) - 1);
        return;
      }
      const inc = e.target.closest('.js-cdr-inc');
      if (inc){
        const idx = inc.dataset.idx;
        const ip = document.getElementById(`cdr-qty-${idx}`);
        updateQty(idx, parseInt(ip.value || '1',10) + 1);
        return;
      }
      const rm = e.target.closest('.js-cdr-remove');
      if (rm){
        const idx = rm.dataset.idx;
        removeLine(idx);
      }
    });

    document.querySelectorAll('[id^="cdr-qty-"]').forEach(ip=>{
      ip.addEventListener('change', ()=>{
        const idx = ip.id.replace('cdr-qty-','');
        updateQty(idx, parseInt(ip.value || '1',10));
      });
    });
  })();
</script>
