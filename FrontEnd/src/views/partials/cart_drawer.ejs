<style>
  /* ===== Cart Drawer Styles ===== */
  #cartDrawer {
    max-width: 440px;
    background: #fff;
    border-left: 1px solid #eef2f7;
    box-shadow: -8px 0 24px rgba(16, 24, 40, 0.08);
  }

  #cartDrawer .aside-header {
    position: sticky;
    top: 0;
    z-index: 2;
    padding: 14px 16px;
    background: #fff;
    border-bottom: 1px solid #eef2f7;
  }

  #cartDrawer .cdr-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 22px;
    height: 22px;
    padding: 0 6px;
    font-size: 12px;
    font-weight: 700;
    color: #fff;
    background: #111827;
    border-radius: 999px;
  }

  #cartDrawer .cart-drawer-items {
    padding: 12px 16px 188px;
    overflow: auto;
    max-height: calc(100vh - 56px - 188px);
  }

  #cartDrawer .empty {
    text-align: center;
    color: #6b7280;
    padding: 32px 12px;
    border: 1px dashed #e5e7eb;
    border-radius: 12px;
    background: #fafafa;
  }

  /* Item Styles */
  .cdi {
    display: flex;
    gap: 12px;
    padding: 12px;
    border: 1px solid #eef2f7;
    border-radius: 14px;
    background: #fff;
    box-shadow: 0 1px 2px rgba(16, 24, 40, 0.04);
  }

  .cdi + .cdi {
    margin-top: 12px;
  }

  .cdi-thumb {
    width: 72px;
    height: 72px;
    flex: 0 0 72px;
    border-radius: 12px;
    overflow: hidden;
    background: #f9fafb;
    border: 1px solid #eef2f7;
  }

  .cdi-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .cdi-ttl {
    margin: 0 0 4px 0;
    line-height: 1.35;
    font-size: 14px;
    font-weight: 700;
    color: #111827;
  }

  .cdi-ttl a {
    color: inherit;
    text-decoration: none;
  }

  .cdi-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 6px 12px;
    font-size: 12px;
    color: #6b7280;
  }

  .cdi-meta b {
    color: #111827;
    font-weight: 700;
  }

  .cdi-row {
    margin-top: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    flex-wrap: wrap;
  }

  .cdi-qty {
    display: flex;
    align-items: center;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    overflow: hidden;
  }

  .cdi-qty button {
    width: 36px;
    height: 36px;
    border: 0;
    background: #fafafa;
    cursor: pointer;
  }

  .cdi-qty input {
    width: 58px;
    height: 36px;
    border: 0;
    text-align: center;
    outline: none;
  }

  .cdi-unit {
    margin-left: auto;
    font-size: 12px;
    color: #6b7280;
    white-space: nowrap;
  }

  .cdi-total {
    margin-top: 10px;
    padding: 10px 12px;
    background: #f9fafb;
    border: 1px solid #eef2f7;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    box-shadow: 0 1px 2px rgba(16, 24, 40, 0.04);
  }

  .cdi-total .label {
    font-size: 12px;
    color: #6b7280;
    letter-spacing: 0.2px;
  }

  .cdi-total .price {
    font-size: 18px;
    line-height: 1.1;
    font-weight: 800;
    color: #111827;
  }

  .cdi-remove {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 28px;
    height: 28px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    background: #fff;
    cursor: pointer;
  }

  .cdi-remove:hover {
    background: #f9fafb;
  }

  /* --- FOOTER STYLES --- */
  .cdr-footer {
    background: #fff;
    border-top: 1px solid #eef2f7;
    padding: 16px;
    box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.05);
  }

  .coupon-box {
    position: relative;
    margin-bottom: 10px;
  }

  .coupon-input-group {
    display: flex;
    gap: 8px;
  }

  .coupon-input-group input {
    flex: 1;
    height: 42px;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 0 12px;
    font-size: 14px;
  }

  /* N√∫t √Åp d·ª•ng chu·∫©n Border */
  .btn-coupon {
    height: 42px;
    border-radius: 10px;
    font-weight: 700;
    padding: 0 16px;
    background: #111827;
    color: #fff;
    border: 1px solid #111827;
    cursor: pointer;
    transition: all 0.2s;
  }

  .btn-coupon:hover {
    background: #000;
  }

  .btn-coupon:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  /* Dropdown G·ª£i √Ω M√£ */
  .coupon-dropdown {
    position: absolute;
    bottom: 100%;
    left: 0;
    width: 100%;
    max-height: 220px;
    overflow-y: auto;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    z-index: 100;
    margin-bottom: 8px;
    display: none;
  }

  .coupon-item {
    padding: 10px 12px;
    border-bottom: 1px solid #f3f4f6;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 13px;
  }

  .coupon-item:hover {
    background-color: #f9fafb;
  }

  .coupon-code-badge {
    font-family: monospace;
    font-weight: 700;
    background: #f3f4f6;
    padding: 4px 8px;
    border-radius: 6px;
    color: #111827;
    border: 1px solid #e5e7eb;
  }

  .coupon-desc {
    font-size: 12px;
    color: #10b981;
    font-weight: 600;
  }

  /* Loyalty Points */
  .points-box {
    background-color: #fffbeb;
    border: 1px solid #fef3c7;
    border-radius: 10px;
    padding: 10px 12px;
    margin-bottom: 15px;
  }
  .form-switch .form-check-input {
    width: 2.5em;
    height: 1.25em;
    cursor: pointer;
  }
  .form-switch .form-check-input:checked {
    background-color: #d97706;
    border-color: #d97706;
  }

  /* Hi·ªÉn th·ªã Ti·ªÅn */
  .price-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 700;
    color: #111827;
  }

  .price-row .label {
    color: #6b7280;
    font-weight: 500;
  }

  .text-success {
    color: #10b981 !important;
  }
  .text-warning {
    color: #d97706 !important;
  }

  .price-total {
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid #eef2f7;
    font-size: 18px;
    font-weight: 800;
    color: #dc2626;
  }

  .cdr-actions .btn {
    height: 44px;
    border-radius: 12px;
    font-weight: 700;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
  }

  .cdr-actions .btn-outline {
    background: #f9fafb;
    border: 1px solid #e5e7eb;
    color: #111827;
  }

  .cdr-actions .btn-primary {
    background: #111827;
    border: 1px solid #111827;
    color: #fff;
  }

  .d-none {
    display: none !important;
  }
</style>

<% const raw = Array.isArray(carts) ? carts : []; const normalized = raw.map((c,
idx) => { const fromA = c && c.productColor && c.productColor.product; const
idIdx = (typeof c.id !== 'undefined') ? c.id : idx; const pid = fromA ?
(c.productColor.product.id || c.productColor.product._id) : (c.productId ||
c.product_id || ''); const name = fromA ? c.productColor.product.name :
(c.productName || c.name_snapshot || 'S·∫£n ph·∫©m'); const brand =
c.brand_name_snapshot || c.brand || ''; const typ = c.category_name_snapshot ||
c.type || ''; const color = fromA ? (c.productColor.color || '‚Äî') :
(c.color_name_snapshot || '‚Äî'); const size = fromA ? ((c.productSize &&
(c.productSize.size || c.productSize.name)) || '‚Äî') : (c.size_name_snapshot ||
'‚Äî'); const img = fromA ? ((c.productColor.imageUrls &&
c.productColor.imageUrls[0]) || '/images/default.png') : (c.img_snapshot ||
'/images/default.png'); const qty = Number(c.quantity || c.qty || 1); const unit
= Number(fromA ? (c.productColor.product.price) : (c.unitPrice ||
c.price_at_time || 0)); const line = unit * qty; return { idx: idIdx, pid, name,
brand, typ, color, size, qty, unit, line, img, url: pid ?
`/product_detail/${pid}` : '#' }; }); const drawerCount = normalized.length;
const drawerTotal = normalized.reduce((s, it) => s + it.line, 0); function
vnd(n) { try { return Number(n || 0).toLocaleString('vi-VN') + 'ƒë'; } catch (e)
{ return (n || 0) + 'ƒë'; } } %>

<div
  class="aside aside_right overflow-hidden cart-drawer"
  id="cartDrawer"
  role="dialog"
  aria-label="Gi·ªè h√†ng"
>
  <div class="aside-header d-flex align-items-center">
    <h3 class="text-uppercase fs-6 mb-0 d-flex align-items-center gap-2">
      <svg class="me-1" width="20" height="20">
        <use href="/images/sprite.svg#icon_cart"></use>
      </svg>
      GI·ªé H√ÄNG
      <span class="cdr-badge js-cart-items-count"><%= drawerCount %></span>
    </h3>
    <button
      class="btn-close-lg js-close-aside btn-close-aside ms-auto"
      aria-label="ƒê√≥ng gi·ªè h√†ng"
    ></button>
  </div>

  <div class="cart-drawer-items js-mini-cart-list">
    <% if (!drawerCount) { %>
    <div class="empty">
      <div class="mb-2" style="font-size: 40px; line-height: 1">üõçÔ∏è</div>
      <div class="fw-semibold mb-1">Gi·ªè h√†ng tr·ªëng</div>
      <div class="small">Ti·∫øp t·ª•c mua s·∫Øm ƒë·ªÉ t√¨m m√≥n b·∫°n th√≠ch nh√©!</div>
    </div>
    <% } %> <% normalized.forEach(function(it){ %>
    <div class="cdi position-relative" id="cdr-item-<%= it.idx %>">
      <a class="cdi-thumb" href="<%= it.url %>" aria-label="<%= it.name %>">
        <img loading="lazy" src="<%= it.img %>" alt="<%= it.name %>" />
      </a>

      <div class="flex-grow-1">
        <h6 class="cdi-ttl"><a href="<%= it.url %>"> <%= it.name %> </a></h6>

        <div class="cdi-meta">
          <% if (it.brand) { %><span>Brand: <b> <%= it.brand %> </b></span>
          <% } %>
          <span>M√†u: <b> <%= it.color %> </b></span>
          <span>Size: <b> <%= it.size %> </b></span>
        </div>

        <div class="cdi-row">
          <div class="cdi-qty">
            <button type="button" class="js-cdr-dec" data-idx="<%= it.idx %>">
              ‚àí
            </button>
            <input
              id="cdr-qty-<%= it.idx %>"
              type="number"
              min="1"
              value="<%= it.qty %>"
            />
            <button type="button" class="js-cdr-inc" data-idx="<%= it.idx %>">
              +
            </button>
          </div>

          <div class="cdi-unit">ƒê∆°n gi√°: <b> <%= vnd(it.unit) %> </b></div>
        </div>

        <div class="cdi-total">
          <span class="label">T·ªïng gi√°</span>
          <div class="price" id="cdr-line-<%= it.idx %>">
            <%= vnd(it.line) %>
          </div>
        </div>
      </div>

      <button
        class="cdi-remove js-cdr-remove"
        title="Xo√° s·∫£n ph·∫©m n√†y"
        aria-label="Xo√°"
        data-idx="<%= it.idx %>"
      >
        &times;
      </button>
    </div>
    <% }) %>
  </div>

  <div class="cdr-footer position-absolute start-0 bottom-0 w-100">
    <div class="coupon-box">
      <div id="coupon-dropdown" class="coupon-dropdown">
        <div id="coupon-list" class="p-0"></div>
        <div
          id="coupon-loading"
          class="p-2 text-center text-muted small"
          style="display: none"
        >
          ƒêang t·∫£i...
        </div>
      </div>

      <div class="coupon-input-group">
        <input
          type="text"
          id="couponInput"
          placeholder="Nh·∫≠p m√£ gi·∫£m gi√°"
          value="<%= typeof appliedCoupon !== 'undefined' ? appliedCoupon : '' %>"
          autocomplete="off"
        />
        <button type="button" class="btn-coupon" id="btnApplyCoupon">
          √Åp d·ª•ng
        </button>
      </div>
      <div id="coupon-msg" class="small mt-1 fw-bold"></div>
    </div>

    <% if (typeof user !== 'undefined' && user && user.loyalty_points > 0) { %>
    <div class="points-box">
      <div
        class="form-check form-switch d-flex justify-content-between align-items-center ps-0 mb-0"
      >
        <label
          class="form-check-label"
          for="usePointsCheckDrawer"
          style="cursor: pointer; flex: 1"
        >
          <div class="fw-bold text-warning" style="color: #b45309">
            <i class="fas fa-coins me-1"></i> S·ª≠ d·ª•ng Xu
          </div>
          <div class="small text-muted">
            C√≥ <b><%= user.loyalty_points %></b> xu (-<%= (user.loyalty_points *
            1000).toLocaleString('vi-VN') %>ƒë)
          </div>
        </label>
        <input class="form-check-input ms-2 mt-0 shadow-none" type="checkbox"
        role="switch" id="usePointsCheckDrawer" <%= (typeof pointsUsed !==
        'undefined' && pointsUsed > 0) ? 'checked' : '' %>>
      </div>
    </div>
    <% } %>

    <div>
      <div class="price-row">
        <span class="label">T·∫°m t√≠nh</span>
        <span id="subtotalDisplay" class="fw-bold">
          <%= vnd(drawerTotal) %>
        </span>
      </div>

      <% const hasDiscount = (typeof discountAmount !== 'undefined' &&
      discountAmount > 0); const discVal = (typeof formattedDiscount !==
      'undefined') ? formattedDiscount : '0ƒë'; const hasPoints = (typeof
      pointsUsed !== 'undefined' && pointsUsed > 0); const pointVal = (typeof
      formattedPointDiscount !== 'undefined') ? formattedPointDiscount : '0ƒë';
      const finalVal = (typeof formattedFinalTotal !== 'undefined') ?
      formattedFinalTotal : vnd(drawerTotal); %>

      <div
        class="price-row text-success <%= hasDiscount ? '' : 'd-none' %>"
        id="discountRow"
      >
        <span>Gi·∫£m gi√°</span>
        <span id="discountDisplay" class="fw-bold">-<%= discVal %></span>
      </div>

      <div
        class="price-row text-warning <%= hasPoints ? '' : 'd-none' %>"
        id="pointRow"
        style="color: #d97706 !important"
      >
        <span>D√πng xu</span>
        <span id="pointDisplay" class="fw-bold">-<%= pointVal %></span>
      </div>

      <div class="price-row price-total">
        <span>T·ªïng c·ªông</span>
        <span id="totalDisplay"> <%= finalVal %> </span>
      </div>
    </div>

    <div class="cdr-actions mt-3">
      <a href="/shop-cart" class="btn btn-outline mb-2">Xem gi·ªè h√†ng</a>
      <a href="/shop-cart/checkout" class="btn btn-primary">Thanh to√°n</a>
    </div>
  </div>
</div>

<script>
  (function () {
    // Cache c√°c Element th∆∞·ªùng d√πng
    const els = {
      list: document.querySelector(".cart-drawer-items"),
      badge: document.querySelector(".js-cart-items-count"),
      subtotal: document.getElementById("subtotalDisplay"),
      total: document.getElementById("totalDisplay"),

      // Coupon UI
      couponInput: document.getElementById("couponInput"),
      couponMsg: document.getElementById("coupon-msg"),
      discRow: document.getElementById("discountRow"),
      discVal: document.getElementById("discountDisplay"),

      // Points UI
      pointRow: document.getElementById("pointRow"),
      pointVal: document.getElementById("pointDisplay"),
      pointCheck: document.getElementById("usePointsCheckDrawer"),

      // Dropdown UI
      dropdown: document.getElementById("coupon-dropdown"),
      dropList: document.getElementById("coupon-list"),
      loading: document.getElementById("coupon-loading"),
    };

    const fmt = (n) => Number(n || 0).toLocaleString("vi-VN") + "ƒë";

    // ============================================================
    // CORE: H√ÄM L√ÄM M·ªöI GI·ªé H√ÄNG (KH√îNG RELOAD)
    // ============================================================
    async function refreshCart() {
      try {
        // 1. L·∫•y d·ªØ li·ªáu m·ªõi nh·∫•t t·ª´ Server
        const res = await fetch("/api/page/minicart");
        const data = await res.json();

        if (!data.ok) return;

        // 2. C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng Badge
        if (els.badge) els.badge.textContent = data.cartCount || 0;

        // 3. C·∫≠p nh·∫≠t danh s√°ch s·∫£n ph·∫©m (V·∫Ω l·∫°i HTML)
        renderCartItems(data.carts);

        // 4. C·∫≠p nh·∫≠t gi√° ti·ªÅn
        if (els.subtotal) els.subtotal.textContent = data.formattedTotal;
        if (els.total) els.total.textContent = data.formattedFinalTotal;

        // 5. C·∫≠p nh·∫≠t tr·∫°ng th√°i M√£ gi·∫£m gi√°
        if (data.discount_amount > 0) {
          els.discRow.classList.remove("d-none");
          els.discVal.textContent = "-" + data.formattedDiscount;

          els.couponInput.value = data.applied_coupon || "";
          els.couponMsg.className = "small mt-1 fw-bold text-success";
          els.couponMsg.textContent = "ƒêang d√πng: " + data.applied_coupon;
        } else {
          els.discRow.classList.add("d-none");
          els.couponMsg.textContent = "";
          // Gi·ªØ nguy√™n input n·∫øu user ƒëang g√µ, ch·ªâ x√≥a n·∫øu r·ªóng t·ª´ server
          if (!data.applied_coupon && els.couponInput.value === "") {
            els.couponInput.value = "";
          }
        }

        // 6. C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒêi·ªÉm th∆∞·ªüng
        if (els.pointCheck) {
          // ƒê·ªìng b·ªô checkbox v·ªõi d·ªØ li·ªáu server
          els.pointCheck.checked = data.points_used > 0;

          if (data.point_discount > 0) {
            els.pointRow.classList.remove("d-none");
            els.pointVal.textContent = "-" + data.formattedPointDiscount;
          } else {
            els.pointRow.classList.add("d-none");
          }
        }
      } catch (e) {
        console.error("Refresh Cart Error:", e);
      }
    }

    // Helper: V·∫Ω l·∫°i HTML danh s√°ch items
    function renderCartItems(items) {
      if (!items || items.length === 0) {
        els.list.innerHTML = `
                <div class="empty">
                    <div class="mb-2" style="font-size: 40px; line-height: 1">üõçÔ∏è</div>
                    <div class="fw-semibold mb-1">Gi·ªè h√†ng tr·ªëng</div>
                    <div class="small">Ti·∫øp t·ª•c mua s·∫Øm ƒë·ªÉ t√¨m m√≥n b·∫°n th√≠ch nh√©!</div>
                </div>`;
        return;
      }

      const html = items
        .map((it, idx) => {
          const name = it.name_snapshot || "S·∫£n ph·∫©m";
          const img = it.img_snapshot || "/images/default.png";
          const url = it.product_id ? `/product_detail/${it.product_id}` : "#";
          const price = fmt(it.price_at_time * it.quantity); // T·ªïng d√≤ng
          const unit = fmt(it.price_at_time); // ƒê∆°n gi√°
          const color = it.color_name_snapshot || "‚Äî";
          const size = it.size_name_snapshot || "‚Äî";

          return `
            <div class="cdi position-relative" id="cdr-item-${idx}">
                <a class="cdi-thumb" href="${url}">
                    <img loading="lazy" src="${img}" alt="${name}">
                </a>
                <div class="flex-grow-1">
                    <h6 class="cdi-ttl"><a href="${url}">${name}</a></h6>
                    <div class="cdi-meta">
                        <span>M√†u: <b>${color}</b></span>
                        <span>Size: <b>${size}</b></span>
                    </div>
                    <div class="cdi-row">
                        <div class="cdi-qty">
                            <button type="button" class="js-cdr-dec" data-idx="${idx}">‚àí</button>
                            <input id="cdr-qty-${idx}" type="number" min="1" value="${it.quantity}">
                            <button type="button" class="js-cdr-inc" data-idx="${idx}">+</button>
                        </div>
                        <div class="cdi-unit">ƒê∆°n gi√°: <b>${unit}</b></div>
                    </div>
                    <div class="cdi-total">
                        <span class="label">T·ªïng gi√°</span>
                        <div class="price" id="cdr-line-${idx}">${price}</div>
                    </div>
                </div>
                <button class="cdi-remove js-cdr-remove" data-idx="${idx}" title="Xo√°">&times;</button>
            </div>`;
        })
        .join("");

      els.list.innerHTML = html;
    }

    // ============================================================
    // LOGIC X·ª¨ L√ù S·ª∞ KI·ªÜN (ACTIONS)
    // ============================================================

    // 1. TƒÉng/Gi·∫£m/X√≥a S·ªë l∆∞·ª£ng
    async function updateQty(idx, qty) {
      try {
        if (qty < 1) qty = 1;
        await fetch(`/cart/update/${idx}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ quantity: qty }),
        });
        // Thay v√¨ reload -> G·ªçi h√†m l√†m m·ªõi
        await refreshCart();
      } catch (err) {
        console.error(err);
      }
    }

    async function removeLine(idx) {
      try {
        await fetch(`/cart/remove/${idx}`, { method: "POST" });
        // Thay v√¨ reload -> G·ªçi h√†m l√†m m·ªõi
        await refreshCart();
      } catch (err) {
        console.error(err);
      }
    }

    // Event Delegation cho c√°c n√∫t trong danh s√°ch items
    document.addEventListener("click", (e) => {
      const dec = e.target.closest(".js-cdr-dec");
      if (dec) {
        const idx = dec.dataset.idx;
        const input = document.getElementById(`cdr-qty-${idx}`);
        return updateQty(idx, parseInt(input.value) - 1);
      }

      const inc = e.target.closest(".js-cdr-inc");
      if (inc) {
        const idx = inc.dataset.idx;
        const input = document.getElementById(`cdr-qty-${idx}`);
        return updateQty(idx, parseInt(input.value) + 1);
      }

      const rm = e.target.closest(".js-cdr-remove");
      if (rm) return removeLine(rm.dataset.idx);
    });

    // X·ª≠ l√Ω input change th·ªß c√¥ng
    document.addEventListener("change", (e) => {
      if (e.target && e.target.id && e.target.id.startsWith("cdr-qty-")) {
        const idx = e.target.id.replace("cdr-qty-", "");
        updateQty(idx, parseInt(e.target.value));
      }
    });

    // 2. Toggle ƒêi·ªÉm Th∆∞·ªüng
    if (els.pointCheck) {
      els.pointCheck.addEventListener("change", async function () {
        const usePoints = this.checked;
        this.disabled = true;
        try {
          const res = await fetch("/cart/toggle-points", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ usePoints }),
          });
          const data = await res.json();
          if (data.ok) {
            await refreshCart(); // L√†m m·ªõi kh√¥ng reload
          } else {
            alert(data.message);
            this.checked = !usePoints;
          }
        } catch (e) {
          console.error(e);
          this.checked = !usePoints;
        } finally {
          this.disabled = false;
        }
      });
    }

    // 3. √Åp d·ª•ng Coupon
    const $btnApply = document.getElementById("btnApplyCoupon");
    if ($btnApply) {
      $btnApply.addEventListener("click", async () => {
        const code = els.couponInput.value.trim();

        // Loading UI
        const oldText = $btnApply.innerText;
        $btnApply.innerText = "...";
        $btnApply.disabled = true;
        els.couponMsg.innerText = "";

        try {
          const res = await fetch("/cart/apply-coupon", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ code }),
          });
          const data = await res.json();

          if (data.ok) {
            // Th√†nh c√¥ng -> L√†m m·ªõi
            await refreshCart();
          } else {
            els.couponMsg.className = "small mt-1 fw-bold text-danger";
            els.couponMsg.innerText = data.message;

            // N·∫øu l·ªói (v√≠ d·ª• m√£ sai), reset l·∫°i gi√° v·ªÅ ban ƒë·∫ßu
            await refreshCart();
          }
        } catch (e) {
          els.couponMsg.className = "small mt-1 fw-bold text-danger";
          els.couponMsg.innerText = "L·ªói k·∫øt n·ªëi";
        } finally {
          $btnApply.innerText = oldText;
          $btnApply.disabled = false;
        }
      });
    }

    // 4. G·ª£i √Ω Coupon (Dropdown)
    let couponsLoaded = false;
    if (els.couponInput) {
      els.couponInput.addEventListener("click", async () => {
        els.dropdown.style.display = "block";

        if (!couponsLoaded) {
          els.loading.style.display = "block";
          try {
            const res = await fetch("/api/discount-code/available");
            const data = await res.json();
            els.loading.style.display = "none";
            els.dropList.innerHTML = "";

            if (data.success && data.items.length > 0) {
              data.items.forEach((c) => {
                const item = document.createElement("div");
                item.className = "coupon-item";
                item.innerHTML = `
                  <span class="coupon-code-badge">${c.code}</span>
                  <span class="coupon-desc">${c.description}</span>
                `;
                item.onclick = () => {
                  els.couponInput.value = c.code;
                  els.dropdown.style.display = "none";
                  $btnApply.click(); // T·ª± ƒë·ªông b·∫•m √°p d·ª•ng
                };
                els.dropList.appendChild(item);
              });
            } else {
              els.dropList.innerHTML =
                '<div class="p-2 text-center small text-muted">Kh√¥ng c√≥ m√£ kh·∫£ d·ª•ng</div>';
            }
            couponsLoaded = true;
          } catch (e) {
            els.dropList.innerHTML =
              '<div class="p-2 text-center small text-danger">L·ªói t·∫£i m√£</div>';
          }
        }
      });

      // Click outside -> close dropdown
      document.addEventListener("click", (e) => {
        if (!e.target.closest(".coupon-box")) {
          els.dropdown.style.display = "none";
        }
      });
    }

    // Expose function global n·∫øu c·∫ßn g·ªçi t·ª´ n∆°i kh√°c (v√≠ d·ª• sau khi Add to Cart)
    window.refreshCartDrawer = refreshCart;
  })();
</script>
