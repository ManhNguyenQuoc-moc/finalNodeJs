<!DOCTYPE html>
<html dir="ltr" lang="vi">
  <head>
    <%- include('partials/head') %>
    <style>
      .checkout-page {
        margin-top: 30px;
        margin-bottom: 50px;
      }
      .order-summary {
        background: #fafafa;
      }
      .shipping-box img {
        opacity: 0.6;
      }
      .checkout-heading {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 16px;
      }
      @media (max-width: 576px) {
        .checkout-heading {
          flex-direction: column;
          align-items: flex-start;
          gap: 6px;
        }
      }
      /* Fix l·ªói giao di·ªán Select2 */
      .select2-container .select2-selection--single {
        height: 38px !important;
        border: 1px solid #ced4da !important;
        display: flex;
        align-items: center;
      }
      .select2-container--bootstrap-5 .select2-selection {
        border-radius: 0.375rem;
      }
    </style>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.0/axios.min.js"></script>
  </head>

  <body>
    <%- include('partials/icons') %> <%- include('partials/header', {
    headerType: 'header' }) %>

    <main>
      <section class="container checkout-page">
        <div class="row">
          <div class="col-lg-7">
            <div class="checkout-heading">
              <h3 class="mb-0">Th√¥ng tin giao h√†ng</h3>
              <% if (!user) { %>
              <p class="mb-0">
                B·∫°n ƒë√£ c√≥ t√†i kho·∫£n? <a href="/login-register">ƒêƒÉng nh·∫≠p</a>
              </p>
              <% } %>
            </div>

            <form id="checkoutForm">
              <div class="mb-3">
                <input
                  type="text"
                  class="form-control"
                  id="name"
                  placeholder="H·ªç v√† t√™n"
                  value="<%= user ? user.full_name : '' %>"
                  required
                />
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <input
                    type="email"
                    class="form-control"
                    id="email"
                    placeholder="Email"
                    value="<%= user ? user.email : '' %>"
                    required
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <input
                    type="text"
                    class="form-control"
                    id="phone"
                    placeholder="S·ªë ƒëi·ªán tho·∫°i"
                    value="<%= user ? (user.phone || '') : '' %>"
                    required
                  />
                </div>
              </div>

              <div class="mb-3">
                <input
                  type="text"
                  class="form-control"
                  id="address"
                  placeholder="ƒê·ªãa ch·ªâ (S·ªë nh√†, T√™n ƒë∆∞·ªùng...)"
                  required
                />
              </div>

              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label small text-muted"
                    >T·ªânh / Th√†nh ph·ªë</label
                  >
                  <select
                    class="form-select select2-box"
                    id="province"
                    required
                  >
                    <option value="">Ch·ªçn T·ªânh / Th√†nh</option>
                  </select>
                  <input type="hidden" id="province_name" />
                </div>

                <div class="col-md-4 mb-3">
                  <label class="form-label small text-muted"
                    >Qu·∫≠n / Huy·ªán</label
                  >
                  <select
                    class="form-select select2-box"
                    id="district"
                    required
                    disabled
                  >
                    <option value="">Ch·ªçn Qu·∫≠n / Huy·ªán</option>
                  </select>
                  <input type="hidden" id="district_name" />
                </div>

                <div class="col-md-4 mb-3">
                  <label class="form-label small text-muted">Ph∆∞·ªùng / X√£</label>
                  <select
                    class="form-select select2-box"
                    id="ward"
                    required
                    disabled
                  >
                    <option value="">Ch·ªçn Ph∆∞·ªùng / X√£</option>
                  </select>
                  <input type="hidden" id="ward_name" />
                </div>
              </div>

              <h5 class="mt-4">Ph∆∞∆°ng th·ª©c v·∫≠n chuy·ªÉn</h5>
              <div class="shipping-box border rounded p-4 text-center">
                <img src="/mixishop/images/box.png" width="60" class="mb-2" />
                <p class="text-muted mb-0">
                  Ph√≠ v·∫≠n chuy·ªÉn: Mi·ªÖn ph√≠ (Ti√™u chu·∫©n)
                </p>
              </div>
            </form>
          </div>

          <div class="col-lg-5">
            <div class="order-summary border rounded p-4">
              <% if(carts && carts.length > 0) { %> <% carts.forEach(cart=> { %>
              <div class="d-flex align-items-center mb-3">
                <img
                  src="<%= cart.img_snapshot %>"
                  width="64"
                  class="me-3"
                  style="object-fit: cover"
                />
                <div class="flex-grow-1">
                  <div><%= cart.name_snapshot %></div>
                  <small class="text-muted">
                    <%= cart.color_name_snapshot %> / <%=
                    cart.size_name_snapshot %>
                  </small>
                </div>
                <div>
                  <%= (cart.price_at_time *
                  cart.quantity).toLocaleString('vi-VN') %>‚Ç´
                </div>
              </div>
              <% }) %> <% } else { %>
              <p>Gi·ªè h√†ng tr·ªëng</p>
              <% } %>

              <div class="mb-3">
                <input
                  type="text"
                  id="discountCodeInput"
                  class="form-control"
                  placeholder="M√£ gi·∫£m gi√°"
                />
              </div>

              <div class="d-flex justify-content-between mb-2">
                <span>T·∫°m t√≠nh</span>
                <span><%= formattedTotal %></span>
              </div>
              <div class="d-flex justify-content-between mb-2">
                <span>Ph√≠ v·∫≠n chuy·ªÉn</span>
                <span>0‚Ç´</span>
              </div>
              <div
                class="d-flex justify-content-between fw-bold fs-5 border-top pt-2"
              >
                <span>T·ªïng c·ªông</span>
                <span><%= formattedTotal %></span>
              </div>

              <button
                type="button"
                id="btnPlaceOrder"
                class="btn btn-danger w-100 mt-4"
              >
                ƒê·∫∂T H√ÄNG
              </button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <%- include('partials/footer') %> <%- include('partials/login_form') %> <%-
    include('partials/cart_drawer') %> <%- include('partials/sitemap') %> <%-
    include('partials/quick_view') %>
    <div class="page-overlay"></div>

    <script src="/mixishop/js/plugins/jquery.min.js"></script>
    <script src="/mixishop/js/plugins/bootstrap.bundle.min.js"></script>
    <script src="/mixishop/js/theme.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script>
      // Nh·∫≠n bi·∫øn latestAddress t·ª´ pages.js truy·ªÅn xu·ªëng
      // S·ª≠ d·ª•ng '|| null' ƒë·ªÉ ph√≤ng tr∆∞·ªùng h·ª£p bi·∫øn n√†y b·ªã undefined
      const rawAddress = "<%- JSON.stringify(latestAddress || null) %>";
      const userAddress = JSON.parse(rawAddress);
      console.log("üëâ D·ªØ li·ªáu ƒê·ªãa ch·ªâ nh·∫≠n ƒë∆∞·ª£c t·ª´ Server:", userAddress);
    </script>
    <script>
      const host = "https://provinces.open-api.vn/api/";

      $(document).ready(function () {
        // Init Select2
        $(".select2-box").select2({
          theme: "bootstrap-5",
          width: "100%",
          placeholder: "Vui l√≤ng ch·ªçn...",
        });

        // G·ªçi Auto-fill n·∫øu c√≥ ƒë·ªãa ch·ªâ
        if (userAddress) {
          autoFillAddress();
        }
      });

      // --- LOGIC AUTO FILL ---
      async function autoFillAddress() {
        if (userAddress.detail) $("#address").val(userAddress.detail);

        const targetCity = userAddress.city || "";
        const targetDistrict = userAddress.district || "";
        const targetWard = userAddress.ward || "";

        if (targetCity) {
          // Ch·ªù API T·ªânh load xong r·ªìi m·ªõi ch·ªçn
          await waitForElement(
            "#province option[data-name='" + targetCity + "']"
          );

          // T√¨m option tr√πng t√™n
          let cityOption = $("#province option").filter(function () {
            return $(this).data("name") === targetCity;
          });

          if (cityOption.length > 0) {
            // Ch·ªçn T·ªânh -> K√≠ch ho·∫°t load Huy·ªán
            $("#province").val(cityOption.val()).trigger("change");

            if (targetDistrict) {
              await waitForElement(
                "#district option[data-name='" + targetDistrict + "']"
              );
              let distOption = $("#district option").filter(function () {
                return $(this).data("name") === targetDistrict;
              });

              if (distOption.length > 0) {
                // Ch·ªçn Huy·ªán -> K√≠ch ho·∫°t load X√£
                $("#district").val(distOption.val()).trigger("change");

                if (targetWard) {
                  await waitForElement(
                    "#ward option[data-name='" + targetWard + "']"
                  );
                  let wardOption = $("#ward option").filter(function () {
                    return $(this).data("name") === targetWard;
                  });
                  if (wardOption.length > 0) {
                    $("#ward").val(wardOption.val()).trigger("change");
                  }
                }
              }
            }
          }
        }
      }

      // H√†m ch·ªù element xu·∫•t hi·ªán (cho API)
      function waitForElement(selector) {
        return new Promise((resolve) => {
          if (document.querySelector(selector))
            return resolve(document.querySelector(selector));
          const observer = new MutationObserver(() => {
            if (document.querySelector(selector)) {
              resolve(document.querySelector(selector));
              observer.disconnect();
            }
          });
          observer.observe(document.body, { childList: true, subtree: true });
        });
      }

      // --- LOGIC API API T·ªàNH TH√ÄNH ---
      var callAPI = (api) => {
        return axios.get(api).then((response) => {
          renderData(response.data, "province");
        });
      };
      callAPI(host + "?depth=1");

      var callApiDistrict = (api) => {
        return axios.get(api).then((response) => {
          renderData(response.data.districts, "district");
        });
      };
      var callApiWard = (api) => {
        return axios.get(api).then((response) => {
          renderData(response.data.wards, "ward");
        });
      };

      var renderData = (array, select) => {
        let row = '<option value=""></option>';
        array.forEach((element) => {
          row += `<option value="${element.code}" data-name="${element.name}">${element.name}</option>`;
        });
        $("#" + select)
          .html(row)
          .trigger("change");
      };

      // S·ª± ki·ªán Change
      $("#province").on("select2:select", function (e) {
        let selectedCode = $(this).val();
        let selectedName = $(this).find(":selected").data("name");
        $("#province_name").val(selectedName);

        $("#district")
          .html('<option value=""></option>')
          .val(null)
          .trigger("change")
          .prop("disabled", false);
        $("#ward")
          .html('<option value=""></option>')
          .val(null)
          .trigger("change")
          .prop("disabled", true);

        if (selectedCode)
          callApiDistrict(host + "p/" + selectedCode + "?depth=2");
      });

      $("#district").on("select2:select", function (e) {
        let selectedCode = $(this).val();
        let selectedName = $(this).find(":selected").data("name");
        $("#district_name").val(selectedName);

        $("#ward")
          .html('<option value=""></option>')
          .val(null)
          .trigger("change")
          .prop("disabled", false);

        if (selectedCode) callApiWard(host + "d/" + selectedCode + "?depth=2");
      });

      $("#ward").on("select2:select", function (e) {
        let selectedName = $(this).find(":selected").data("name");
        $("#ward_name").val(selectedName);
      });

      // --- SUBMIT ---
      $("#btnPlaceOrder").click(async function () {
        if (
          !$("#name").val() ||
          !$("#email").val() ||
          !$("#phone").val() ||
          !$("#address").val() ||
          !$("#province").val()
        ) {
          alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin giao h√†ng!");
          return;
        }

        const btn = $(this);
        btn.prop("disabled", true).text("ƒêang x·ª≠ l√Ω...");

        const payload = {
          name: $("#name").val(),
          email: $("#email").val(),
          phone: $("#phone").val(),
          address: $("#address").val(),
          province: $("#province_name").val(),
          district: $("#district_name").val(),
          ward: $("#ward_name").val(),
          discountCode: $("#discountCodeInput").val(),
        };

        try {
          const res = await axios.post("/checkout/submit", payload);
          if (res.data.ok) {
            alert("ƒê·∫∑t h√†ng th√†nh c√¥ng!");
            window.location.href = "/";
          }
        } catch (error) {
          alert(
            error.response?.data?.message || "C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i!"
          );
          btn.prop("disabled", false).text("ƒê·∫∂T H√ÄNG");
        }
      });
    </script>
  </body>
</html>
