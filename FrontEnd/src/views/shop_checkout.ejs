<!DOCTYPE html>
<html dir="ltr" lang="vi">
  <head>
    <%- include('partials/head') %>
    <style>
      .checkout-page {
        margin-top: 30px;
        margin-bottom: 50px;
      }
      .order-summary {
        background: #fafafa;
      }
      .shipping-box img {
        opacity: 0.6;
      }
      .checkout-heading {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 16px;
      }
      @media (max-width: 576px) {
        .checkout-heading {
          flex-direction: column;
          align-items: flex-start;
          gap: 6px;
        }
      }
      /* Fix l·ªói giao di·ªán Select2 */
      .select2-container .select2-selection--single {
        height: 38px !important;
        border: 1px solid #ced4da !important;
        display: flex;
        align-items: center;
      }
      .select2-container--bootstrap-5 .select2-selection {
        border-radius: 0.375rem;
      }
      .d-none {
        display: none !important;
      }
      /* make discount / final total clearly visible */
      .checkout-discount-row {
        color: #16a34a; /* green-600 */
        font-weight: 700;
        align-items: center;
        gap: 8px;
      }

      .checkout-discount-amount {
        color: #16a34a; /* same green */
        font-weight: 800;
        text-align: right;
      }

      /* final total */
      .checkout-final-label {
        color: #111827; /* dark text */
        font-weight: 700;
        margin-right: 12px;
      }

      .checkout-final-amount {
        color: #dc2626; /* red-600 */
        font-weight: 800;
        font-size: 1.25rem; /* slightly bigger */
        letter-spacing: 0.2px;
      }

      /* transition for a subtle highlight when updated */
      .price-highlight {
        transition: color 180ms ease, transform 140ms ease;
        transform-origin: right center;
      }
      .price-highlight.burst {
        transform: scale(1.02);
      }
    </style>

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.0/axios.min.js"></script>
  </head>

  <body>
    <%- include('partials/icons') %> <%- include('partials/header', {
    headerType: 'header' }) %>

    <main>
      <section class="container checkout-page">
        <div class="row">
          <div class="col-lg-7">
            <div class="checkout-heading">
              <h3 class="mb-0">Th√¥ng tin giao h√†ng</h3>
              <% if (!user) { %>
              <p class="mb-0">
                B·∫°n ƒë√£ c√≥ t√†i kho·∫£n?
                <a href="/login-register">ƒêƒÉng nh·∫≠p</a>
              </p>
              <% } %>
            </div>

            <form id="checkoutForm">
              <div class="mb-3">
                <input
                  type="text"
                  class="form-control"
                  id="name"
                  placeholder="H·ªç v√† t√™n"
                  value="<%= user ? user.full_name : '' %>"
                  required
                />
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <input
                    type="email"
                    class="form-control"
                    id="email"
                    placeholder="Email"
                    value="<%= user ? user.email : '' %>"
                    required
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <input
                    type="text"
                    class="form-control"
                    id="phone"
                    placeholder="S·ªë ƒëi·ªán tho·∫°i"
                    value="<%= user ? (user.phone || '') : '' %>"
                    required
                  />
                </div>
              </div>

              <div class="mb-3">
                <input
                  type="text"
                  class="form-control"
                  id="address"
                  placeholder="ƒê·ªãa ch·ªâ (S·ªë nh√†, T√™n ƒë∆∞·ªùng...)"
                  required
                />
              </div>

              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label small text-muted"
                    >T·ªânh / Th√†nh ph·ªë</label
                  >
                  <select
                    class="form-select select2-box"
                    id="province"
                    required
                  >
                    <option value="">Ch·ªçn T·ªânh / Th√†nh</option>
                  </select>
                  <input type="hidden" id="province_name" />
                </div>

                <div class="col-md-4 mb-3">
                  <label class="form-label small text-muted"
                    >Qu·∫≠n / Huy·ªán</label
                  >
                  <select
                    class="form-select select2-box"
                    id="district"
                    required
                    disabled
                  >
                    <option value="">Ch·ªçn Qu·∫≠n / Huy·ªán</option>
                  </select>
                  <input type="hidden" id="district_name" />
                </div>

                <div class="col-md-4 mb-3">
                  <label class="form-label small text-muted">Ph∆∞·ªùng / X√£</label>
                  <select
                    class="form-select select2-box"
                    id="ward"
                    required
                    disabled
                  >
                    <option value="">Ch·ªçn Ph∆∞·ªùng / X√£</option>
                  </select>
                  <input type="hidden" id="ward_name" />
                </div>
              </div>

              <h5 class="mt-4">Ph∆∞∆°ng th·ª©c v·∫≠n chuy·ªÉn</h5>
              <div class="shipping-box border rounded p-4 text-center">
                <img src="/mixishop/images/box.png" width="60" class="mb-2" />
                <p class="text-muted mb-0">
                  Ph√≠ v·∫≠n chuy·ªÉn: Mi·ªÖn ph√≠ (Ti√™u chu·∫©n)
                </p>
              </div>
            </form>
          </div>

          <div class="col-lg-5">
            <div class="order-summary border rounded p-4">
              <% if(carts && carts.length > 0) { %> <% carts.forEach(cart=> { %>
              <div class="d-flex align-items-center mb-3">
                <img
                  src="<%= cart.img_snapshot %>"
                  width="64"
                  class="me-3"
                  style="object-fit: cover; border-radius: 8px"
                />
                <div class="flex-grow-1">
                  <div class="fw-bold"><%= cart.name_snapshot %></div>
                  <small class="text-muted">
                    <%= cart.color_name_snapshot %> / <%=
                    cart.size_name_snapshot %>
                    <br />x<%= cart.quantity %>
                  </small>
                </div>
                <div class="fw-bold">
                  <%= (cart.price_at_time *
                  cart.quantity).toLocaleString('vi-VN') %>‚Ç´
                </div>
              </div>
              <% }) %> <% } else { %>
              <p class="text-center">Gi·ªè h√†ng tr·ªëng</p>
              <% } %>

              <hr class="my-3" />

              <div class="mb-3">
                <label class="form-label fw-bold small text-muted"
                  >M√£ gi·∫£m gi√°</label
                >
                <div class="input-group">
                  <input
                    type="text"
                    id="checkoutCouponInput"
                    class="form-control"
                    placeholder="Nh·∫≠p m√£ voucher"
                    value="<%= typeof appliedCoupon !== 'undefined' ? appliedCoupon : '' %>"
                  />
                  <button
                    class="btn btn-dark"
                    type="button"
                    id="btnApplyCheckout"
                  >
                    √Åp d·ª•ng
                  </button>
                </div>
                <div id="checkout-coupon-msg" class="small mt-1 fw-bold"></div>
              </div>

              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">T·∫°m t√≠nh</span>
                <span class="fw-bold" id="checkoutSubtotal"
                  ><%= formattedTotal %></span
                >
              </div>

              <% const hasDiscount = (typeof discountAmount !== 'undefined' &&
              discountAmount > 0); %>
              <div
                class="d-flex justify-content-between mb-2 <%= hasDiscount ? '' : 'd-none' %> checkout-discount-row"
                id="checkoutDiscountRow"
                role="status"
                aria-live="polite"
              >
                <span>
                  <i class="fas fa-ticket-alt me-1" aria-hidden="true"></i>
                  Gi·∫£m gi√°
                </span>
                <span
                  class="fw-bold checkout-discount-amount"
                  id="checkoutDiscountAmount"
                >
                  -<%= formattedDiscount %>
                </span>
              </div>

              <% const hasPoints = (typeof pointsUsed !== 'undefined' &&
              pointsUsed > 0); %>
              <div
                class="d-flex justify-content-between mb-2 text-warning <%= hasPoints ? '' : 'd-none' %>"
                style="color: #d97706 !important"
              >
                <span><i class="fas fa-coins me-1"></i> D√πng xu</span>
                <span class="fw-bold"
                  >-<%= typeof formattedPointDiscount !== 'undefined' ?
                  formattedPointDiscount : '0ƒë' %></span
                >
              </div>

              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Ph√≠ v·∫≠n chuy·ªÉn</span>
                <span>0‚Ç´</span>
              </div>

              <div
                class="d-flex justify-content-between align-items-center border-top pt-3 mt-2"
              >
                <span class="fs-5 fw-bold checkout-final-label">T·ªïng c·ªông</span>
                <span
                  class="fs-4 fw-bold checkout-final-amount price-highlight"
                  id="checkoutFinalTotal"
                  aria-live="polite"
                >
                  <%= formattedFinalTotal %>
                </span>
              </div>

              <button
                type="button"
                id="btnPlaceOrder"
                class="btn btn-dark w-100 mt-4 py-3 fw-bold text-uppercase"
              >
                ƒê·∫∂T H√ÄNG
              </button>
            </div>
          </div>
        </div>
      </section>
    </main>

    <%- include('partials/footer') %> <%- include('partials/login_form') %> <%-
    include('partials/cart_drawer') %> <%- include('partials/sitemap') %> <%-
    include('partials/quick_view') %>
    <div class="page-overlay"></div>

    <script src="/mixishop/js/plugins/jquery.min.js"></script>
    <script src="/mixishop/js/plugins/bootstrap.bundle.min.js"></script>
    <script src="/mixishop/js/theme.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <script id="address-data" type="application/json">
      <%- JSON.stringify(typeof latestAddress !== 'undefined' ? latestAddress : null) %>
    </script>

    <script>
      // === PH·∫¶N 1: AUTO-FILL ƒê·ªäA CH·ªà ===
      // L·∫•y d·ªØ li·ªáu an to√†n t·ª´ th·∫ª tr√™n
      const rawData = document.getElementById("address-data").textContent;
      let userAddress = null;
      try {
        userAddress = JSON.parse(rawData);
      } catch (e) {}

      console.log("üëâ Data Auto-fill:", userAddress);

      const host = "https://provinces.open-api.vn/api/";

      $(document).ready(function () {
        // Init Select2
        $(".select2-box").select2({
          theme: "bootstrap-5",
          width: "100%",
          placeholder: "Vui l√≤ng ch·ªçn...",
        });

        // G·ªçi Auto-fill n·∫øu c√≥ d·ªØ li·ªáu
        if (userAddress) {
          autoFillAddress();
        }
      });

      // H√†m Auto-fill th√¥ng minh (c√≥ await API)
      async function autoFillAddress() {
        if (userAddress.detail) $("#address").val(userAddress.detail);

        const targetCity = userAddress.city || "";
        const targetDistrict = userAddress.district || "";
        const targetWard = userAddress.ward || "";

        if (targetCity) {
          // 1. Ch·ªù API T·ªânh load xong
          await waitForElement(
            "#province option[data-name='" + targetCity + "']"
          );

          let cityOption = $("#province option").filter(function () {
            return $(this).data("name") === targetCity;
          });

          if (cityOption.length > 0) {
            let cityCode = cityOption.val();
            // Ch·ªçn T·ªânh
            $("#province").val(cityCode).trigger("change");

            // üî• G·ªçi API load Huy·ªán th·ªß c√¥ng v√† ch·ªù n√≥ xong
            await callApiDistrict(host + "p/" + cityCode + "?depth=2");

            if (targetDistrict) {
              let distOption = $("#district option").filter(function () {
                return $(this).data("name") === targetDistrict;
              });

              if (distOption.length > 0) {
                let distCode = distOption.val();
                // Ch·ªçn Huy·ªán
                $("#district").val(distCode).trigger("change");

                // üî• G·ªçi API load X√£ th·ªß c√¥ng v√† ch·ªù n√≥ xong
                await callApiWard(host + "d/" + distCode + "?depth=2");

                if (targetWard) {
                  let wardOption = $("#ward option").filter(function () {
                    return $(this).data("name") === targetWard;
                  });
                  if (wardOption.length > 0) {
                    // Ch·ªçn X√£
                    $("#ward").val(wardOption.val()).trigger("change");
                  }
                }
              }
            }
          }
        }
      }

      function waitForElement(selector) {
        return new Promise((resolve) => {
          if (document.querySelector(selector))
            return resolve(document.querySelector(selector));
          const observer = new MutationObserver(() => {
            if (document.querySelector(selector)) {
              resolve(document.querySelector(selector));
              observer.disconnect();
            }
          });
          observer.observe(document.body, { childList: true, subtree: true });
        });
      }

      // --- C√ÅC H√ÄM G·ªåI API H√ÄNH CH√çNH ---
      var callAPI = (api) => {
        return axios.get(api).then((response) => {
          renderData(response.data, "province");
        });
      };
      callAPI(host + "?depth=1");

      var callApiDistrict = (api) => {
        return axios.get(api).then((response) => {
          renderData(response.data.districts, "district");
        });
      };
      var callApiWard = (api) => {
        return axios.get(api).then((response) => {
          renderData(response.data.wards, "ward");
        });
      };

      var renderData = (array, select) => {
        let row = '<option value=""></option>';
        array.forEach((element) => {
          row += `<option value="${element.code}" data-name="${element.name}">${element.name}</option>`;
        });
        $("#" + select)
          .html(row)
          .trigger("change");
      };

      // S·ª± ki·ªán Select2 Change
      $("#province").on("select2:select", function (e) {
        let selectedCode = $(this).val();
        let selectedName = $(this).find(":selected").data("name");
        $("#province_name").val(selectedName);

        $("#district")
          .html('<option value=""></option>')
          .val(null)
          .trigger("change")
          .prop("disabled", false);
        $("#ward")
          .html('<option value=""></option>')
          .val(null)
          .trigger("change")
          .prop("disabled", true);

        if (selectedCode)
          callApiDistrict(host + "p/" + selectedCode + "?depth=2");
      });

      $("#district").on("select2:select", function (e) {
        let selectedCode = $(this).val();
        let selectedName = $(this).find(":selected").data("name");
        $("#district_name").val(selectedName);

        $("#ward")
          .html('<option value=""></option>')
          .val(null)
          .trigger("change")
          .prop("disabled", false);

        if (selectedCode) callApiWard(host + "d/" + selectedCode + "?depth=2");
      });

      $("#ward").on("select2:select", function (e) {
        let selectedName = $(this).find(":selected").data("name");
        $("#ward_name").val(selectedName);
      });

      // === PH·∫¶N 2: LOGIC M√É GI·∫¢M GI√Å T·∫†I CHECKOUT ===
      document
        .getElementById("btnApplyCheckout")
        .addEventListener("click", async function () {
          const btn = this;
          const input = document.getElementById("checkoutCouponInput");
          const msg = document.getElementById("checkout-coupon-msg");
          const discountRow = document.getElementById("checkoutDiscountRow");
          const discountVal = document.getElementById("checkoutDiscountAmount");
          const finalTotal = document.getElementById("checkoutFinalTotal");
          const subtotal = document.getElementById("checkoutSubtotal"); // Gi√° g·ªëc (T·∫°m t√≠nh)

          const code = input.value.trim();

          // UI Loading
          const oldText = btn.innerText;
          btn.innerText = "...";
          btn.disabled = true;
          msg.innerText = "";

          try {
            // G·ªçi API chung v·ªõi Gi·ªè h√†ng (ƒë√£ t·∫°o ·ªü controller/cart)
            const res = await fetch("/cart/apply-coupon", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ code }), // Code r·ªóng = H·ªßy m√£
            });
            const data = await res.json();

            if (data.ok) {
              // ƒê·ªãnh d·∫°ng ti·ªÅn
              const fmt = (n) => Number(n || 0).toLocaleString("vi-VN") + " ‚Ç´";

              if (data.discountAmount > 0) {
                // Th√†nh c√¥ng: C√≥ gi·∫£m gi√°
                msg.className = "small mt-1 fw-bold text-success";
                msg.innerText = data.message;

                discountRow.classList.remove("d-none");
                discountRow.classList.add("d-flex");
                discountVal.innerText = "-" + fmt(data.discountAmount);
                finalTotal.innerText = fmt(data.finalTotal);
              } else {
                // Th√†nh c√¥ng: Nh∆∞ng l√† H·ªßy m√£ (ho·∫∑c gi·∫£m 0ƒë)
                if (code === "") msg.innerText = "";
                else {
                  msg.className = "small mt-1 fw-bold text-warning";
                  msg.innerText = data.message;
                }
                // Reset v·ªÅ gi√° g·ªëc
                discountRow.classList.add("d-none");
                discountRow.classList.remove("d-flex");
                finalTotal.innerText = subtotal.innerText;
              }
            } else {
              // L·ªói (M√£ sai/H·∫øt h·∫°n)
              msg.className = "small mt-1 fw-bold text-danger";
              msg.innerText = data.message;

              // Reset v·ªÅ gi√° g·ªëc
              discountRow.classList.add("d-none");
              discountRow.classList.remove("d-flex");
              finalTotal.innerText = subtotal.innerText;
              input.value = ""; // X√≥a m√£ sai
            }
          } catch (e) {
            console.error(e);
            msg.className = "small mt-1 fw-bold text-danger";
            msg.innerText = "L·ªói k·∫øt n·ªëi";
          } finally {
            btn.innerText = oldText;
            btn.disabled = false;
          }
        });

      // === PH·∫¶N 3: LOGIC ƒê·∫∂T H√ÄNG ===
      $("#btnPlaceOrder").click(async function () {
        if (
          !$("#name").val() ||
          !$("#email").val() ||
          !$("#phone").val() ||
          !$("#address").val() ||
          !$("#province").val()
        ) {
          alert("Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin giao h√†ng!");
          return;
        }
        const btn = $(this);
        btn.prop("disabled", true).text("ƒêang x·ª≠ l√Ω...");

        const payload = {
          name: $("#name").val(),
          email: $("#email").val(),
          phone: $("#phone").val(),
          address: $("#address").val(),
          province: $("#province_name").val(),
          district: $("#district_name").val(),
          ward: $("#ward_name").val(),
          // KH√îNG C·∫¶N G·ª¨I discountCode n·ªØa v√¨ Backend t·ª± l·∫•y t·ª´ Cart
        };

        // Fallback l·∫•y d·ªØ li·ªáu n·∫øu input hidden ch∆∞a c·∫≠p nh·∫≠t
        if (!payload.province)
          payload.province = $("#province option:selected").data("name");
        if (!payload.district)
          payload.district = $("#district option:selected").data("name");
        if (!payload.ward)
          payload.ward = $("#ward option:selected").data("name");

        try {
          const res = await axios.post("/checkout/submit", payload);
          if (res.data.ok) {
            alert("ƒê·∫∑t h√†ng th√†nh c√¥ng!");
            window.location.href = "/";
          }
        } catch (error) {
          alert(
            error.response?.data?.message || "C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i!"
          );
          btn.prop("disabled", false).text("ƒê·∫∂T H√ÄNG");
        }
      });
    </script>
  </body>
</html>
