<!DOCTYPE html>
<html lang="vi">
<head>
  <%- include('partials/head') %>
  <style>
    /* ==== Cart row – clean, responsive, alignment by columns ==== */
    .cart-row{
      display:grid;
      grid-template-columns: 96px 1fr 170px 120px 44px 140px; /* thumb | info | qty | unit | del | total */
      align-items:center; gap:16px;
      padding:16px 18px; margin-top:14px;
      background:#fff; border:1px solid #eef2f7; border-radius:14px;
      box-shadow:0 1px 2px rgba(16,24,40,.04);
    }
    .cart-row:hover{ box-shadow:0 6px 24px rgba(16,24,40,.06); }

    .ci-thumb img{ width:96px; height:96px; object-fit:cover; border-radius:12px; border:1px solid #f1f5f9; }

    .ci-info .ci-title{ font-weight:700; color:#0f172a; text-decoration:none; }
    .ci-info .ci-title:hover{ text-decoration:underline; }
    .ci-variants{ margin-top:6px; color:#6b7280; display:flex; flex-wrap:wrap; align-items:center; gap:6px; }
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; font-size:12px; font-weight:600; color:#374151;
      border:1px solid #e5e7eb; background:#fafafa; border-radius:999px;
    }
    .ci-unit-inline{ margin-top:6px; font-size:13px; color:#475569; display:none; } /* mobile-only */

    .ci-qty{ justify-self:center; }
    .qty{
      display:flex; align-items:center; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden;
      background:#fff;
    }
    .qty-btn{ width:38px; height:38px; border:0; background:#f8fafc; cursor:pointer; font-weight:700; }
    .qty-btn:hover{ background:#eef2f7; }
    .qty-input{ width:60px; height:38px; border:0; text-align:center; outline:none; font-weight:600; }

    .ci-price, .ci-total{ text-align:right; font-weight:700; color:#0f172a; }
    .ci-price{ font-weight:600; color:#334155; }

    .ci-delete{
      justify-self:center; border:0; background:transparent; cursor:pointer;
      color:#9ca3af; width:36px; height:36px; display:flex; align-items:center; justify-content:center;
      border-radius:10px;
    }
    .ci-delete:hover{ color:#ef4444; background:#fff1f2; }

    .money{ white-space:nowrap; }
    .ci-total .label{ display:block; font-size:12px; color:#6b7280; margin-bottom:2px; }
    .ci-total .value{ font-size:16px; color:#111827; }

    /* ===== Page layout ===== */
    .cart-layout{display:grid;grid-template-columns:minmax(0,1fr) 360px;gap:28px}
    @media (max-width: 992px){.cart-layout{grid-template-columns:1fr}}

    .cart-header{background:#f6f7f9;border-radius:12px;padding:12px 16px;font-weight:700}

    .summary{border:1px solid #eef2f7;border-radius:14px;padding:18px;background:#fff;position:sticky;top:20px;box-shadow:0 1px 2px rgba(16,24,40,.04)}
    .summary-title{font-weight:800;margin-bottom:14px;font-size:18px}
    .summary-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-top:1px solid #f1f5f9}
    .summary-row:first-of-type{border-top:0}
    .summary-hint{font-size:14px;color:#6b7280;margin:10px 0 18px}
    .btn-checkout{display:block;width:100%;text-align:center;background:#000;color:#fff;padding:14px;border-radius:10px;font-weight:800;text-decoration:none}
    .btn-checkout:hover{filter:brightness(.95)}

    /* ===== Responsive ===== */
    @media (max-width: 992px){
      .cart-row{
        grid-template-columns: 76px 1fr 140px auto;  /* thumb | info | qty | total */
        grid-template-areas:
          "thumb info qty total";
      }
      .ci-thumb{ grid-area:thumb; }
      .ci-info{ grid-area:info; }
      .ci-qty{ grid-area:qty; justify-self:flex-start; }
      .ci-price, .ci-delete{ display:none; }
      .ci-total{ grid-area:total; text-align:right; }
      .ci-unit-inline{ display:block; }
    }
    @media (max-width: 576px){
      .cart-row{ grid-template-columns: 64px 1fr; grid-auto-rows:auto; grid-row-gap:12px; }
      .ci-thumb{ grid-column:1 / 2; grid-row:1 / 3; }
      .ci-info{ grid-column:2 / -1; }
      .ci-qty{ grid-column:2 / -1; }
      .ci-total{ grid-column:2 / -1; text-align:left; }
    }
  </style>
</head>
<body>
  <%- include('partials/icons') %>
  <%- include('partials/header', { headerType: 'header' }) %>

  <main class="container">
    <div class="mb-4 pb-4"></div>
    <h3 class="mb-3">Giỏ hàng</h3>

    <% if (isEmpty) { %>
      <div class="text-center my-4">Giỏ hàng của bạn đang trống. Vui lòng thêm sản phẩm trước khi thanh toán.</div>
    <% } else {
      const normalized = (carts || []).map((c, i) => {
        const p   = (c.productColor && c.productColor.product) || {};
        const pid = p.id || p._id || c.productId || c.product_id || '';
        const name= p.name || c.productName || c.name_snapshot || 'Sản phẩm';
        const qty = Number(c.quantity || c.qty || 1);
        // Ưu tiên giá snapshot để đúng với giá đã cho vào giỏ
        const unit= Number(c.price_at_time ?? c.unitPrice ?? (p && p.price) ?? 0);
        const img = (c.productColor && c.productColor.imageUrls && c.productColor.imageUrls[0])
                    || c.img_snapshot || '/images/default.png';
        const color = (c.productColor && c.productColor.color) || c.color_name_snapshot || '—';
        const size  = (c.productSize && (c.productSize.size || c.productSize.name)) || c.size_name_snapshot || '—';
        return { id: (typeof c.id !== 'undefined' ? c.id : i), pid, name, qty, unit, line: unit*qty, img, color, size };
      });
    %>

    <div class="cart-layout">
      <div class="cart-left">
        <div class="cart-header">Bạn đang có <%= normalized.length %> sản phẩm</div>

        <% normalized.forEach(function(it){ %>
          <div class="cart-row" id="cart-item-<%= it.id %>">
            <a class="ci-thumb" href="/product_detail/<%= it.pid %>">
              <img src="<%= it.img %>" alt="<%= it.name %>">
            </a>

            <div class="ci-info">
              <a class="ci-title" href="/product_detail/<%= it.pid %>"><%= it.name %></a>
              <div class="ci-variants">
                <span class="chip">Màu: <strong><%= it.color %></strong></span>
                <span class="chip">Size: <strong><%= it.size %></strong></span>
              </div>
              <div class="ci-unit-inline">Đơn giá: <strong class="money"><%= it.unit.toLocaleString('vi-VN') %>đ</strong></div>
            </div>

            <div class="ci-qty">
              <div class="qty">
                <button type="button" class="qty-btn btn-dec" data-id="<%= it.id %>">−</button>
                <input class="qty-input" id="qty-<%= it.id %>" type="number" min="1" value="<%= it.qty %>">
                <button type="button" class="qty-btn btn-inc" data-id="<%= it.id %>">+</button>
              </div>
            </div>

            <div class="ci-price money"><%= it.unit.toLocaleString('vi-VN') %>đ</div>

            <button type="button" class="ci-delete remove-cart" title="Xoá" data-id="<%= it.id %>">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M9 3h6a1 1 0 0 1 1 1v1h4v2H4V5h4V4a1 1 0 0 1 1-1zm1 6h2v9h-2V9zm4 0h2v9h-2V9zM8 9h2v9H8V9z"/></svg>
            </button>

            <div class="ci-total">
              <span class="label">Thành tiền</span>
              <span class="value money" id="line-<%= it.id %>"><%= it.line.toLocaleString('vi-VN') %>đ</span>
            </div>
          </div>
        <% }) %>
      </div>

      <aside class="cart-right">
        <div class="summary">
          <div class="summary-title">Thông tin đơn hàng</div>
          <div class="summary-row">
            <span>Tạm tính</span>
            <strong id="sum-total"><%= formattedTotal %></strong>
          </div>
          <div class="summary-hint">Bạn có thể nhập mã giảm giá ở bước tiếp theo.</div>
          <a href="/shop-cart/checkout" class="btn-checkout">THANH TOÁN</a>
        </div>
      </aside>
    </div>
    <% } %>
  </main>

  <div class="mb-5 pb-xl-5"></div>
  <%- include('partials/footer') %>
  <%- include('partials/login_form') %>
  <%- include('partials/cart_drawer') %>
  <%- include('partials/sitemap') %>
  <%- include('partials/quick_view') %>
  <div id="scrollTop" class="visually-hidden end-0"></div>
  <div class="page-overlay"></div>

  <!-- scripts -->
  <script src="/mixishop/js/plugins/jquery.min.js"></script>
  <script src="/mixishop/js/plugins/bootstrap.bundle.min.js"></script>
  <script src="/mixishop/js/plugins/swiper.min.js"></script>
  <script src="/mixishop/js/theme.js"></script>

  <script>
    const fmt = n => (Number(n||0)).toLocaleString('vi-VN') + 'đ';

    function updateSum(total) {
      const el = document.getElementById('sum-total');
      if (el) el.textContent = fmt(total);
    }

    async function setQty(id, qty) {
      try {
        if (qty < 1) qty = 1;
        const res = await fetch(`/cart/update/${id}`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ quantity: qty })
        });
        const data = await res.json();
        if (!data?.ok) throw new Error(data?.message || 'Cập nhật thất bại');
        document.getElementById(`qty-${id}`).value = qty;
        document.getElementById(`line-${id}`).textContent = fmt(data.lineTotal);
        updateSum(data.totals.total);
      } catch (err) {
        console.error('setQty error:', err);
        alert('Không cập nhật được số lượng. Vui lòng thử lại!');
      }
    }

    async function removeItem(id) {
      try {
        const res = await fetch(`/cart/remove/${id}`, { method:'POST' });
        const data = await res.json();
        if (!data?.ok) throw new Error(data?.message || 'Xoá thất bại');
        const row = document.getElementById(`cart-item-${id}`);
        if (row) row.remove();
        updateSum(data.totals.total);
      } catch (err) {
        console.error('removeItem error:', err);
        alert('Không xoá được sản phẩm. Vui lòng thử lại!');
      }
    }

    document.addEventListener('click', (e)=>{
      const dec = e.target.closest('.btn-dec');
      if (dec) {
        e.preventDefault();
        const id = dec.dataset.id;
        const ip = document.getElementById(`qty-${id}`);
        setQty(id, parseInt(ip.value || '1',10) - 1);
        return;
      }
      const inc = e.target.closest('.btn-inc');
      if (inc) {
        e.preventDefault();
        const id = inc.dataset.id;
        const ip = document.getElementById(`qty-${id}`);
        setQty(id, parseInt(ip.value || '1',10) + 1);
        return;
      }
      const rm = e.target.closest('.remove-cart');
      if (rm) {
        e.preventDefault();
        removeItem(rm.dataset.id);
      }
    });

    document.querySelectorAll('.qty-input').forEach(ip=>{
      ip.addEventListener('change', (e)=>{
        e.preventDefault();
        const id = ip.id.replace('qty-','');
        setQty(id, parseInt(ip.value || '1',10));
      });
    });
  </script>
</body>
</html>
