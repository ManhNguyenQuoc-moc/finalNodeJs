<!DOCTYPE html>
<html dir="ltr" lang="zxx">

<head>
  <style>
    .chat-bubble {
      background: #f6f7f9;
      border-radius: 12px;
      padding: 10px 12px;
    }

    .chat-meta {
      font-size: 12px;
      color: #6b7280;
    }

    .comment-item {
      margin-bottom: 12px;
    }

    .comment-item .children {
      margin-left: 20px;
      margin-top: 8px;
    }

    .btn-xxs {
      padding: 2px 8px;
      font-size: 12px;
      line-height: 20px;
    }

    .like-btn {
      background: transparent;
      border: 0;
      cursor: pointer;
    }

    .like-btn .heart {
      font-size: 16px;
      vertical-align: -2px;
      margin-right: 4px;
    }

    .reply-form textarea {
      min-height: 70px;
    }

    .star,
    .rate-star {
      font-style: normal;
      font-size: 18px;
      line-height: 1;
      color: #bbb;
      cursor: default;
      transition: transform .08s ease, color .12s ease;
      user-select: none;
    }

    .star.filled,
    .rate-star.filled {
      color: #f5a623;
    }

    .rating-box {
      background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
      padding: 1rem 1.5rem;
      border-radius: 12px;
      border: 2px solid #fed7aa;
      box-shadow: 0 2px 8px rgba(251, 146, 60, 0.1);
      position: relative;
      z-index: 1;
    }

    .rating-box .rate-star {
      cursor: pointer;
      font-size: 28px;
      margin-right: 4px;
      transition: all 0.2s ease;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }

    .rating-box .rate-star:hover {
      transform: scale(1.2) rotate(5deg);
      filter: drop-shadow(0 4px 8px rgba(251, 146, 60, 0.3));
    }

    .rating-box .rate-star.filled {
      color: #f59e0b;
      animation: starPulse 0.3s ease;
    }

    @keyframes starPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.3); }
      100% { transform: scale(1); }
    }

    .cmt-item:last-child {
      border-bottom: 0 !important;
    }

    .qa-card {
      background: #fff;
      border: 1px solid #eef2f7;
      border-radius: 14px;
      box-shadow: 0 1px 2px rgba(16, 24, 40, .04);
      padding: 18px;
    }

    .qa-hero {
      display: flex;
      gap: 18px;
      align-items: center;
      background: #f7f8fb;
      border-radius: 14px;
      padding: 18px;
    }

    .qa-hero__img {
      width: 110px;
      flex: 0 0 110px;
    }

    .qa-hero__img img {
      width: 100%;
      height: auto;
    }

    .qa-title {
      font-weight: 800;
      font-size: 28px;
      margin-bottom: 8px;
    }

    .qa-desc {
      color: #6b7280;
    }

    .qa-input {
      display: flex;
      gap: 14px;
      margin-top: 14px;
    }

    .qa-input .form-control {
      height: 48px;
    }

    .btn-ask {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #fff;
      border: 0;
      height: 52px;
      border-radius: 12px;
      padding: 0 2.5rem;
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
      position: relative;
      overflow: hidden;
    }

    .btn-ask::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .btn-ask:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
    }

    .btn-ask:hover::before {
      left: 100%;
    }

    .btn-ask:active {
      transform: translateY(0);
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }

    .btn-ask:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    @media (max-width:768px) {
      .qa-hero {
        flex-direction: column;
        align-items: flex-start;
      }

      .qa-input {
        flex-direction: column;
      }

      .btn-ask {
        width: 100%;
      }

      .qa-hero__img {
        width: 82px;
        flex: 0 0 82px;
      }
    }

    .pdp-subnav {
      background: #fff;
      z-index: 2;
      border-bottom: 1px solid #eee;
    }

    .pdp-subnav__list {
      display: flex;
      gap: 18px;
      padding: 10px 0;
      margin: 0;
      list-style: none;
      overflow: auto;
    }

    .pdp-subnav__list a {
      display: inline-block;
      padding: 8px 10px;
      border-radius: 8px;
      font-weight: 600;
      color: #374151;
      text-decoration: none;
    }

    .pdp-subnav__list a:hover,
    .pdp-subnav__list a.active {
      background: #f1f5f9;
      color: #111827;
    }

    .pdp-section {
      scroll-margin-top: 80px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
    }

    .card {
      border: 1px solid #eef2f7;
      border-radius: 14px;
      box-shadow: 0 1px 2px rgba(16, 24, 40, .04);
    }

    .feature-tile {
      border: 1px dashed #e5e7eb;
      border-radius: 12px;
      padding: 12px;
      background: #fafafa;
    }

    .ft-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .rating-large .star {
      font-size: 24px;
      color: #bbb;
    }

    .star.filled,
    .rate-star.filled {
      color: #f59e0b;
    }

    .custom-swatch-container .custom-swatch-color {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      margin-right: 8px;
    }

    .custom-swatch-container .custom-swatch-color.swatch_active {
      outline: 2px solid #111827;
    }

    .qty-control {
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
    }

    .qty-control__reduce,
    .qty-control__increase {
      width: 38px;
      cursor: pointer;
    }

    /* NEW: size/color swatch styling + disabled state */
    .swatch-list .swatch {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 36px;
      height: 32px;
      padding: 0 10px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      font-size: 14px;
      font-weight: 500;
      color: #111827;
      margin: 0 6px 6px 0;
      cursor: pointer;
      transition: all .15s ease;
    }

    .swatch-list .swatch_active,
    .swatch-list input[type="radio"]:checked+.swatch {
      border-color: #111827;
      background: #111827;
      color: #fff;
    }

    .swatch-disabled {
      opacity: .35 !important;
      cursor: not-allowed !important;
      position: relative;
    }

    .swatch-disabled::after {
      content: "";
      position: absolute;
      left: 4px;
      right: 4px;
      top: 50%;
      border-top: 1px solid #9ca3af;
      transform: rotate(-18deg);
    }

    .combination-status {
      font-size: 13px;
      margin-top: 4px;
    }

    .combination-status.ok {
      color: #16a34a;
    }

    .combination-status.error {
      color: #dc2626;
    }

    /* ========== BEAUTIFUL MODERN REVIEWS SECTION ========== */
    .reviews-section {
      margin-top: 3rem;
      margin-bottom: 3rem;
    }

    .reviews-header-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 2.5rem;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
      margin-bottom: 2.5rem;
    }

    .reviews-stats {
      display: flex;
      align-items: flex-start;
      gap: 3rem;
      margin-bottom: 2.5rem;
      padding-bottom: 2rem;
      border-bottom: 2px solid #f3f4f6;
    }

    .reviews-stats-left {
      flex: 1;
      position: relative;
      padding: 2rem;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 50%, #e2e8f0 100%);
      border-radius: 16px;
      border: 1px solid #e2e8f0;
      box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.03);
      overflow: hidden;
    }

    .reviews-stats-left::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -20%;
      width: 300px;
      height: 300px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.08) 0%, transparent 70%);
      border-radius: 50%;
      pointer-events: none;
    }

    .reviews-stats-left::after {
      content: '';
      position: absolute;
      bottom: -30%;
      left: -10%;
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(139, 92, 246, 0.06) 0%, transparent 70%);
      border-radius: 50%;
      pointer-events: none;
    }

    .reviews-stats-left .qa-title {
      color: #111827;
      font-size: 2rem;
      font-weight: 800;
      margin-bottom: 0.75rem;
      letter-spacing: -0.5px;
      position: relative;
      z-index: 1;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .reviews-stats-left .qa-title::before {
      content: 'üí¨';
      font-size: 2.25rem;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
    }

    .reviews-stats-left .qa-desc {
      color: #475569;
      font-size: 1.0625rem;
      line-height: 1.75;
      position: relative;
      z-index: 1;
      padding-left: 0.5rem;
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .reviews-stats-left .qa-desc::before {
      content: '‚ú®';
      font-size: 1.25rem;
      margin-top: 0.125rem;
    }

    .reviews-stats-right {
      text-align: right;
      background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
      padding: 1.75rem 2rem;
      border-radius: 14px;
      border: 1px solid #e5e7eb;
      min-width: 200px;
    }

    .reviews-stats-right .rating-large {
      margin-bottom: 0.75rem;
    }

    .reviews-stats-right .rating-large .star {
      color: #fbbf24;
      font-size: 1.5rem;
      margin-right: 2px;
    }

    .reviews-stats-right .fw-bold {
      color: #111827;
      font-size: 2rem;
      font-weight: 800;
    }

    .reviews-stats-right #sentimentStats {
      color: #4b5563;
      font-size: 0.875rem;
      margin-top: 0.75rem;
      line-height: 1.8;
    }

    .reviews-stats-right .text-muted {
      color: #6b7280 !important;
      font-size: 0.9375rem;
      margin-top: 0.5rem;
    }

    .reviews-form-section {
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border-radius: 16px;
      padding: 2.5rem;
      border: 2px solid #e2e8f0;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04), inset 0 1px 0 rgba(255, 255, 255, 0.8);
      position: relative;
      overflow: hidden;
    }

    .reviews-form-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 50%, #ec4899 100%);
      border-radius: 16px 16px 0 0;
    }

    .reviews-form-section::after {
      content: '';
      position: absolute;
      top: -50%;
      right: -10%;
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(59, 130, 246, 0.05) 0%, transparent 70%);
      border-radius: 50%;
      pointer-events: none;
    }

    /* Toggle button cho reviews list */
    .reviews-toggle-section {
      display: flex;
      justify-content: center;
      padding: 1rem 0;
    }

    .btn-toggle-reviews {
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      border: 2px solid #cbd5e1;
      border-radius: 12px;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      font-size: 0.9375rem;
      color: #475569;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .btn-toggle-reviews:hover {
      background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
      border-color: #94a3b8;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      color: #334155;
    }

    .btn-toggle-reviews:active {
      transform: translateY(0);
    }

    .btn-toggle-reviews .toggle-icon {
      transition: transform 0.3s ease;
      display: inline-flex;
      align-items: center;
    }

    .btn-toggle-reviews[aria-expanded="false"] .toggle-icon {
      transform: rotate(180deg);
    }

    .btn-toggle-reviews[aria-expanded="false"] .toggle-text::after {
      content: ' (Nh·∫•n ƒë·ªÉ xem)';
      font-size: 0.875rem;
      font-weight: 400;
      opacity: 0.7;
    }

    /* Reviews list container v·ªõi collapse/expand */
    .reviews-list-container {
      max-height: 2000px;
      overflow: hidden;
      transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
      opacity: 1;
    }

    .reviews-list-container.collapsed {
      max-height: 0;
      opacity: 0;
      margin: 0;
      padding: 0;
    }

    .reviews-list-container.expanded {
      max-height: none;
      opacity: 1;
    }

    /* Scrollable container n·∫øu c√≥ qu√° nhi·ªÅu comments */
    .reviews-list-container.has-scroll {
      max-height: 800px;
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: 0.5rem;
    }

    .reviews-list-container.has-scroll::-webkit-scrollbar {
      width: 8px;
    }

    .reviews-list-container.has-scroll::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 10px;
    }

    .reviews-list-container.has-scroll::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #cbd5e1 0%, #94a3b8 100%);
      border-radius: 10px;
    }

    .reviews-list-container.has-scroll::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
    }

    .comment-item {
      padding: 1.75rem;
      border-bottom: 1px solid #f3f4f6;
      transition: all 0.25s ease;
      background: #fff;
      border-radius: 14px;
      margin-bottom: 1.25rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }

    .comment-item:hover {
      background: #fafbfc;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      transform: translateY(-2px);
    }

    .comment-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .comment-avatar {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.25rem;
      flex-shrink: 0;
      box-shadow: 0 2px 8px rgba(102, 126, 234, 0.25);
    }

    .comment-content {
      flex: 1;
      margin-left: 1.25rem;
    }

    .comment-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    .comment-author {
      font-weight: 700;
      font-size: 1.0625rem;
      color: #111827;
      margin-bottom: 0.25rem;
    }

    .comment-author-badge {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .admin-badge {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: #fff;
      font-size: 0.6875rem;
      font-weight: 700;
      padding: 0.3125rem 0.625rem;
      border-radius: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
    }

    .comment-meta {
      font-size: 0.8125rem;
      color: #9ca3af;
      font-weight: 500;
    }

    .comment-rating {
      display: flex;
      gap: 3px;
    }

    .comment-rating .star {
      font-size: 1.0625rem;
      color: #d1d5db;
    }

    .comment-rating .star.filled {
      color: #fbbf24;
    }

    .comment-text {
      color: #374151;
      line-height: 1.7;
      margin-bottom: 1rem;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 1rem;
      padding: 1rem 1.25rem;
      background: #f9fafb;
      border-radius: 10px;
      border-left: 3px solid #e5e7eb;
    }

    .comment-sentiment {
      display: inline-flex;
      align-items: center;
      gap: 0.625rem;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.8125rem;
      font-weight: 600;
      margin-bottom: 1rem;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .comment-sentiment.positive {
      background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
      color: #065f46;
      border: 1px solid #6ee7b7;
    }

    .comment-sentiment.negative {
      background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
      color: #991b1b;
      border: 1px solid #fca5a5;
    }

    .comment-sentiment.neutral {
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      color: #4b5563;
      border: 1px solid #d1d5db;
    }

    .comment-actions {
      display: flex;
      align-items: center;
      gap: 1.25rem;
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #f3f4f6;
    }

    .comment-action-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: transparent;
      border: none;
      color: #6b7280;
      font-size: 0.9375rem;
      font-weight: 600;
      cursor: pointer;
      padding: 0.625rem 1rem;
      border-radius: 8px;
      transition: all 0.2s ease;
    }

    .comment-action-btn:hover {
      background: #f3f4f6;
      color: #374151;
      transform: translateY(-1px);
    }

    .like-btn {
      position: relative;
    }

    .like-btn.liked {
      color: #ef4444;
    }

    .like-btn.liked:hover {
      background: #fee2e2;
    }

    .like-btn .heart-icon {
      width: 18px;
      height: 18px;
      transition: transform 0.2s ease;
      flex-shrink: 0;
    }

    .like-btn:hover .heart-icon {
      transform: scale(1.1);
    }

    .like-btn.liked .heart-icon path {
      fill: #ef4444;
      stroke: #ef4444;
    }

    .like-count {
      font-weight: 600;
      min-width: 1.5rem;
      display: inline-block;
    }

    .reply-btn {
      color: #3b82f6;
    }

    .reply-btn:hover {
      background: #eff6ff;
      color: #2563eb;
    }

    .replies-list {
      margin-top: 1.25rem;
      margin-left: 2.5rem;
      padding: 1rem 1.25rem;
      border-left: 3px solid #e5e7eb;
      background: #fafbfc;
      border-radius: 0 12px 12px 0;
    }

    .replies-list:empty {
      display: none !important;
    }

    .reply-item {
      padding: 1.25rem;
      border-bottom: 1px solid #f3f4f6;
      transition: all 0.2s ease;
      background: #fff;
      border-radius: 10px;
      margin-bottom: 0.75rem;
    }

    .reply-item:hover {
      background: #fafbfc;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      transform: translateX(4px);
    }

    .reply-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .reply-item .comment-avatar {
      width: 44px;
      height: 44px;
      font-size: 1rem;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #fff;
      box-shadow: 0 2px 6px rgba(59, 130, 246, 0.25);
    }

    .reply-item .comment-text {
      padding: 0.875rem 1rem;
      font-size: 0.9375rem;
    }

    .reply-form-container {
      margin-top: 1.25rem;
      padding: 1.5rem;
      background: #fafbfc;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .reply-form-header {
      margin-bottom: 1rem;
    }

    .reply-form-guest-name {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 0.9375rem;
      transition: all 0.2s ease;
    }

    .reply-form-guest-name:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .reply-form-input-wrapper {
      display: flex;
      gap: 1rem;
      align-items: flex-end;
    }

    .reply-form-input {
      flex: 1;
      padding: 0.875rem 1rem;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 0.9375rem;
      resize: vertical;
      min-height: 90px;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    .reply-form-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .reply-form-submit {
      padding: 0.875rem 2rem;
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-weight: 700;
      font-size: 0.9375rem;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }

    .reply-form-submit:hover {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
      transform: translateY(-1px);
    }

    .comments-empty {
      text-align: center;
      padding: 3rem 1rem;
      color: #6b7280;
    }

    .comments-empty-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .comments-empty .fw-semibold {
      font-size: 1.125rem;
      margin-bottom: 0.5rem;
    }

    @media (max-width: 768px) {
      .reviews-header-card {
        padding: 1.5rem;
        border-radius: 20px;
      }

      .reviews-stats {
        flex-direction: column;
        align-items: flex-start;
        gap: 1.5rem;
      }

      .reviews-stats-right {
        text-align: left;
        width: 100%;
      }

      .comment-item {
        padding: 1.5rem;
      }

      .comment-actions {
        flex-wrap: wrap;
      }

      .reply-form-input-wrapper {
        flex-direction: column;
      }

      .reply-form-submit {
        width: 100%;
      }

      .replies-list {
        margin-left: 1rem;
        padding-left: 1rem;
      }
    }
  </style>

  <%- include('partials/head') %>
</head>

<body>
  <%- include('partials/header') %>

  <div id="notificationModal" class="notification-modal">
    <div class="notification-modal-content">
      <span class="close-button" id="closeModal">&times;</span>
      <p id="modalMessage"></p>
    </div>
  </div>

  <main>
    <div class="mb-md-1 pb-md-3"></div>

    <!-- ================= PRODUCT MAIN ================= -->
    <section class="product-single container">
      <div class="row">
        <!-- IMAGES -->
        <div class="col-lg-7">
          <div class="product-single__media" data-media-type="vertical-thumbnail">
            <div class="product-single__image">
              <div class="swiper-container">
                <div class="swiper-wrapper" id="main-image-container">
                  <% allImages.forEach(function(imageUrl) { %>
                    <div class="swiper-slide product-single__image-item">
                      <img loading="lazy" class="h-auto" src="<%= imageUrl %>" width="674" height="674" alt="<%= product.name %>">
                      <img
                        class="category-banner__frame"
                        src="<%= product.productStatus.statusName === 'B√°n ch·∫°y'
                                ? '/mixishop/images/frame_banchay.png'
                                : (product.productStatus.statusName === 'Trending'
                                    ? '/mixishop/images/frame_trending.png'
                                    : '/mixishop/images/frame_new.png') %>"
                        alt="Status Frame">
                    </div>
                  <% }) %>
                </div>
                <div class="swiper-button-prev">
                  <svg width="7" height="11" viewBox="0 0 7 11" xmlns="http://www.w3.org/2000/svg">
                    <use href="#icon_prev_sm" />
                  </svg>
                </div>
                <div class="swiper-button-next">
                  <svg width="7" height="11" viewBox="0 0 7 11" xmlns="http://www.w3.org/2000/svg">
                    <use href="#icon_next_sm" />
                  </svg>
                </div>
              </div>
            </div>

            <div class="product-single__thumbnail">
              <div class="swiper-container">
                <div class="swiper-wrapper" id="thumbnail-image-container">
                  <% allImages.forEach(function(imageUrl) { %>
                    <div class="swiper-slide product-single__image-item">
                      <img loading="lazy" class="h-auto" src="<%= imageUrl %>" width="104" height="104" alt="<%= product.name %>">
                    </div>
                  <% }) %>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- INFO -->
        <div class="col-lg-5">
          <div class="d-flex justify-content-between mb-4 pb-md-2">
            <div class="breadcrumb mb-0 d-none d-md-block flex-grow-1">
              <a href="/" class="menu-link menu-link_us-s text-uppercase fw-medium">Trang ch·ªß</a>
              <span class="breadcrumb-separator menu-link fw-medium ps-1 pe-1">/</span>
              <a href="#" class="menu-link menu-link_us-s text-uppercase fw-medium">
                <%= product.category?.name %>
              </a>
            </div>
          </div>

          <h1 class="product-single__name"><%= product.name %></h1>

          <div class="d-flex align-items-center flex-wrap gap-3 mb-2">
            <div class="product-single__price mb-0">
              <% if (product.price_min === product.price_max) { %>
                <!-- ch·ªâ c√≥ 1 gi√° -->
                <span class="current-price">
                  <%= formatPrice(product.price_min) %>
                </span>
              <% } else { %>
                <!-- hi·ªÉn th·ªã d·∫£i gi√° -->
                <span class="current-price price-range">
                  <%= formatPrice(product.price_min) %> ‚Äì <%= formatPrice(product.price_max) %>
                </span>
              <% } %>
            </div>

            <div class="small text-muted">
              Th∆∞∆°ng hi·ªáu:
              <strong><%= product.brand?.name || 'ƒêang c·∫≠p nh·∫≠t' %></strong>
            </div>
          </div>

          <!-- rating summary -->
          <% 
            const __avg  = Number(product.avg_rating || 0);
            const __cnt  = Number(product.rating_count || 0);
            const hasRating = __cnt > 0 && __avg > 0;
          %>
          <% if (hasRating) { %>
            <div class="mb-3" id="productRatingSummary">
              <% const __rounded = Math.round(__avg); %>
              <span class="rating-summary align-middle" id="productRatingStars">
                <% for (let i = 1; i <= 5; i++) { %>
                  <i class="star <%= i <= __rounded ? 'filled' : '' %>">‚òÖ</i>
                <% } %>
              </span>
              <span class="small text-muted ms-2" id="productRatingText">
                <span id="productRatingAvg"><%= __avg.toFixed(1) %></span>/5 ‚Ä¢ <span id="productRatingCount"><%= __cnt %></span> l∆∞·ª£t ƒë√°nh gi√°
              </span>
            </div>
          <% } else { %>
            <div class="mb-3" id="productRatingSummary" style="display: none;">
              <span class="rating-summary align-middle" id="productRatingStars">
                <% for (let i = 1; i <= 5; i++) { %>
                  <i class="star">‚òÖ</i>
                <% } %>
              </span>
              <span class="small text-muted ms-2" id="productRatingText">
                <span id="productRatingAvg">0</span>/5 ‚Ä¢ <span id="productRatingCount">0</span> l∆∞·ª£t ƒë√°nh gi√°
              </span>
            </div>
          <% } %>

          <div class="product-single__short-desc">
            <p style="white-space: pre-line;"><%= product.short_description %></p>
          </div>

          <!-- ================= ADD TO CART ================= -->
          <form name="addtocart-form" method="post" action="/add-to-cart">
            <div class="product-single__swatches">
              <!-- SIZE -->
              <div class="product-swatch text-swatches">
                <label class="font-weight-bold">K√≠ch th∆∞·ªõc</label>
                <div class="swatch-list d-flex flex-wrap">
                  <% (productSizes || []).forEach(function(size, i) { %>
                    <input
                      type="radio"
                      name="size"
                      id="swatch-size-<%= i %>"
                      value="<%= size.sku %>"
                      data-size-id="<%= size.size_id %>"
                      data-size-name="<%= size.name %>"
                      class="d-none"
                      <%= i === 0 ? 'checked' : '' %>
                      onchange="updateSizeSelection(this)">
                    <label
                      class="swatch js-swatch"
                      for="swatch-size-<%= i %>"
                      aria-label="<%= size.name %>"
                      data-bs-toggle="tooltip"
                      data-bs-placement="top"
                      title="<%= size.name %>">
                      <span><%= size.name %></span>
                    </label>
                  <% }) %>
                </div>
                <a href="#" class="sizeguide-link mt-2" data-bs-toggle="modal" data-bs-target="#sizeGuide">
                  B·∫£ng k√≠ch th∆∞·ªõc
                </a>
              </div>

              <!-- COLOR -->
              <div class="product-swatch color-swatches">
                <label>M√†u</label>
                <div class="swatch-list d-flex align-items-center mt-1 custom-swatch-container">
                  <% (product.colors || []).forEach(function(productColor) { 
                       const title = productColor.color_id?.color_name || productColor.color || 'M√†u';
                       const img0 = (productColor.imageUrls && productColor.imageUrls[0]) || '';
                       const colorCode = productColor.color_code || '';
                       const styleStr = img0
                         ? `background-image:url('${img0}');background-size:cover;`
                         : (colorCode ? `background-color:${colorCode};` : '');
                  %>
                    <a
                      href="#"
                      class="swatch-color custom-swatch-color"
                      style="<%= styleStr %>"
                      data-images="<%= (productColor.imageUrls || []).join(',') %>"
                      data-value="<%= title %>"
                      data-color-id="<%= productColor.color_id?._id || '' %>"
                      title="<%= title %>"
                      onclick="updateColorSelection(this); return false;">
                    </a>
                  <% }) %>
                </div>
              </div>

              <!-- debug visual -->
              <div class="small text-muted mt-2" id="debugPick">
                ƒêang ch·ªçn:
                <strong>M√†u</strong> <span id="dbgColor">‚Äî</span> /
                <strong>Size</strong> <span id="dbgSize">‚Äî</span>
                <div id="combinationStatus" class="combination-status"></div>
              </div>

              <!-- hidden fields -->
              <input type="hidden" name="sizeName" id="sizeName" value="">
              <input type="hidden" name="colorName" id="selectedColor" value="">
              <input type="hidden" name="product_id" id="productId" value="<%= product._id %>">
              <input type="hidden" name="variant_sku" id="variantSku" value="">
              <input type="hidden" name="size_id" id="sizeId" value="">
              <input type="hidden" name="color_id" id="colorId" value="">
            </div>

            <!-- qty + button -->
            <div class="product-single__addtocart">
              <div class="qty-control position-relative">
                <input type="number" name="quantity" value="1" min="1" class="qty-control__number text-center">
                <div class="qty-control__reduce">-</div>
                <div class="qty-control__increase">+</div>
              </div>
              <button type="submit" class="btn btn-primary product-form__cart-submit" data-aside="cartDrawer">
                Th√™m v√†o gi·ªè h√†ng
              </button>
            </div>
          </form>

          <div class="product-single__addtolinks">
            <a href="#" class="menu-link menu-link_us-s add-to-wishlist">
              <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <use href="#icon_heart" />
              </svg>
              <span>Th√™m y√™u th√≠ch</span>
            </a>

            <share-button class="share-button">
              <button class="menu-link menu-link_us-s to-share border-0 bg-transparent d-flex align-items-center">
                <svg width="16" height="19" viewBox="0 0 16 19" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <use href="#icon_sharing" />
                </svg>
                <span>Chia s·∫ª</span>
              </button>
              <details id="Details-share-template__main" class="m-1 xl:m-1.5" hidden>
                <summary class="btn-solid m-1 xl:m-1.5 pt-3.5 pb-3 px-5">+</summary>
                <div
                  id="Article-share-template__main"
                  class="share-button__fallback flex items-center absolute top-full left-0 w-full px-2 py-4 bg-container shadow-theme border-t z-10">
                  <div class="field grow mr-4">
                    <label class="field__label sr-only" for="url">Link</label>
                    <input
                      type="text"
                      class="field__input w-full"
                      id="url"
                      value="https://uomo-crystal.myshopify.com/blogs/news/go-to-wellness-tips-for-mental-health"
                      placeholder="Link"
                      onclick="this.select();"
                      readonly>
                  </div>
                  <button class="share-button__copy no-js-hidden">
                    <svg
                      class="icon icon-clipboard inline-block mr-1"
                      width="11"
                      height="13"
                      fill="none"
                      xmlns="http://www.w3.org/2000/svg"
                      aria-hidden="true"
                      focusable="false"
                      viewBox="0 0 11 13">
                      <path
                        fill-rule="evenodd"
                        clip-rule="evenodd"
                        d="M2 1a1 1 0 011-1h7a1 1 0 011 1v9a1 1 0 01-1 1V1H2zM1 2a1 1 0 00-1 1v9a1 1 0 001 1h7a1 1 0 001-1V3a1 1 0 00-1-1H1zm0 10V3h7v9H1z"
                        fill="currentColor" />
                    </svg>
                    <span class="sr-only">Copy link</span>
                  </button>
                </div>
              </details>
            </share-button>

            <script src="/mixishop/js/details-disclosure.js" defer></script>
            <script src="/mixishop/js/share.js" defer></script>
          </div>

          <div class="product-single__meta-info">
            <div class="meta-item">
              <label>S·∫£n ph·∫©m: </label>
              <span><%= product.category?.name %></span>
            </div>
          </div>
        </div>
      </div>

      <!-- (ph·∫ßn tabs gi·ªØ nguy√™n n·∫øu c√≥) -->
    </section>

    <!-- ========== ƒê√ÅNH GI√Å & B√åNH LU·∫¨N ========== -->
    <section id="section-reviews" class="container pdp-section reviews-section">
      <% 
        const __ratingAvg    = Number((rating && rating.average) || product.avg_rating || 0);
        const __ratingCount  = Number((rating && rating.count) || product.rating_count || 0);
        const __ratingRounded = Math.round(__ratingAvg || 0);
      %>

      <div class="reviews-header-card">
        <div class="reviews-stats">
          <div class="reviews-stats-left">
            <h3 class="qa-title mb-2">ƒê√°nh gi√° & b√¨nh lu·∫≠n</h3>
            <p class="qa-desc mb-0">H√£y chia s·∫ª c·∫£m nh·∫≠n c·ªßa b·∫°n v·ªÅ s·∫£n ph·∫©m ƒë·ªÉ m·ªçi ng∆∞·ªùi c√πng tham kh·∫£o nh√©.</p>
          </div>
          <div class="reviews-stats-right">
            <div class="rating-large mb-2">
              <% for (let i = 1; i <= 5; i++) { %>
                <i class="star <%= i <= __ratingRounded ? 'filled' : '' %>">‚òÖ</i>
              <% } %>
            </div>
            <div class="fw-bold" style="font-size: 24px; color: #1f2937;">
              <span id="ratingAverage"><%= __ratingAvg.toFixed(1) %></span><span style="font-size: 18px; color: #6b7280;">/5</span>
            </div>
            <div id="sentimentStats" class="mt-2 small" style="color: #6b7280;">
              <% if (rating && rating.sentiment) { %>
                <div>üòä T√≠ch c·ª±c: <strong><%= rating.sentiment.positive %></strong></div>
                <div>üòê Trung t√≠nh: <strong><%= rating.sentiment.neutral %></strong></div>
                <div>üò° Ti√™u c·ª±c: <strong><%= rating.sentiment.negative %></strong></div>
                <div>‚ö™ Kh√¥ng x√°c ƒë·ªãnh: <strong><%= rating.sentiment.null %></strong></div>
              <% } %>
            </div>
            <div class="small text-muted mt-1">
              <span id="ratingCount"><%= __ratingCount %></span> l∆∞·ª£t ƒë√°nh gi√°
            </div>
          </div>
        </div>

        <!-- √î nh·∫≠p nhanh b√¨nh lu·∫≠n -->
        <div class="reviews-form-section">
          <form id="reviewForm" novalidate>
            <div class="mb-4" style="position: relative; z-index: 1;">
              <% if (!loggedInUser) { %>
                <div class="alert alert-info border-0 shadow-sm mb-0" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-left: 4px solid #3b82f6 !important; border-radius: 10px; padding: 1rem 1.25rem;">
                  <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-info-circle-fill text-primary" style="font-size: 1.25rem;"></i>
                    <span class="small mb-0" style="color: #1e40af; font-weight: 500;">
                      Kh√¥ng c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ b√¨nh lu·∫≠n. T√™n hi·ªÉn th·ªã s·∫Ω l√† <strong>"Ng∆∞·ªùi d√πng ·∫©n danh"</strong>.
                    </span>
                  </div>
                </div>
              <% } else { %>
                <div class="alert alert-success border-0 shadow-sm mb-0" style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); border-left: 4px solid #10b981 !important; border-radius: 10px; padding: 1rem 1.25rem;">
                  <div class="d-flex align-items-center gap-2">
                    <i class="bi bi-check-circle-fill text-success" style="font-size: 1.25rem;"></i>
                    <span class="small mb-0" style="color: #065f46; font-weight: 500;">
                      ƒêang ƒëƒÉng nh·∫≠p: <strong><%= (user && user.full_name) || 'T√†i kho·∫£n c·ªßa b·∫°n' %></strong>
                    </span>
                  </div>
                </div>
              <% } %>
            </div>

            <div class="mb-4" style="position: relative; z-index: 1;">
              <label for="reviewComment" class="form-label fw-semibold mb-2" style="color: #1e293b; font-size: 0.9375rem;">
                <i class="bi bi-chat-left-text me-1 text-primary"></i>
                Vi·∫øt c·∫£m nh·∫≠n c·ªßa b·∫°n
              </label>
              <textarea
                class="form-control"
                name="comment"
                id="reviewComment"
                placeholder="Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n v·ªÅ s·∫£n ph·∫©m n√†y... üí≠"
                rows="5"
                style="border: 2px solid #e2e8f0; border-radius: 12px; padding: 1rem 1.25rem; font-size: 0.9375rem; transition: all 0.3s ease; background: #ffffff; resize: vertical;"
                onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)';"
                onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='none';"></textarea>
            </div>

            <div class="d-flex flex-wrap align-items-center justify-content-between gap-3" style="position: relative; z-index: 1;">
              <div class="rating-box d-flex align-items-center gap-2">
                <span class="fw-semibold" style="color: #92400e; font-size: 0.9375rem; white-space: nowrap;">
                  <i class="bi bi-star-fill me-1" style="color: #f59e0b;"></i>
                  ƒê√°nh gi√° sao:
                </span>

                <div id="ratingStars" class="d-flex align-items-center">
                  <% for (let i = 1; i <= 5; i++) { %>
                    <i class="rate-star" data-value="<%= i %>">‚òÖ</i>
                  <% } %>
                </div>

                <% if (!loggedInUser) { %>
                  <span class="small ms-2" style="color: #92400e; font-weight: 500;">
                    <i class="bi bi-lock-fill me-1"></i>
                    C·∫ßn ƒëƒÉng nh·∫≠p
                  </span>
                <% } %>

                <input type="hidden" id="reviewRating" name="rating" value="">
              </div>

              <button type="submit" class="btn-ask">
                <i class="bi bi-send-fill"></i>
                <span>G·ª≠i ƒë√°nh gi√°</span>
              </button>
            </div>

            <div id="reviewMessage" class="small mt-2"></div>
          </form>
        </div>
      </div>

      <!-- DANH S√ÅCH B√åNH LU·∫¨N -->
      <div class="card p-4" style="background: #fff; border: 1px solid #e5e7eb; border-radius: 16px; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);">
        <div class="section-title mb-4" style="font-size: 1.5rem; font-weight: 800; color: #111827; padding-bottom: 1rem; border-bottom: 2px solid #f3f4f6;">üí¨ B√¨nh lu·∫≠n s·∫£n ph·∫©m</div>

        <!-- B·ªò L·ªåC -->
        <div class="mb-3 d-flex flex-wrap gap-2 align-items-center">
          <span class="small text-muted">L·ªçc theo:</span>
          <button class="btn btn-sm btn-outline-primary filter-btn active" data-filter="all">T·∫•t c·∫£</button>
          <button class="btn btn-sm btn-outline-primary filter-btn" data-filter="comments-only">Ch·ªâ b√¨nh lu·∫≠n</button>
          <button class="btn btn-sm btn-outline-primary filter-btn" data-filter="with-rating-comment">C√≥ sao & b√¨nh lu·∫≠n</button>
        </div>

        <!-- Toggle button ƒë·ªÉ thu g·ªçn/m·ªü r·ªông danh s√°ch b√¨nh lu·∫≠n -->
        <div class="reviews-toggle-section mb-3">
          <button 
            type="button" 
            id="toggleReviewsBtn" 
            class="btn-toggle-reviews"
            aria-expanded="true"
            aria-controls="reviewsList">
            <span class="toggle-icon">
              <i class="bi bi-chevron-up"></i>
            </span>
            <span class="toggle-text">Thu g·ªçn b√¨nh lu·∫≠n</span>
          </button>
        </div>

        <div id="reviewsList" class="reviews-list-container">
          <% if (!reviews || !reviews.length) { %>
            <div class="comments-empty">
              <div class="comments-empty-icon">üí¨</div>
              <div class="fw-semibold mb-1">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o</div>
              <div>H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n ƒë√°nh gi√° s·∫£n ph·∫©m n√†y!</div>
            </div>
          <% } else { 
                 // Separate comments and replies
                 const mainComments = reviews.filter(r => !r.parent_id);
                 const repliesMap = {};
                 reviews.forEach(r => {
                   if (r.parent_id) {
                     const parentId = String(r.parent_id);
                     if (!repliesMap[parentId]) {
                       repliesMap[parentId] = [];
                     }
                     repliesMap[parentId].push(r);
                   }
                 });
                 
                 // Sort replies by createdAt (oldest first)
                 Object.keys(repliesMap).forEach(parentId => {
                   repliesMap[parentId].sort((a, b) => {
                     const dateA = new Date(a.createdAt || 0);
                     const dateB = new Date(b.createdAt || 0);
                     return dateA - dateB;
                   });
                 });
            %>
            <% mainComments.forEach(function (r) {
                 const commentReplies = repliesMap[String(r._id)] || [];
                 const displayName  = (r.user && r.user.full_name) || r.guest_name || '·∫®n danh';
                 const isAdmin      = (r.user && r.user.role === 'admin') || (r.user && r.user.isAdmin);
                 const createdLabel = r.createdAt ? new Date(r.createdAt).toLocaleString('vi-VN') : '';
                 const rRating      = Number(r.rating || 0);
                 const rRounded     = Math.round(rRating || 0);
                 const likeCount    = Number(r.likes_count || r.likes?.length || 0);
                 const isLiked      = r.is_liked || false;

                 const sentiment    = r.sentiment || null;
                 const score        = (typeof r.sentiment_score === 'number') ? r.sentiment_score : null;
                 const aiLabel      = r.ai_label || null;

                 let sentimentText  = '';
                 let sentimentClass = '';

                 if (sentiment === 'positive') {
                   sentimentText  = 'T√≠ch c·ª±c';
                   sentimentClass = 'positive';
                 } else if (sentiment === 'negative') {
                   sentimentText  = 'Ti√™u c·ª±c';
                   sentimentClass = 'negative';
                 } else if (sentiment === 'neutral') {
                   sentimentText  = 'Trung t√≠nh';
                   sentimentClass = 'neutral';
                 }

                 let aiLabelText = '';
                 if (aiLabel === 'happy')    aiLabelText = 'Kh√°ch h√†i l√≤ng';
                 if (aiLabel === 'complain') aiLabelText = 'Kh√°ch ph√†n n√†n';
                 if (aiLabel === 'urgent')   aiLabelText = 'C·∫ßn h·ªó tr·ª£ g·∫•p';

                 let starsHtml = '';
                 if (rRating) {
                   for (let i = 1; i <= 5; i++) {
                     starsHtml += `<i class="star ${i <= rRounded ? 'filled' : ''}">‚òÖ</i>`;
                   }
                 }

                 const authorName = isAdmin ? 'Qu·∫£n Tr·ªã Vi√™n' : displayName;
                 const safeComment = r.comment || '';
                 const safeDate = createdLabel;
            %>
              <div class="comment-item" 
                   data-id="<%= r._id %>"
                   data-has-rating="<%= rRating ? 'true' : 'false' %>"
                   data-has-comment="<%= safeComment ? 'true' : 'false' %>">
                <div class="d-flex">
                  <div class="comment-avatar">
                    <%= (displayName || '·∫®n danh').charAt(0).toUpperCase() %>
                  </div>
                  <div class="comment-content">
                    <div class="comment-header">
                      <div>
                        <div class="comment-author-badge">
                          <span class="comment-author"><%= authorName %></span>
                          <% if (isAdmin) { %>
                            <span class="admin-badge">QTV</span>
                          <% } %>
                        </div>
                        <div class="comment-meta"><%= safeDate %></div>
                      </div>
                      <% if (rRating) { %>
                        <div class="comment-rating rating-small"><%- starsHtml %></div>
                      <% } %>
                    </div>
                    <div class="comment-text"><%= safeComment %></div>
                    
                    <% if (sentimentText || score !== null || aiLabelText) { %>
                      <div class="comment-sentiment <%= sentimentClass %>">
                        <span>C·∫£m x√∫c AI:</span>
                        <% if (sentimentText) { %>
                          <span><%= sentimentText %></span>
                        <% } %>
                        <% if (score !== null) { %>
                          <span>‚Ä¢ ƒêi·ªÉm: <%= score.toFixed(2) %></span>
                        <% } %>
                        <% if (aiLabelText) { %>
                          <span>‚Ä¢ <%= aiLabelText %></span>
                        <% } %>
                      </div>
                    <% } %>
                    <div class="comment-actions">
                      <button 
                        class="comment-action-btn like-btn <%= isLiked ? 'liked' : '' %>" 
                        data-comment-id="<%= r._id %>"
                        title="Th·∫£ tim">
                    <svg class="heart-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    </svg>
                        <span class="like-count" data-count="<%= likeCount %>"><%= likeCount > 0 ? likeCount : '' %></span>
                        <span>Th√≠ch</span>
                      </button>
                      <button 
                        class="comment-action-btn reply-btn" 
                        data-comment-id="<%= r._id %>"
                        onclick="toggleReplyForm('<%= r._id %>'); return false;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M3 10h10a8 8 0 0 1 8 8v2M3 10l6 6m-6-6l6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Ph·∫£n h·ªìi
                      </button>
                    </div>
                    <div class="replies-list" id="replies-<%= r._id %>" <%= commentReplies.length > 0 ? '' : 'style="display: none;"' %>>
                      <% if (commentReplies.length > 0) { %>
                        <% commentReplies.forEach(function (reply) {
                             const replyName = (reply.user && reply.user.full_name) || reply.guest_name || '·∫®n danh';
                             const replyIsAdmin = (reply.user && reply.user.role === 'admin') || (reply.user && reply.user.isAdmin);
                             const replyDate = reply.createdAt ? new Date(reply.createdAt).toLocaleString('vi-VN') : '';
                             const replyLikeCount = Number(reply.likes_count || reply.likes?.length || 0);
                             const replyIsLiked = reply.is_liked || false;
                             
                             // Sentiment data
                             const replySentiment = reply.sentiment || null;
                             const replyScore = (typeof reply.sentiment_score === 'number') ? reply.sentiment_score : null;
                             const replyAiLabel = reply.ai_label || null;
                             
                             let replySentimentText = '';
                             let replySentimentClass = '';
                             
                             if (replySentiment === 'positive') {
                               replySentimentText = 'T√≠ch c·ª±c';
                               replySentimentClass = 'positive';
                             } else if (replySentiment === 'negative') {
                               replySentimentText = 'Ti√™u c·ª±c';
                               replySentimentClass = 'negative';
                             } else if (replySentiment === 'neutral') {
                               replySentimentText = 'Trung t√≠nh';
                               replySentimentClass = 'neutral';
                             }
                             
                             let replyAiLabelText = '';
                             if (replyAiLabel === 'happy') replyAiLabelText = 'Kh√°ch h√†i l√≤ng';
                             if (replyAiLabel === 'complain') replyAiLabelText = 'Kh√°ch ph√†n n√†n';
                             if (replyAiLabel === 'urgent') replyAiLabelText = 'C·∫ßn h·ªó tr·ª£ g·∫•p';
                        %>
                          <div class="reply-item" data-reply-id="<%= reply._id %>">
                            <div class="d-flex">
                              <div class="comment-avatar">
                                <%= (replyName || '·∫®n danh').charAt(0).toUpperCase() %>
                              </div>
                              <div class="comment-content">
                                <div class="comment-header">
                                  <div>
                                    <div class="comment-author-badge">
                                      <span class="comment-author">
                                        <%= replyIsAdmin ? 'Qu·∫£n Tr·ªã Vi√™n' : replyName %>
                                      </span>
                                      <% if (replyIsAdmin) { %>
                                        <span class="admin-badge">QTV</span>
                                      <% } %>
                                    </div>
                                    <div class="comment-meta"><%= replyDate %></div>
                                  </div>
                                </div>
                                <div class="comment-text" style="padding: 0.875rem 1rem; font-size: 0.9375rem;"><%= reply.comment %></div>
                                <% if (replySentimentText || replyScore !== null || replyAiLabelText) { %>
                                  <div class="comment-sentiment <%= replySentimentClass %>">
                                    <span>C·∫£m x√∫c AI:</span>
                                    <% if (replySentimentText) { %>
                                      <span><%= replySentimentText %></span>
                                    <% } %>
                                    <% if (replyScore !== null) { %>
                                      <span>‚Ä¢ ƒêi·ªÉm: <%= replyScore.toFixed(2) %></span>
                                    <% } %>
                                    <% if (replyAiLabelText) { %>
                                      <span>‚Ä¢ <%= replyAiLabelText %></span>
                                    <% } %>
                                  </div>
                                <% } %>
                                <div class="comment-actions" style="margin-top: 0.75rem; padding-top: 0.75rem;">
                                  <button 
                                    class="comment-action-btn like-btn <%= replyIsLiked ? 'liked' : '' %>" 
                                    data-comment-id="<%= reply._id %>"
                                    title="Th·∫£ tim">
                                    <svg class="heart-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                                    </svg>
                                    <span class="like-count" data-count="<%= replyLikeCount %>"><%= replyLikeCount > 0 ? replyLikeCount : '' %></span>
                                    <span>Th√≠ch</span>
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                        <% }) %>
                      <% } %>
                    </div>
                    <div class="reply-form-container" id="reply-form-<%= r._id %>" style="display: none;">
                      <form class="reply-form" data-parent-id="<%= r._id %>">
                        <div class="reply-form-input-wrapper">
                          <textarea 
                            class="reply-form-input" 
                            name="comment" 
                            placeholder="Vi·∫øt ph·∫£n h·ªìi..." 
                            required></textarea>
                          <button type="submit" class="reply-form-submit">G·ª≠i</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            <% }) %>
          <% } %>
        </div>
      </div>
    </section>

    <!-- ================= RELATED PRODUCTS ================= -->
    <section id="section-related" class="related-products-section" style="margin-top: 4rem; margin-bottom: 3rem;">
      <div class="container">
        <div class="related-products-header mb-4">
          <h2 class="related-products-title" style="font-size: 2rem; font-weight: 800; color: #111827; margin-bottom: 0.5rem; position: relative; padding-bottom: 1rem;">
            <span style="color: #e8071b;">‚ú®</span> S·∫£n ph·∫©m li√™n quan
            <div style="position: absolute; bottom: 0; left: 0; width: 80px; height: 4px; background: linear-gradient(90deg, #e8071b, #ff6b6b); border-radius: 2px;"></div>
          </h2>
          <p class="text-muted" style="font-size: 1rem; color: #6b7280;">
            Kh√°m ph√° th√™m c√°c s·∫£n ph·∫©m t∆∞∆°ng t·ª± trong danh m·ª•c <strong><%= product?.category?.name || 'n√†y' %></strong>
          </p>
        </div>

        <div id="related_products" class="position-relative">
          <div
            class="swiper-container js-swiper-slider"
            data-settings='{
              "autoplay": {
                "delay": 3000,
                "disableOnInteraction": false
              },
              "slidesPerView": 4,
              "slidesPerGroup": 4,
              "effect": "slide",
              "loop": true,
              "speed": 600,
              "pagination": {
                "el": "#related_products .products-pagination",
                "type": "bullets",
                "clickable": true
              },
              "navigation": {
                "nextEl": "#related_products .products-carousel__next",
                "prevEl": "#related_products .products-carousel__prev"
              },
              "breakpoints": {
                "320":  { "slidesPerView": 1, "slidesPerGroup": 1, "spaceBetween": 16 },
                "576":  { "slidesPerView": 2, "slidesPerGroup": 2, "spaceBetween": 20 },
                "768":  { "slidesPerView": 3, "slidesPerGroup": 3, "spaceBetween": 24 },
                "992":  { "slidesPerView": 4, "slidesPerGroup": 4, "spaceBetween": 30 }
              }
            }'>
            <div class="swiper-wrapper">
              <% (products || []).slice(0, Math.min((products || []).length, 12)).forEach(function(item){ 
                   const discountPercent = Math.round(((Number(item.price) + 100000 - Number(item.price)) / (Number(item.price) + 100000)) * 100);
                   const hasDiscount = discountPercent > 0;
              %>
                <div class="swiper-slide">
                  <div class="related-product-card" style="background: #fff; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: all 0.3s ease; height: 100%; display: flex; flex-direction: column; position: relative;">
                    <!-- Discount Badge -->
                    <% if (hasDiscount) { %>
                      <div class="discount-badge" style="position: absolute; top: 12px; left: 12px; background: linear-gradient(135deg, #e8071b, #ff6b6b); color: #fff; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; z-index: 10; box-shadow: 0 2px 8px rgba(232, 7, 27, 0.3);">
                        -<%= discountPercent %>%
                      </div>
                    <% } %>

                    <!-- Status Badge -->
                    <% 
                      const st = item.productStatus?.statusName;
                      if (st) {
                        const statusConfig = {
                          'B√°n ch·∫°y': { bg: '#10b981', text: 'üî• B√°n ch·∫°y', icon: 'üî•' },
                          'Trending': { bg: '#3b82f6', text: '‚≠ê Trending', icon: '‚≠ê' },
                          'M·ªõi': { bg: '#f59e0b', text: '‚ú® M·ªõi', icon: '‚ú®' }
                        };
                        const config = statusConfig[st] || { bg: '#6b7280', text: st, icon: '' };
                    %>
                      <div class="status-badge" style="position: absolute; top: 12px; right: 12px; background: <%= config.bg %>; color: #fff; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                        <%= config.text %>
                      </div>
                    <% } %>

                    <!-- Product Image -->
                    <div class="related-product-image" style="position: relative; padding-top: 100%; overflow: hidden; background: #f9fafb;">
                      <a href="/product_detail/<%= item.id || item._id %>" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: block;">
                        <img
                          loading="lazy"
                          src="<%= (item.colors?.[0]?.imageUrls?.[0]) || '/images/default.png' %>"
                          alt="<%= item.name %>"
                          class="related-product-img-main"
                          style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; transition: transform 0.4s ease;">
                        <img
                          loading="lazy"
                          src="<%= (item.colors?.[0]?.imageUrls?.[1]) || (item.colors?.[0]?.imageUrls?.[0]) || '/images/default.png' %>"
                          alt="<%= item.name %>"
                          class="related-product-img-hover"
                          style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.4s ease;">
                      </a>
                      
                      <!-- Quick Actions -->
                      <div class="related-product-actions" style="position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%) translateY(10px); opacity: 0; transition: all 0.3s ease; display: flex; gap: 8px; z-index: 5;">
                        <button
                          class="related-action-btn"
                          style="width: 40px; height: 40px; border-radius: 50%; background: #fff; border: none; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.15); cursor: pointer; transition: all 0.2s ease;"
                          data-aside="cartDrawer"
                          title="Th√™m v√†o gi·ªè h√†ng"
                          onclick="event.preventDefault(); document.querySelector('[data-product-id=\'<%= item.id || item._id %>\']')?.click();">
                          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #111827;">
                            <circle cx="9" cy="21" r="1"></circle>
                            <circle cx="20" cy="21" r="1"></circle>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                          </svg>
                        </button>
                        <a
                          href="/product_detail/<%= item.id || item._id %>"
                          class="related-action-btn"
                          style="width: 40px; height: 40px; border-radius: 50%; background: #fff; border: none; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.15); cursor: pointer; transition: all 0.2s ease; text-decoration: none;"
                          title="Xem chi ti·∫øt">
                          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #111827;">
                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                          </svg>
                        </a>
                        <button
                          class="related-action-btn js-add-wishlist"
                          style="width: 40px; height: 40px; border-radius: 50%; background: #fff; border: none; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.15); cursor: pointer; transition: all 0.2s ease;"
                          title="Th√™m y√™u th√≠ch"
                          data-product="<%= item.id || item._id %>">
                          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #111827;">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                          </svg>
                        </button>
                      </div>
                    </div>

                    <!-- Product Info -->
                    <div class="related-product-info" style="padding: 1.25rem; flex: 1; display: flex; flex-direction: column;">
                      <!-- Color Swatches -->
                      <% if (item.colors && item.colors.length > 0) { %>
                        <div class="related-product-colors mb-2" style="display: flex; gap: 6px; flex-wrap: wrap;">
                          <% item.colors.slice(0, 5).forEach(function(productColor){ 
                               const img0 = (productColor.imageUrls && productColor.imageUrls[0]) || '';
                               const title = productColor.color_id?.color_name || productColor.color || 'M√†u';
                          %>
                            <span
                              class="related-color-swatch"
                              style="width: 24px; height: 24px; border-radius: 50%; border: 2px solid #e5e7eb; background-image: url('<%= img0 %>'); background-size: cover; background-position: center; cursor: pointer; transition: transform 0.2s ease;"
                              title="<%= title %>"
                              onmouseover="this.style.transform='scale(1.15)'; this.style.borderColor='#111827';"
                              onmouseout="this.style.transform='scale(1)'; this.style.borderColor='#e5e7eb';">
                            </span>
                          <% }) %>
                          <% if (item.colors.length > 5) { %>
                            <span style="width: 24px; height: 24px; border-radius: 50%; border: 2px solid #e5e7eb; background: #f3f4f6; display: flex; align-items: center; justify-content: center; font-size: 0.65rem; color: #6b7280; font-weight: 600;">
                              +<%= item.colors.length - 5 %>
                            </span>
                          <% } %>
                        </div>
                      <% } %>

                      <!-- Product Name -->
                      <h3 class="related-product-name" style="margin: 0 0 0.75rem 0; font-size: 1rem; font-weight: 600; line-height: 1.4; color: #111827;">
                        <a href="/product_detail/<%= item.id || item._id %>" style="color: inherit; text-decoration: none; transition: color 0.2s ease;" onmouseover="this.style.color='#e8071b';" onmouseout="this.style.color='#111827';">
                          <%= item.name %>
                        </a>
                      </h3>

                      <!-- Product Price -->
                      <div class="related-product-price" style="margin-top: auto;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap;">
                          <span class="related-price-current" style="font-size: 1.25rem; font-weight: 700; color: #e8071b;">
                            <%= formatPrice(item.price) %>
                          </span>
                          <% if (hasDiscount) { %>
                            <span class="related-price-old" style="font-size: 0.875rem; color: #9ca3af; text-decoration: line-through;">
                              <%= formatPrice((Number(item.price) || 0) + 100000) %>
                            </span>
                          <% } %>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              <% }) %>
            </div>
          </div>

          <!-- Navigation Arrows -->
          <div class="products-carousel__prev related-nav-prev" style="position: absolute; left: -50px; top: 50%; transform: translateY(-50%); width: 48px; height: 48px; border-radius: 50%; background: #fff; box-shadow: 0 2px 12px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; transition: all 0.3s ease;" onmouseover="this.style.background='#e8071b'; this.querySelector('svg').style.color='#fff';" onmouseout="this.style.background='#fff'; this.querySelector('svg').style.color='#111827';">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #111827; transition: color 0.3s ease;">
              <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
          </div>
          <div class="products-carousel__next related-nav-next" style="position: absolute; right: -50px; top: 50%; transform: translateY(-50%); width: 48px; height: 48px; border-radius: 50%; background: #fff; box-shadow: 0 2px 12px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; transition: all 0.3s ease;" onmouseover="this.style.background='#e8071b'; this.querySelector('svg').style.color='#fff';" onmouseout="this.style.background='#fff'; this.querySelector('svg').style.color='#111827';">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #111827; transition: color 0.3s ease;">
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </div>

          <!-- Pagination -->
          <div class="products-pagination mt-4 mb-2 d-flex align-items-center justify-content-center"></div>
        </div>
      </div>
    </section>

    <style>
      .related-products-section {
        background: linear-gradient(to bottom, #fafafa, #fff);
        padding: 3rem 0;
      }

      .related-product-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.12) !important;
      }

      .related-product-card:hover .related-product-img-main {
        transform: scale(1.05);
      }

      .related-product-card:hover .related-product-img-hover {
        opacity: 1;
      }

      .related-product-card:hover .related-product-actions {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      .related-action-btn:hover {
        background: #e8071b !important;
        transform: scale(1.1);
      }

      .related-action-btn:hover svg {
        color: #fff !important;
      }

      @media (max-width: 1200px) {
        .related-nav-prev {
          left: -30px !important;
        }
        .related-nav-next {
          right: -30px !important;
        }
      }

      @media (max-width: 992px) {
        .related-nav-prev,
        .related-nav-next {
          display: none !important;
        }
      }

      @media (max-width: 576px) {
        .related-products-title {
          font-size: 1.5rem !important;
        }
        .related-product-info {
          padding: 1rem !important;
        }
      }
    </style>
  </main>

  <div class="mb-5 pb-xl-5"></div>

  <div class="aside-filters aside aside_right" id="shopFilter"></div>

  <%- include('partials/footer') %>
  <%- include('partials/icons') %>
  <%- include('partials/login_form') %>
  <%- include('partials/cart_drawer') %>
  <%- include('partials/quick_view') %>
  <%- include('partials/sitemap') %>

  <div id="scrollTop" class="visually-hidden end-0"></div>

  <!-- Sizeguide modal -->
  <div class="modal fade" id="sizeGuide" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog size-guide">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">B·∫£ng k√≠ch th∆∞·ªõc</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="size-guide__wrapper">
            <div class="size-guide__image">
              <img loading="lazy" src="/mixishop/images/checksize.png" alt="">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="page-overlay"></div>

  <!-- libs -->
  <script src="/mixishop/js/plugins/jquery.min.js"></script>
  <script src="/mixishop/js/plugins/bootstrap.bundle.min.js"></script>
  <script src="/mixishop/js/plugins/bootstrap-slider.min.js"></script>
  <script src="/mixishop/js/plugins/swiper.min.js"></script>
  <script src="/mixishop/js/plugins/countdown.js"></script>
  <script src="/mixishop/js/plugins/jquery.fancybox.js"></script>
  <script src="/mixishop/js/theme.js"></script>
  <script src="/socket.io/socket.io.js"></script>

  <!-- expose variants cho FE -->
  <script>
    // Matrix "<sizeId>:<colorId>" -> sku
    window.__VAR_MATRIX = <%- JSON.stringify(
      typeof variantMatrix !== 'undefined' ? variantMatrix : {}
    ) %>;

    // Danh s√°ch variant ƒë∆°n gi·∫£n: { size, color, sku }
    window.__VARIANTS = <%- JSON.stringify(
      (typeof variants !== 'undefined' ? variants : []).map(v => ({
        size:  v.size  && v.size._id  ? String(v.size._id)  : String(v.size),
        color: v.color && v.color._id ? String(v.color._id) : String(v.color),
        sku:   v.sku || '',
        price: v.price || 0,
        stock_quantity: v.stock_quantity || 0
      }))
    ) %>;
  </script>

  <script>
    // ========= COMMON UTILS =========
    const AppUtils = {
      qs(sel, ctx)  { return (ctx || document).querySelector(sel); },
      qsa(sel, ctx) { return Array.from((ctx || document).querySelectorAll(sel)); },
      escapeHtml(s) {
        return (s || '').replace(/[&<>"']/g, m => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#039;'
        }[m]));
      }
    };

    function _paintDebug() {
      const dbgColor = document.getElementById('dbgColor');
      const dbgSize  = document.getElementById('dbgSize');
      const colorVal = document.getElementById('selectedColor')?.value || '';
      const sizeVal  = document.getElementById('sizeName')?.value || '';
      if (dbgColor) dbgColor.textContent = colorVal || '‚Äî';
      if (dbgSize)  dbgSize.textContent  = sizeVal  || '‚Äî';
    }

    const GLOBAL_SOCKET = window.io ? io() : null;

    // ========= RENDER CART DRAWER T·ª™ JSON CARTS =========
    function renderCartDrawerFromCarts(carts, total, formattedTotal) {
      const listEl = document.querySelector('#cartDrawer .js-mini-cart-list');
      if (!listEl) return;

      const fmt = (n) => (Number(n || 0)).toLocaleString('vi-VN') + 'ƒë';

      if (!Array.isArray(carts) || !carts.length) {
        listEl.innerHTML = `
          <div class="empty">
            <div class="mb-2" style="font-size:40px; line-height:1;">üõçÔ∏è</div>
            <div class="fw-semibold mb-1">Gi·ªè h√†ng tr·ªëng</div>
            <div class="small">Ti·∫øp t·ª•c mua s·∫Øm ƒë·ªÉ t√¨m m√≥n b·∫°n th√≠ch nh√©!</div>
          </div>
        `;
      } else {
        listEl.innerHTML = carts.map((it, idx) => {
          const name  = AppUtils.escapeHtml(it.name_snapshot || 'S·∫£n ph·∫©m');
          const color = AppUtils.escapeHtml(it.color_name_snapshot || '‚Äî');
          const size  = AppUtils.escapeHtml(it.size_name_snapshot || '‚Äî');
          const img   = AppUtils.escapeHtml(it.img_snapshot || '/images/default.png');
          const qty   = Number(it.quantity || 1);
          const unit  = Number(it.price_at_time || 0);
          const line  = unit * qty;
          const pid   = it.product_id || it.productId || '';
          const url   = pid ? `/product_detail/${pid}` : '#';

          return `
            <div class="cdi position-relative" id="cdr-item-${idx}">
              <a class="cdi-thumb" href="${url}" aria-label="${name}">
                <img loading="lazy" src="${img}" alt="${name}">
              </a>

              <div class="flex-grow-1">
                <h6 class="cdi-ttl"><a href="${url}">${name}</a></h6>

                <div class="cdi-meta">
                  <span>M√†u: <b>${color}</b></span>
                  <span>Size: <b>${size}</b></span>
                </div>

                <div class="cdi-row">
                  <div class="cdi-qty">
                    <button type="button" class="js-cdr-dec" data-idx="${idx}">‚àí</button>
                    <input id="cdr-qty-${idx}" type="number" min="1" value="${qty}">
                    <button type="button" class="js-cdr-inc" data-idx="${idx}">+</button>
                  </div>

                  <div class="cdi-unit">ƒê∆°n gi√°: <b>${fmt(unit)}</b></div>
                </div>

                <div class="cdi-total">
                  <span class="label">T·ªïng gi√°</span>
                  <div class="price" id="cdr-line-${idx}">${fmt(line)}</div>
                </div>
              </div>

              <button
                class="cdi-remove js-cdr-remove"
                title="Xo√° s·∫£n ph·∫©m n√†y"
                aria-label="Xo√°"
                data-idx="${idx}">&times;</button>
            </div>
          `;
        }).join('');
      }

      // C·∫≠p nh·∫≠t t·ªïng gi√° ·ªü footer drawer
      const subtotalEl = document.getElementById('cdr-subtotal');
      if (subtotalEl) {
        subtotalEl.textContent = formattedTotal || fmt(total || 0);
      }

      // Badge s·ªë l∆∞·ª£ng trong header drawer
      const badgeDrawer = document.querySelector('#cartDrawer .js-cart-items-count');
      if (badgeDrawer) {
        badgeDrawer.textContent = Array.isArray(carts) ? carts.length : 0;
      }
    }
  </script>

  <!-- ========== COLOR / SIZE / SKU + CART & UI ========== -->
  <script>
    (function () {
      const VARIANTS  = window.__VARIANTS || [];
      const productId = '<%= product._id %>';
      const socket    = GLOBAL_SOCKET;

      function resolveVariant(sizeId, colorId) {
        if (!sizeId || !colorId) return null;
        return VARIANTS.find(v => v.size === sizeId && v.color === colorId) || null;
      }

      function formatCurrencyVND(value) {
        if (!value && value !== 0) return '';
        return value.toLocaleString('vi-VN') + '‚Ç´';
      }

      function changeColorImage(swatch) {
        const dataImages = swatch.getAttribute('data-images');
        const images = dataImages ? dataImages.split(',') : [];
        if (!images.length) return;

        const mainSwiper  = document.querySelector('.product-single__image .swiper-container')?.swiper;
        const thumbSwiper = document.querySelector('.product-single__thumbnail .swiper-container')?.swiper;
        const firstImage  = images[0];

        const slides = document.querySelectorAll('.product-single__image-item img');
        const targetIndex = Array.from(slides).findIndex(slide => slide.getAttribute('src') === firstImage);

        if (targetIndex !== -1 && mainSwiper && thumbSwiper) {
          mainSwiper.slideTo(targetIndex);
          thumbSwiper.slideTo(targetIndex);
        }
      }

      // public handler: ch·ªçn size
      window.updateSizeSelection = function (radio) {
        const sizeId   = radio.getAttribute('data-size-id')   || '';
        const sizeName = radio.getAttribute('data-size-name') || '';

        document.getElementById('sizeId').value   = sizeId;
        document.getElementById('sizeName').value = sizeName;

        recomputeSku();
        _paintDebug();
      };

      // public handler: ch·ªçn m√†u
      window.updateColorSelection = function (colorElement) {
        const colorName = colorElement.getAttribute('data-value')    || '';
        const colorId   = colorElement.getAttribute('data-color-id') || '';

        document.getElementById('selectedColor').value = colorName;
        document.getElementById('colorId').value       = colorId;

        document.querySelectorAll('.swatch-color').forEach(c => c.classList.remove('swatch_active'));
        colorElement.classList.add('swatch_active');

        changeColorImage(colorElement);
        recomputeSku();
        _paintDebug();
      };

      function recomputeSku() {
        const sizeId  = document.getElementById('sizeId')?.value || '';
        const colorId = document.getElementById('colorId')?.value || '';

        const skuEl    = document.getElementById('variantSku');
        const statusEl = document.getElementById('combinationStatus');
        const addBtn   = document.querySelector('.btn.btn-primary[data-aside="cartDrawer"]');
        const priceEl  = document.querySelector('.product-single__price .current-price');

        const variant = resolveVariant(sizeId, colorId);

        if (skuEl) {
          skuEl.value = variant ? (variant.sku || '') : '';
        }

        if (statusEl) statusEl.classList.remove('ok', 'error');

        // c·∫≠p nh·∫≠t gi√°
        if (priceEl) {
          if (variant && typeof variant.price === 'number') {
            priceEl.textContent = formatCurrencyVND(variant.price);
          } else {
            const baseText = priceEl.getAttribute('data-base-price-text');
            if (baseText) priceEl.textContent = baseText;
          }
        }

        if (addBtn) {
          addBtn.disabled = true;
          addBtn.textContent = 'H·∫øt h√†ng';
        }

        if (!sizeId || !colorId) {
          if (statusEl) statusEl.textContent = '';
          if (addBtn) {
            addBtn.disabled = true;
            addBtn.textContent = 'Ch·ªçn t√πy ch·ªçn';
          }
          return;
        }

        if (!variant) {
          if (statusEl) {
            statusEl.textContent = 'Phi√™n b·∫£n n√†y kh√¥ng t·ªìn t·∫°i.';
            statusEl.classList.add('error');
          }
          if (addBtn) {
            addBtn.disabled = true;
            addBtn.textContent = 'Kh√¥ng kh·∫£ d·ª•ng';
          }
          return;
        }

        const stockQty = Number(variant.stock_quantity || 0);

        if (stockQty > 0) {
          if (statusEl) {
            statusEl.textContent = `Phi√™n b·∫£n n√†y ƒëang c√≤n h√†ng (${stockQty} s·∫£n ph·∫©m).`;
            statusEl.classList.add('ok');
          }
          if (addBtn) {
            addBtn.disabled = false;
            addBtn.textContent = 'Th√™m v√†o gi·ªè';
          }
        } else {
          if (statusEl) {
            statusEl.textContent = 'Phi√™n b·∫£n n√†y hi·ªán ƒë√£ h·∫øt h√†ng.';
            statusEl.classList.add('error');
          }
          if (addBtn) {
            addBtn.disabled = true;
            addBtn.textContent = 'H·∫øt h√†ng';
          }
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        // reset ch·ªçn ban ƒë·∫ßu
        document.getElementById('sizeId').value       = '';
        document.getElementById('sizeName').value     = '';
        document.getElementById('colorId').value      = '';
        document.getElementById('selectedColor').value = '';
        _paintDebug();

        // ===== ADD TO CART (AJAX) =====
        const form =
          document.forms['addtocart-form'] ||
          document.querySelector('form[name="addtocart-form"]');

        if (form) {
          form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const sizeId    = document.getElementById('sizeId')?.value;
            const colorId   = document.getElementById('colorId')?.value;
            const variantSku = document.getElementById('variantSku')?.value;

            if (!sizeId || !colorId) {
              alert('Vui l√≤ng ch·ªçn ƒë·ªß Size v√† M√†u.');
              return;
            }
            if (!variantSku) {
              alert('Kh√¥ng t√¨m th·∫•y phi√™n b·∫£n t∆∞∆°ng ·ª©ng Size/M√†u. Vui l√≤ng ch·ªçn l·∫°i.');
              return;
            }

            try {
              const fd   = new FormData(form);
              const body = new URLSearchParams();
              for (const [k, v] of fd.entries()) body.append(k, v);

              const res = await fetch(form.action, {
                method: 'POST',
                body: body.toString(),
                headers: {
                  'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
                  'X-Requested-With': 'XMLHttpRequest'
                }
              });

              const data = await res.json().catch(() => ({}));
              if (!res.ok || !data.ok) {
                alert(data.message || 'Th√™m v√†o gi·ªè h√†ng th·∫•t b·∫°i, vui l√≤ng th·ª≠ l·∫°i.');
                return;
              }

              // c·∫≠p nh·∫≠t badge icon cart (tr√™n header)
              if (typeof data.cartCount !== 'undefined') {
                const cartCountEl = document.querySelector('.js-cart-count');
                if (cartCountEl) cartCountEl.textContent = data.cartCount;
              }

              // c·∫≠p nh·∫≠t cart drawer
              if (Array.isArray(data.carts)) {
                renderCartDrawerFromCarts(data.carts, data.total, data.formattedTotal);
              }

              // m·ªü cart drawer
              const trigger = document.querySelector('[data-aside="cartDrawer"]');
              if (trigger) trigger.click();
            } catch (err) {
              console.error(err);
              alert('C√≥ l·ªói k·∫øt n·ªëi, vui l√≤ng th·ª≠ l·∫°i.');
            }
          });
        }

        // qty +/- ·ªü PDP
        (function () {
          const decBtn  = document.querySelector('.qty-control__reduce');
          const incBtn  = document.querySelector('.qty-control__increase');
          const qtyInput = document.querySelector('.qty-control__number');
          if (!decBtn || !incBtn || !qtyInput) return;

          decBtn.addEventListener('click', () => {
            const v = parseInt(qtyInput.value || '1', 10);
            if (v > 1) qtyInput.value = v - 1;
          });

          incBtn.addEventListener('click', () => {
            const v = parseInt(qtyInput.value || '1', 10);
            qtyInput.value = v + 1;
          });
        })();
      });
    })();
  </script>

  <script>
    (function () {
      const socket      = GLOBAL_SOCKET || null;
      const productId   = '<%= product._id %>';
      const isLoggedIn  = <%= loggedInUser ? 'true' : 'false' %>;
      const apiUrl      = '/api/product/<%= product._id %>/reviews';

      const reviewListEl   = document.getElementById('reviewsList');
      const ratingAvgEl    = document.getElementById('ratingAverage');
      const ratingCountEl  = document.getElementById('ratingCount');
      const ratingMessage  = document.getElementById('reviewMessage');

      // v·∫Ω l·∫°i sao trung b√¨nh (ph·∫ßn reviews section)
      function repaintAverageStars(avg) {
        const container = document.querySelector('.rating-large');
        if (!container) return;
        const rounded = Math.round(avg || 0);
        container.innerHTML = '';
        for (let i = 1; i <= 5; i++) {
          const iEl = document.createElement('i');
          iEl.className = 'star' + (i <= rounded ? ' filled' : '');
          iEl.textContent = '‚òÖ';
          container.appendChild(iEl);
        }
      }

      // C·∫≠p nh·∫≠t rating ·ªü ph·∫ßn product info (ph·∫ßn tr√™n c√πng)
      function updateProductInfoRating(avg, count) {
        const productRatingSummary = document.getElementById('productRatingSummary');
        const productRatingAvg = document.getElementById('productRatingAvg');
        const productRatingCount = document.getElementById('productRatingCount');
        const productRatingStars = document.getElementById('productRatingStars');
        
        // Ch·ªâ hi·ªÉn th·ªã n·∫øu c√≥ rating (count > 0 v√† avg > 0)
        const hasRating = count > 0 && avg > 0;
        
        if (productRatingSummary) {
          productRatingSummary.style.display = hasRating ? 'block' : 'none';
        }
        
        if (productRatingAvg) {
          productRatingAvg.textContent = Number(avg || 0).toFixed(1);
        }
        
        if (productRatingCount) {
          productRatingCount.textContent = count || 0;
        }
        
        if (productRatingStars) {
          const rounded = Math.round(avg || 0);
          productRatingStars.innerHTML = '';
          for (let i = 1; i <= 5; i++) {
            const iEl = document.createElement('i');
            iEl.className = 'star' + (i <= rounded ? ' filled' : '');
            iEl.textContent = '‚òÖ';
            productRatingStars.appendChild(iEl);
          }
        }
      }

      // render 1 item review -> HTML string
      function buildReviewHtml(r) {
        const displayName  = (r.user && r.user.full_name) || r.guest_name || '·∫®n danh';
        const isAdmin      = (r.user && r.user.role === 'admin') || (r.user && r.user.isAdmin);
        const createdLabel = r.createdAt ? new Date(r.createdAt).toLocaleString('vi-VN') : '';
        const rRating      = Number(r.rating || 0);
        const rRounded     = Math.round(rRating || 0);
        const likeCount    = Number(r.likes_count || r.likes?.length || 0);
        const isLiked      = r.is_liked || false;

        const sentiment    = r.sentiment || null;
        const score        = (typeof r.sentiment_score === 'number') ? r.sentiment_score : null;
        const aiLabel      = r.ai_label || null;

        const safeName    = AppUtils.escapeHtml(displayName);
        const safeComment = AppUtils.escapeHtml(r.comment || '');
        const safeDate    = AppUtils.escapeHtml(createdLabel);

        let starsHtml = '';
        if (rRating) {
          for (let i = 1; i <= 5; i++) {
            starsHtml += `<i class="star ${i <= rRounded ? 'filled' : ''}">‚òÖ</i>`;
          }
        }

        let sentimentText  = '';
        let sentimentClass = '';

        if (sentiment === 'positive') {
          sentimentText  = 'T√≠ch c·ª±c';
          sentimentClass = 'positive';
        } else if (sentiment === 'negative') {
          sentimentText  = 'Ti√™u c·ª±c';
          sentimentClass = 'negative';
        } else if (sentiment === 'neutral') {
          sentimentText  = 'Trung t√≠nh';
          sentimentClass = 'neutral';
        }

        let aiLabelText = '';
        if (aiLabel === 'happy')    aiLabelText = 'Kh√°ch h√†i l√≤ng';
        if (aiLabel === 'complain') aiLabelText = 'Kh√°ch ph√†n n√†n';
        if (aiLabel === 'urgent')   aiLabelText = 'C·∫ßn h·ªó tr·ª£ g·∫•p';

        const sentimentParts = [];
        if (sentimentText)        sentimentParts.push(`<span>${sentimentText}</span>`);
        if (score !== null)       sentimentParts.push(`<span>‚Ä¢ ƒêi·ªÉm: ${score.toFixed(2)}</span>`);
        if (aiLabelText)          sentimentParts.push(`<span>‚Ä¢ ${aiLabelText}</span>`);

        const sentimentLine = sentimentParts.length
          ? `<div class="comment-sentiment ${sentimentClass}">
               <span>C·∫£m x√∫c AI:</span>
               ${sentimentParts.join('')}
             </div>`
          : '';

        const adminBadge = isAdmin ? '<span class="admin-badge">QTV</span>' : '';
        const authorName = isAdmin ? 'Qu·∫£n Tr·ªã Vi√™n' : safeName;

        return `
          <div class="comment-item" 
               data-id="${r._id || ''}"
               data-has-rating="${rRating ? 'true' : 'false'}"
               data-has-comment="${safeComment ? 'true' : 'false'}">
            <div class="d-flex">
              <div class="comment-avatar">
                ${safeName.charAt(0).toUpperCase()}
              </div>
              <div class="comment-content">
                <div class="comment-header">
                  <div>
                    <div class="comment-author-badge">
                      <span class="comment-author">${authorName}</span>
                      ${adminBadge}
                    </div>
                    <div class="comment-meta">${safeDate}</div>
                  </div>
                  ${rRating ? `<div class="comment-rating rating-small">${starsHtml}</div>` : ''}
                </div>
                <div class="comment-text">${safeComment}</div>
                ${sentimentLine}
                <div class="comment-actions">
                  <button 
                    class="comment-action-btn like-btn ${isLiked ? 'liked' : ''}" 
                    data-comment-id="${r._id || ''}"
                    title="Th·∫£ tim">
                    <svg class="heart-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    </svg>
                    <span class="like-count" data-count="${likeCount}">${likeCount > 0 ? likeCount : ''}</span>
                    <span>Th√≠ch</span>
                  </button>
                  <button 
                    class="comment-action-btn reply-btn" 
                    data-comment-id="${r._id || ''}"
                    onclick="toggleReplyForm('${r._id || ''}'); return false;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M3 10h10a8 8 0 0 1 8 8v2M3 10l6 6m-6-6l6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Ph·∫£n h·ªìi
                  </button>
                </div>
                <div class="replies-list" id="replies-${r._id || ''}" style="display: none;">
                  <!-- Replies will be inserted here -->
                </div>
                <div class="reply-form-container" id="reply-form-${r._id || ''}" style="display: none;">
                  <form class="reply-form" data-parent-id="${r._id || ''}">
                    <div class="reply-form-input-wrapper">
                      <textarea 
                        class="reply-form-input" 
                        name="comment" 
                        placeholder="Vi·∫øt ph·∫£n h·ªìi..." 
                        required></textarea>
                      <button type="submit" class="reply-form-submit">G·ª≠i</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        `;
      }

      function prependReview(r) {
        if (!reviewListEl || !r) return;
        const html = buildReviewHtml(r);

        // n·∫øu danh s√°ch ƒëang l√† "ch∆∞a c√≥ b√¨nh lu·∫≠n" th√¨ clear
        const emptyEl = reviewListEl.querySelector('.comments-empty');
        if (emptyEl) {
          emptyEl.remove();
        }

        const tmp  = document.createElement('div');
        tmp.innerHTML = html.trim();
        const node = tmp.firstChild;
        reviewListEl.insertBefore(node, reviewListEl.firstChild);

        // Bind l·∫°i event listeners cho comment m·ªõi
        const newReplyForm = node.querySelector('.reply-form');
        if (newReplyForm) {
          bindReplyForm(newReplyForm);
        }

        const newLikeBtn = node.querySelector('.like-btn');
        if (newLikeBtn) {
          bindLikeButton(newLikeBtn);
        }
      }

      // ===== REPLY FUNCTIONS =====
      function getOpenReplyForms() {
        try {
          const stored = localStorage.getItem(`openReplyForms_${productId}`);
          return stored ? JSON.parse(stored) : [];
        } catch (e) {
          return [];
        }
      }

      function saveOpenReplyForms(commentIds) {
        try {
          localStorage.setItem(`openReplyForms_${productId}`, JSON.stringify(commentIds));
        } catch (e) {
          console.error('Failed to save open reply forms:', e);
        }
      }

      function restoreOpenReplyForms() {
        const openForms = getOpenReplyForms();
        openForms.forEach(commentId => {
          const formEl = document.getElementById(`reply-form-${commentId}`);
          if (formEl) {
            formEl.style.display = 'block';
            const form = formEl.querySelector('.reply-form');
            if (form) {
              bindReplyForm(form);
            }
          }
        });
      }

      window.toggleReplyForm = function(commentId) {
        const formEl = document.getElementById(`reply-form-${commentId}`);
        if (!formEl) {
          console.error('Reply form not found for comment:', commentId);
          return;
        }
        
        const isHidden = formEl.style.display === 'none' || !formEl.style.display;
        
        if (isHidden) {
          // Show form
          formEl.style.display = 'block';
          
          // Save to localStorage
          const openForms = getOpenReplyForms();
          if (!openForms.includes(commentId)) {
            openForms.push(commentId);
            saveOpenReplyForms(openForms);
          }
          
          // Ensure form is bound
          const form = formEl.querySelector('.reply-form');
          if (form) {
            // Remove old listeners by cloning
            const newForm = form.cloneNode(true);
            form.parentNode.replaceChild(newForm, form);
            bindReplyForm(newForm);
          }
          
          // Focus on textarea
          const textarea = formEl.querySelector('textarea');
          if (textarea) {
            setTimeout(() => textarea.focus(), 100);
          }
        } else {
          // Hide form
          formEl.style.display = 'none';
          
          // Remove from localStorage
          const openForms = getOpenReplyForms();
          const index = openForms.indexOf(commentId);
          if (index > -1) {
            openForms.splice(index, 1);
            saveOpenReplyForms(openForms);
          }
        }
      };

      function appendReply(parentId, reply) {
        console.log('appendReply called with parentId:', parentId, 'reply:', reply);
        
        // Use parent_id from reply object if available, otherwise use provided parentId
        const actualParentId = reply.parent_id || parentId;
        
        let repliesContainer = document.getElementById(`replies-${actualParentId}`);
        if (!repliesContainer) {
          // T·∫°o container m·ªõi n·∫øu ch∆∞a c√≥
          const commentItem = document.querySelector(`[data-id="${actualParentId}"]`);
          if (!commentItem) {
            console.error('Comment item not found for parentId:', actualParentId);
            return;
          }
          
          const commentContent = commentItem.querySelector('.comment-content');
          if (!commentContent) {
            console.error('Comment content not found for parentId:', actualParentId);
            return;
          }

          const newContainer = document.createElement('div');
          newContainer.className = 'replies-list';
          newContainer.id = `replies-${actualParentId}`;
          newContainer.style.display = 'block';
          
          const formEl = commentItem.querySelector(`#reply-form-${actualParentId}`);
          if (formEl) {
            commentContent.insertBefore(newContainer, formEl);
          } else {
            commentContent.appendChild(newContainer);
          }
          
          repliesContainer = newContainer;
          console.log('Created new replies container for parentId:', actualParentId);
        } else {
          repliesContainer.style.display = 'block';
          console.log('Using existing replies container for parentId:', actualParentId);
        }

        const replyName = (reply.user && reply.user.full_name) || reply.guest_name || '·∫®n danh';
        const replyIsAdmin = (reply.user && reply.user.role === 'admin') || (reply.user && reply.user.isAdmin);
        const replyDate = reply.createdAt ? new Date(reply.createdAt).toLocaleString('vi-VN') : '';
        const replyLikeCount = Number(reply.likes_count || reply.likes?.length || 0);
        const replyIsLiked = reply.is_liked || false;
        
        // Sentiment data
        const replySentiment = reply.sentiment || null;
        const replyScore = (typeof reply.sentiment_score === 'number') ? reply.sentiment_score : null;
        const replyAiLabel = reply.ai_label || null;
        
        let replySentimentText = '';
        let replySentimentClass = '';
        
        if (replySentiment === 'positive') {
          replySentimentText = 'T√≠ch c·ª±c';
          replySentimentClass = 'positive';
        } else if (replySentiment === 'negative') {
          replySentimentText = 'Ti√™u c·ª±c';
          replySentimentClass = 'negative';
        } else if (replySentiment === 'neutral') {
          replySentimentText = 'Trung t√≠nh';
          replySentimentClass = 'neutral';
        }
        
        let replyAiLabelText = '';
        if (replyAiLabel === 'happy') replyAiLabelText = 'Kh√°ch h√†i l√≤ng';
        if (replyAiLabel === 'complain') replyAiLabelText = 'Kh√°ch ph√†n n√†n';
        if (replyAiLabel === 'urgent') replyAiLabelText = 'C·∫ßn h·ªó tr·ª£ g·∫•p';
        
        const replySentimentParts = [];
        if (replySentimentText) replySentimentParts.push(`<span>${replySentimentText}</span>`);
        if (replyScore !== null) replySentimentParts.push(`<span>‚Ä¢ ƒêi·ªÉm: ${replyScore.toFixed(2)}</span>`);
        if (replyAiLabelText) replySentimentParts.push(`<span>‚Ä¢ ${replyAiLabelText}</span>`);
        
        const replySentimentLine = replySentimentParts.length
          ? `<div class="comment-sentiment ${replySentimentClass}">
               <span>C·∫£m x√∫c AI:</span>
               ${replySentimentParts.join('')}
             </div>`
          : '';
        
        const safeReplyName = AppUtils.escapeHtml(replyName);
        const safeReplyComment = AppUtils.escapeHtml(reply.comment || '');
        const safeReplyDate = AppUtils.escapeHtml(replyDate);

        const replyHtml = `
          <div class="reply-item" data-reply-id="${reply._id || ''}">
            <div class="d-flex">
              <div class="comment-avatar">
                ${safeReplyName.charAt(0).toUpperCase()}
              </div>
              <div class="comment-content">
                <div class="comment-header">
                  <div>
                    <div class="comment-author-badge">
                      <span class="comment-author">
                        ${replyIsAdmin ? 'Qu·∫£n Tr·ªã Vi√™n' : safeReplyName}
                      </span>
                      ${replyIsAdmin ? '<span class="admin-badge">QTV</span>' : ''}
                    </div>
                    <div class="comment-meta">${safeReplyDate}</div>
                  </div>
                </div>
                <div class="comment-text" style="padding: 0.875rem 1rem; font-size: 0.9375rem;">${safeReplyComment}</div>
                ${replySentimentLine}
                <div class="comment-actions" style="margin-top: 0.75rem; padding-top: 0.75rem;">
                  <button 
                    class="comment-action-btn like-btn ${replyIsLiked ? 'liked' : ''}" 
                    data-comment-id="${reply._id || ''}"
                    title="Th·∫£ tim">
                    <svg class="heart-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
                    </svg>
                    <span class="like-count" data-count="${replyLikeCount}">${replyLikeCount > 0 ? replyLikeCount : ''}</span>
                    <span>Th√≠ch</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
        `;

        const tmp = document.createElement('div');
        tmp.innerHTML = replyHtml.trim();
        const replyNode = tmp.firstChild;
        repliesContainer.appendChild(replyNode);

        // Bind like button for the new reply
        const newLikeBtn = replyNode.querySelector('.like-btn');
        if (newLikeBtn) {
          bindLikeButton(newLikeBtn);
        }
      }

      function bindReplyForm(form) {
        // Remove existing listeners to avoid duplicates
        const newForm = form.cloneNode(true);
        form.parentNode.replaceChild(newForm, form);
        
        newForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const parentId = newForm.getAttribute('data-parent-id');
          if (!parentId) {
            console.error('No parent ID found in form');
            return;
          }

          console.log('Submitting reply for parent:', parentId);

          const formData = new FormData(newForm);
          const comment = (formData.get('comment') || '').toString().trim();
          
          if (!comment) {
            alert('Vui l√≤ng nh·∫≠p n·ªôi dung ph·∫£n h·ªìi.');
            return;
          }

          const payload = {
            comment: comment,
            parent_id: parentId,
            product_id: productId
          };
          // Backend s·∫Ω t·ª± ƒë·ªông l·∫•y t√™n t·ª´ user n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p, n·∫øu ch∆∞a th√¨ d√πng "Ng∆∞·ªùi d√πng ·∫©n danh"

          console.log('Reply payload:', payload);

          // Disable form while submitting
          const submitBtn = newForm.querySelector('button[type="submit"]');
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'ƒêang g·ª≠i...';
          }

          try {
            // Try WebSocket first if available
            if (socket && socket.connected) {
              console.log('Using WebSocket for reply');
              socket.emit('comment:reply', payload, (response) => {
                console.log('WebSocket reply response:', response);
                
                if (submitBtn) {
                  submitBtn.disabled = false;
                  submitBtn.textContent = 'G·ª≠i';
                }

                if (response && response.ok && response.reply) {
                  // Reply ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng (backend s·∫Ω broadcast cho t·∫•t c·∫£ clients)
                  newForm.reset();
                  const formContainer = document.getElementById(`reply-form-${parentId}`);
                  if (formContainer) formContainer.style.display = 'none';
                  
                  // Remove from localStorage
                  const openForms = getOpenReplyForms();
                  const index = openForms.indexOf(parentId);
                  if (index > -1) {
                    openForms.splice(index, 1);
                    saveOpenReplyForms(openForms);
                  }
                  
                  // Also append immediately for better UX
                  console.log('Appending reply:', response.reply);
                  appendReply(parentId, response.reply);
                } else {
                  // Fallback to HTTP if WebSocket fails
                  console.log('WebSocket failed, falling back to HTTP');
                  sendReplyViaHTTP(payload, parentId, newForm, submitBtn);
                }
              });

              // Timeout fallback after 3 seconds
              setTimeout(() => {
                if (submitBtn && submitBtn.disabled && submitBtn.textContent === 'ƒêang g·ª≠i...') {
                  console.warn('WebSocket timeout, falling back to HTTP');
                  sendReplyViaHTTP(payload, parentId, newForm, submitBtn);
                }
              }, 3000);
            } else {
              // No WebSocket, use HTTP directly
              console.log('No WebSocket, using HTTP for reply');
              await sendReplyViaHTTP(payload, parentId, newForm, submitBtn);
            }
          } catch (err) {
            console.error('Reply error:', err);
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = 'G·ª≠i';
            }
            alert('C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.');
          }
        });
      }

      async function sendReplyViaHTTP(payload, parentId, form, submitBtn) {
        try {
          console.log('Sending reply via HTTP to:', `${apiUrl}/reply`);
          const res = await fetch(`${apiUrl}/reply`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
          });

          console.log('HTTP reply response status:', res.status);

          const data = await res.json().catch((err) => {
            console.error('Failed to parse JSON response:', err);
            return null;
          });

          console.log('HTTP reply response data:', data);

          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'G·ª≠i';
          }

          if (!res.ok || !data || !data.ok) {
            const errorMsg = (data && data.message) || `HTTP ${res.status}: G·ª≠i ph·∫£n h·ªìi th·∫•t b·∫°i, vui l√≤ng th·ª≠ l·∫°i.`;
            console.error('Reply failed:', errorMsg);
            alert(errorMsg);
            return;
          }

          if (data.reply) {
            console.log('Reply successful, appending:', data.reply);
            form.reset();
            
            // Re-enable form after successful submission
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = 'G·ª≠i';
              submitBtn.style.opacity = '1';
              submitBtn.style.cursor = 'pointer';
            }
            const formContainer = document.getElementById(`reply-form-${parentId}`);
            if (formContainer) formContainer.style.display = 'none';
            
            // Remove from localStorage
            const openForms = getOpenReplyForms();
            const index = openForms.indexOf(parentId);
            if (index > -1) {
              openForms.splice(index, 1);
              saveOpenReplyForms(openForms);
            }
            
            appendReply(parentId, data.reply);
          } else {
            console.warn('Reply successful but no reply data in response');
          }
        } catch (err) {
          console.error('HTTP reply error:', err);
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = 'G·ª≠i';
          }
          alert('C√≥ l·ªói k·∫øt n·ªëi: ' + err.message);
        }
      }

      function initReplyForms() {
        const replyForms = AppUtils.qsa('.reply-form');
        replyForms.forEach(form => {
          bindReplyForm(form);
        });
      }

      // ===== LIKE FUNCTIONS =====
      function updateLikeUI(commentId, likesCount, isLiked) {
        // Update all like buttons for this comment (could be in main comment or reply)
        const buttons = document.querySelectorAll(`.like-btn[data-comment-id="${commentId}"]`);
        if (!buttons || buttons.length === 0) {
          console.warn('No like button found for comment:', commentId);
          return;
        }

        buttons.forEach(btn => {
          const countEl = btn.querySelector('.like-count');
          if (countEl) {
            countEl.setAttribute('data-count', likesCount || 0);
            countEl.textContent = likesCount > 0 ? likesCount : '';
          }

          if (isLiked) {
            btn.classList.add('liked');
          } else {
            btn.classList.remove('liked');
          }
        });
      }

      function bindLikeButton(btn) {
        // Remove existing listeners to avoid duplicates
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        let isProcessing = false;
        let lastClickTime = 0;
        const DEBOUNCE_MS = 500; // 500ms debounce
        
        newBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          // Debounce: prevent rapid clicks
          const now = Date.now();
          if (now - lastClickTime < DEBOUNCE_MS) {
            return;
          }
          lastClickTime = now;
          
          // Prevent double-click
          if (isProcessing) {
            return;
          }
          
          const commentId = newBtn.getAttribute('data-comment-id');
          if (!commentId) {
            console.error('No comment ID found');
            return;
          }

          const isLiked = newBtn.classList.contains('liked');
          const action = isLiked ? 'unlike' : 'like';
          
          console.log('Like button clicked:', { commentId, action, isLiked });

          // Disable button and set processing state
          isProcessing = true;
          newBtn.disabled = true;
          newBtn.style.opacity = '0.6';
          newBtn.style.cursor = 'wait';

          // Optimistic UI update
          const currentCount = Number(newBtn.querySelector('.like-count')?.getAttribute('data-count') || 0);
          const newCount = action === 'like' ? currentCount + 1 : Math.max(0, currentCount - 1);
          updateLikeUI(commentId, newCount, !isLiked);

          try {
            // Try WebSocket first if available
            if (socket && socket.connected) {
              console.log('Using WebSocket for like');
              socket.emit('comment:like', {
                comment_id: commentId,
                product_id: productId,
                action: action
              }, (response) => {
                isProcessing = false;
                newBtn.disabled = false;
                newBtn.style.opacity = '1';
                newBtn.style.cursor = 'pointer';
                
                console.log('WebSocket like response:', response);
                if (response && response.ok) {
                  const finalCount = Number(response.likes_count || 0);
                  updateLikeUI(commentId, finalCount, response.is_liked);
                } else {
                  // Revert optimistic update on error
                  updateLikeUI(commentId, currentCount, isLiked);
                  // Fallback to HTTP
                  sendLikeViaHTTP(commentId, action, newBtn, currentCount, isLiked);
                }
              });

              // Timeout fallback after 3 seconds
              setTimeout(() => {
                if (isProcessing) {
                  isProcessing = false;
                  newBtn.disabled = false;
                  newBtn.style.opacity = '1';
                  newBtn.style.cursor = 'pointer';
                  console.warn('WebSocket timeout, falling back to HTTP');
                  sendLikeViaHTTP(commentId, action, newBtn, currentCount, isLiked);
                }
              }, 3000);
            } else {
              // No WebSocket, use HTTP directly
              console.log('No WebSocket, using HTTP for like');
              await sendLikeViaHTTP(commentId, action, newBtn, currentCount, isLiked);
              isProcessing = false;
              newBtn.disabled = false;
              newBtn.style.opacity = '1';
              newBtn.style.cursor = 'pointer';
            }
          } catch (err) {
            isProcessing = false;
            newBtn.disabled = false;
            newBtn.style.opacity = '1';
            newBtn.style.cursor = 'pointer';
            // Revert optimistic update on error
            updateLikeUI(commentId, currentCount, isLiked);
            console.error('Like error:', err);
          }
        });
      }

      async function sendLikeViaHTTP(commentId, action, btn, originalCount, originalIsLiked) {
        try {
          const response = await fetch(`/api/product/${productId}/reviews/${commentId}/like`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ action }),
            credentials: 'include'
          });

          const data = await response.json();
          
          if (response.ok && data.ok) {
            const finalCount = Number(data.likes_count || 0);
            updateLikeUI(commentId, finalCount, data.is_liked);
          } else {
            // Revert optimistic update on error
            updateLikeUI(commentId, originalCount, originalIsLiked);
            console.error('Like failed:', data.message || 'C√≥ l·ªói x·∫£y ra');
          }
        } catch (err) {
          console.error('HTTP like error:', err);
          // Revert optimistic update on error
          updateLikeUI(commentId, originalCount, originalIsLiked);
        }
      }

      function initLikeButtons() {
        const likeButtons = AppUtils.qsa('.like-btn');
        likeButtons.forEach(btn => {
          bindLikeButton(btn);
        });
      }


      // ===== FILTER REVIEWS =====
      function initToggleReviews() {
        const toggleBtn = document.getElementById('toggleReviewsBtn');
        const reviewsList = document.getElementById('reviewsList');
        
        if (!toggleBtn || !reviewsList) return;
        
        // Ki·ªÉm tra xem c√≥ nhi·ªÅu comments kh√¥ng ƒë·ªÉ th√™m scroll
        const commentItems = reviewsList.querySelectorAll('.comment-item');
        if (commentItems.length > 5) {
          reviewsList.classList.add('has-scroll');
        }
        
        toggleBtn.addEventListener('click', () => {
          const isExpanded = toggleBtn.getAttribute('aria-expanded') === 'true';
          
          if (isExpanded) {
            // Thu g·ªçn
            reviewsList.classList.add('collapsed');
            reviewsList.classList.remove('expanded');
            toggleBtn.setAttribute('aria-expanded', 'false');
            toggleBtn.querySelector('.toggle-text').textContent = 'M·ªü r·ªông b√¨nh lu·∫≠n';
          } else {
            // M·ªü r·ªông
            reviewsList.classList.remove('collapsed');
            reviewsList.classList.add('expanded');
            toggleBtn.setAttribute('aria-expanded', 'true');
            toggleBtn.querySelector('.toggle-text').textContent = 'Thu g·ªçn b√¨nh lu·∫≠n';
          }
        });
      }

      function initReviewFilter() {
        const filterButtons = document.querySelectorAll('.filter-btn');
        const reviewItems = document.querySelectorAll('.comment-item');

        filterButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            // Update active state
            filterButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const filter = btn.getAttribute('data-filter');

            reviewItems.forEach(item => {
              const hasRating = item.getAttribute('data-has-rating') === 'true';
              const hasComment = item.getAttribute('data-has-comment') === 'true';

              let show = false;

              switch (filter) {
                case 'all':
                  show = true;
                  break;
                case 'comments-only':
                  show = hasComment && !hasRating;
                  break;
                case 'with-rating-comment':
                  show = hasRating && hasComment;
                  break;
                default:
                  show = true;
              }

              item.style.display = show ? 'block' : 'none';
            });
          });
        });
      }

      // ===== RATING UI (ch·ªçn sao) =====
      function initRatingStars() {
        const stars = AppUtils.qsa('#ratingStars .rate-star');
        if (!stars.length) return;

        if (!isLoggedIn) {
          // guest click sao -> b√°o ƒëƒÉng nh·∫≠p
          stars.forEach(st => {
            st.addEventListener('click', (e) => {
              e.preventDefault();
              alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë√°nh gi√° sao.');
            });
          });
          return;
        }

        const hiddenInput = document.getElementById('reviewRating');
        let current = 0;

        function paint(v) {
          stars.forEach((st, idx) => {
            st.classList.toggle('filled', idx < v);
          });
        }

        stars.forEach(st => {
          const val = Number(st.dataset.value || 0);

          st.addEventListener('mouseenter', () => {
            paint(val);
          });
          st.addEventListener('mouseleave', () => {
            paint(current);
          });
          st.addEventListener('click', (e) => {
            e.preventDefault();
            current = val;
            if (hiddenInput) hiddenInput.value = String(val);
            paint(current);
          });
        });
      }

      // ===== SUBMIT FORM REVIEW =====
      function initReviewForm() {
        const form = document.getElementById('reviewForm');
        if (!form) return;

        let isSubmitting = false;
        let lastSubmitTime = 0;
        const DEBOUNCE_MS = 1000; // 1 second debounce for form submission

        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          // Debounce: prevent rapid submissions
          const now = Date.now();
          if (now - lastSubmitTime < DEBOUNCE_MS) {
            return;
          }
          lastSubmitTime = now;
          
          // Prevent double submission
          if (isSubmitting) {
            return;
          }
          
          if (ratingMessage) {
            ratingMessage.textContent = '';
            ratingMessage.style.color = '';
          }
          
          // Get form elements
          const submitBtn = form.querySelector('button[type="submit"]');
          
          // Disable form and set submitting state
          isSubmitting = true;
          if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'ƒêang g·ª≠i...';
            submitBtn.style.opacity = '0.6';
            submitBtn.style.cursor = 'wait';
          }

          const commentInput = document.getElementById('reviewComment');
          const comment = commentInput ? (commentInput.value || '').trim() : '';

          if (!comment) {
            // Re-enable form on validation error
            isSubmitting = false;
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = 'G·ª≠i ƒë√°nh gi√°';
              submitBtn.style.opacity = '1';
              submitBtn.style.cursor = 'pointer';
            }
            
            if (ratingMessage) {
              ratingMessage.textContent = 'Vui l√≤ng nh·∫≠p n·ªôi dung b√¨nh lu·∫≠n.';
              ratingMessage.style.color = '#dc2626';
            }
            return;
          }

          // Backend s·∫Ω t·ª± ƒë·ªông l·∫•y t√™n t·ª´ user n·∫øu ƒë√£ ƒëƒÉng nh·∫≠p, n·∫øu ch∆∞a th√¨ d√πng "Ng∆∞·ªùi d√πng ·∫©n danh"
          // Rating l√† optional - c√≥ th·ªÉ ch·ªâ ƒë√°nh sao ho·∫∑c ch·ªâ b√¨nh lu·∫≠n ho·∫∑c c·∫£ hai
          let ratingVal = null;
          if (isLoggedIn) {
            const ratingInput = document.getElementById('reviewRating');
            ratingVal = ratingInput ? Number(ratingInput.value || 0) : 0;
            // Ch·ªâ th√™m rating n·∫øu c√≥ gi√° tr·ªã h·ª£p l·ªá (1-5)
            if (!ratingVal || ratingVal < 1 || ratingVal > 5) {
              ratingVal = null;
            }
          }

          try {
            const res = await fetch(apiUrl, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                comment: comment,
                rating: ratingVal
              }),
              credentials: 'include'
            });

            const data = await res.json().catch(() => null);

            if (!res.ok || !data || !data.ok) {
              const msg = (data && data.message) || 'G·ª≠i ƒë√°nh gi√° th·∫•t b·∫°i, vui l√≤ng th·ª≠ l·∫°i.';
              if (ratingMessage) {
                ratingMessage.textContent = msg;
                ratingMessage.style.color = '#dc2626';
              }
              
              // Re-enable form on error
              isSubmitting = false;
              if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'G·ª≠i ƒë√°nh gi√°';
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
              }
              return;
            }

            // Th√™m review m·ªõi (n·∫øu socket ƒë√£ emit th√¨ v·∫´n OK, nh∆∞ng ta th√™m lu√¥n ƒë·ªÉ ch·∫Øc)
            if (data.review) {
              prependReview(data.review);
            }

            // C·∫≠p nh·∫≠t l·∫°i rating trung b√¨nh + count + sao
            if (data.rating) {
              // H·ªó tr·ª£ c·∫£ 2 format: average/count v√† averageRating/countRating
              const avg = Number(data.rating.average || data.rating.averageRating || 0);
              const cnt = Number(data.rating.count || data.rating.countRating || 0);

              // C·∫≠p nh·∫≠t ph·∫ßn reviews section
              if (ratingAvgEl)   ratingAvgEl.textContent   = avg.toFixed(1);
              if (ratingCountEl) ratingCountEl.textContent = cnt;
              repaintAverageStars(avg);

              // C·∫≠p nh·∫≠t ph·∫ßn product info (ph·∫ßn tr√™n c√πng)
              updateProductInfoRating(avg, cnt);

              // C·∫≠p nh·∫≠t b·∫£ng th·ªëng k√™ sentiment (n·∫øu c√≥)
              if (data.rating.sentiment) {
                const s = data.rating.sentiment;
                const statsEl = document.getElementById('sentimentStats');
                if (statsEl) {
                  statsEl.innerHTML = `
                    <div>üòä T√≠ch c·ª±c: <strong>${s.positive || 0}</strong></div>
                    <div>üòê Trung t√≠nh: <strong>${s.neutral || 0}</strong></div>
                    <div>üò° Ti√™u c·ª±c: <strong>${s.negative || 0}</strong></div>
                    <div>‚ö™ Kh√¥ng x√°c ƒë·ªãnh: <strong>${s.null || 0}</strong></div>
                  `;
                }
              }
            }

            // Reset form + sao
            form.reset();
            
            // Re-enable form after successful submission
            isSubmitting = false;
            if (submitBtn) {
              submitBtn.disabled = false;
              submitBtn.textContent = 'G·ª≠i ƒë√°nh gi√°';
              submitBtn.style.opacity = '1';
              submitBtn.style.cursor = 'pointer';
            }
            const hiddenRating = document.getElementById('reviewRating');
            if (hiddenRating) hiddenRating.value = '';
            const stars = AppUtils.qsa('#ratingStars .rate-star');
            stars.forEach(st => st.classList.remove('filled'));

            if (ratingMessage) {
              ratingMessage.textContent = 'G·ª≠i ƒë√°nh gi√° th√†nh c√¥ng!';
              ratingMessage.style.color = '#16a34a';
            }

          } catch (err) {
            console.error('Submit review error:', err);
            
            // Re-enable form on error
            isSubmitting = false;
            const errorSubmitBtn = form.querySelector('button[type="submit"]');
            
            if (errorSubmitBtn) {
              errorSubmitBtn.disabled = false;
              errorSubmitBtn.textContent = 'G·ª≠i ƒë√°nh gi√°';
              errorSubmitBtn.style.opacity = '1';
              errorSubmitBtn.style.cursor = 'pointer';
            }
            
            if (ratingMessage) {
              ratingMessage.textContent = 'C√≥ l·ªói k·∫øt n·ªëi, vui l√≤ng th·ª≠ l·∫°i.';
              ratingMessage.style.color = '#dc2626';
            }
          }
        });
      }

      // ===== SOCKET.IO: join room & l·∫Øng nghe review m·ªõi =====
      function initSocketReviews() {
        if (!socket || !productId) return;
        try {
          // backend: socket.join(`product:${productId}`)
          socket.emit('join-product-room', productId);

          socket.on('review:new', (review) => {
            if (!review || !review._id) return;
            prependReview(review);
            // Rating s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t qua event 'rating:updated' ri√™ng
          });

          // L·∫Øng nghe c·∫≠p nh·∫≠t rating t·ª´ WebSocket (khi c√≥ review m·ªõi)
          socket.on('rating:updated', (ratingData) => {
            if (!ratingData) return;
            const avg = Number(ratingData.average || ratingData.averageRating || 0);
            const cnt = Number(ratingData.count || ratingData.countRating || 0);
            
            console.log('Rating updated via WebSocket:', { avg, cnt });
            
            // C·∫≠p nh·∫≠t ph·∫ßn reviews section
            if (ratingAvgEl) ratingAvgEl.textContent = avg.toFixed(1);
            if (ratingCountEl) ratingCountEl.textContent = cnt;
            repaintAverageStars(avg);
            
            // C·∫≠p nh·∫≠t ph·∫ßn product info (ph·∫ßn tr√™n c√πng)
            updateProductInfoRating(avg, cnt);
            
            // C·∫≠p nh·∫≠t sentiment stats n·∫øu c√≥
            if (ratingData.sentiment) {
              const s = ratingData.sentiment;
              const statsEl = document.getElementById('sentimentStats');
              if (statsEl) {
                statsEl.innerHTML = `
                  <div>üòä T√≠ch c·ª±c: <strong>${s.positive || 0}</strong></div>
                  <div>üòê Trung t√≠nh: <strong>${s.neutral || 0}</strong></div>
                  <div>üò° Ti√™u c·ª±c: <strong>${s.negative || 0}</strong></div>
                  <div>‚ö™ Kh√¥ng x√°c ƒë·ªãnh: <strong>${s.null || 0}</strong></div>
                `;
              }
            }
          });

          socket.on('reply:new', (reply) => {
            if (!reply || !reply._id || !reply.parent_id) return;
            appendReply(reply.parent_id, reply);
          });

          // Listen for like updates
          socket.on('comment:like-updated', (data) => {
            if (!data || !data.comment_id) return;
            updateLikeUI(data.comment_id, data.likes_count, data.is_liked);
          });
        } catch (e) {
          console.error('Socket review error:', e);
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        initRatingStars();
        initReviewForm();
        initReplyForms();
        initLikeButtons();
        initReviewFilter();
        initSocketReviews();
        initToggleReviews();
        
        // Restore open reply forms from localStorage
        setTimeout(() => {
          restoreOpenReplyForms();
        }, 100);
      });
    })();
  </script>

</body>

</html>
