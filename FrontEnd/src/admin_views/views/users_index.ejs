<% layout('layouts/admin') %>

  <section class="space-y-6">

    <!-- Header -->
    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h2 class="text-xl font-semibold tracking-tight text-slate-900">Người dùng</h2>
        <p class="text-sm text-slate-600">
          Quản lý tài khoản hệ thống: xem, chỉnh sửa, khóa/mở khóa và xóa người dùng.
        </p>
      </div>

      <!-- Search -->
      <form action="/admin/users" method="get" class="flex items-center gap-2">
        <div class="relative">
          <input type="text" name="q" value="<%= q || '' %>" placeholder="Tìm theo tên, email..." class="w-56 rounded-xl border border-blue-300/70 bg-white px-3 py-2 text-sm text-slate-800 shadow-sm
                 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-400" />
          <span class="pointer-events-none absolute inset-y-0 right-2 flex items-center text-slate-400">
            <i data-lucide="search" class="w-4 h-4"></i>
          </span>
        </div>

        <button type="submit" class="inline-flex items-center gap-1 rounded-xl bg-blue-500 px-3 py-2 text-xs font-medium text-white shadow-sm
               hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
          <i data-lucide="filter" class="w-4 h-4"></i>
          Lọc
        </button>
      </form>
    </div>

    <!-- Table -->
    <div class="rounded-2xl border border-slate-200 bg-white shadow-md overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-blue-50 border-b border-slate-200">
            <tr class="text-left text-slate-600 uppercase text-[11px]">
              <th class="p-3 font-semibold">Tên</th>
              <th class="p-3 font-semibold">Email</th>
              <th class="p-3 font-semibold">Role</th>
              <th class="p-3 font-semibold">Xác thực</th>
              <th class="p-3 font-semibold">Trạng thái</th>
              <th class="p-3 text-right font-semibold">Điểm</th>
              <th class="p-3 whitespace-nowrap font-semibold">Ngày tạo</th>
              <th class="p-3 text-right font-semibold w-32">Hành động</th>
            </tr>
          </thead>

          <tbody>
            <% (items || []).forEach(u=> { %>
              <tr class="border-b border-slate-100 hover:bg-blue-50/40 transition-colors">

                <!-- Name -->
                <td class="p-3 font-medium text-slate-900">
                  <div class="flex items-center gap-2">
                    <div
                      class="flex h-9 w-9 items-center justify-center rounded-full bg-blue-100 text-[11px] font-semibold text-blue-600 border border-blue-200">
                      <%= (u.full_name || u.email || '?' ) .trim() .split(' ')
                      .map(n => n[0])
                      .join('')
                      .slice(0, 2)
                      .toUpperCase()
                    %>
                  </div>
                  <div>
                    <div class="truncate max-w-[180px]"><%= u.full_name %></div>
                    <div class="text-[11px] text-slate-500">ID: <%= u._id %></div>
                  </div>
                </div>
              </td>

              <!-- Email -->
              <td class="p-3 text-slate-700">
                <div class="truncate max-w-[180px]"><%= u.email %></div>
              </td>

              <!-- Role -->
              <td class="p-3">
                <span class="px-2.5 py-0.5 rounded-full bg-blue-100 text-[11px] font-medium text-blue-600 border border-blue-200">
                  <%= u.role %>
                </span>
              </td>

              <!-- Verified -->
              <td class="p-3">
                <% if (u.is_verified) { %>
                  <span class="px-2.5 py-0.5 rounded-full bg-green-100 text-[11px] font-medium text-green-700 border border-green-200">
                    ✔ Đã xác thực
                  </span>
                <% } else { %>
                  <span class="px-2.5 py-0.5 rounded-full bg-slate-200 text-[11px] font-medium text-slate-600 border border-slate-300">
                    ✖ Chưa
                  </span>
                <% } %>
              </td>

              <!-- Status -->
              <td class="p-3">
                <% if (u.is_banned) { %>
                  <span class="px-2.5 py-0.5 rounded-full bg-red-100 text-[11px] font-medium text-red-600 border border-red-200">
                    Bị khóa
                  </span>
                <% } else { %>
                  <span class="px-2.5 py-0.5 rounded-full bg-green-100 text-[11px] font-medium text-green-700 border border-green-200">
                    Hoạt động
                  </span>
                <% } %>
              </td>

              <!-- Points -->
              <td class="p-3 text-right font-semibold text-slate-800">
                <%= u.loyalty_points %>
              </td>

              <!-- Created -->
              <td class="p-3 text-slate-600 whitespace-nowrap">
                <%= new Date(u.createdAt).toLocaleString("vi-VN") %>
              </td>

              <!-- Actions: ICON ONLY -->
              <td class="p-3 text-right">
                <div class="flex justify-end gap-2">

                  <!-- View -->
                  <a href="/admin/users/<%= u._id %>"
                    class="p-2 rounded-lg bg-blue-100 text-blue-600 border border-blue-200 hover:bg-blue-200">
                    <i data-lucide="eye" class="w-4 h-4"></i>
                  </a>

                  <!-- Edit -->
                  <a href="/admin/users/<%= u._id %>/edit"
                    class="p-2 rounded-lg bg-green-100 text-green-700 border border-green-200 hover:bg-green-200">
                    <i data-lucide="pencil" class="w-4 h-4"></i>
                  </a>

                  <!-- Ban / Unban -->
                  <% if (!u.is_banned) { %>
                    <form action="/admin/users/<%= u._id %>/ban" method="post" class="inline"
                      onsubmit="return confirm(' Khóa người dùng này?')">
                        <button class="p-2 rounded-lg bg-red-100 text-red-600 border border-red-200 hover:bg-red-200">
                          <i data-lucide="ban" class="w-4 h-4"></i>
                        </button>
                        </form>
                        <% } else { %>
                          <form action="/admin/users/<%= u._id %>/unban" method="post" class="inline"
                            onsubmit="return confirm('Mở khóa người dùng này?')">
                            <button
                              class="p-2 rounded-lg bg-green-200 text-green-700 border border-green-300 hover:bg-green-300">
                              <i data-lucide="unlock" class="w-4 h-4"></i>
                            </button>
                          </form>
                          <% } %>

                            <!-- Delete -->
                            <form action="/admin/users/<%= u._id %>/delete" method="post" class="inline"
                              onsubmit="return confirm('Xóa vĩnh viễn người dùng này?')">
                              <button
                                class="p-2 rounded-lg bg-red-200 text-red-700 border border-red-300 hover:bg-red-300">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                              </button>
                            </form>

                    </div>
                </td>

              </tr>
              <% }) %>

                <% if (!items || items.length===0) { %>
                  <tr>
                    <td colspan="8" class="p-6 text-center text-sm text-slate-500 bg-slate-50">
                      Không tìm thấy người dùng nào.
                    </td>
                  </tr>
                  <% } %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <% if (pagination) { %>
        <div
          class="flex items-center justify-between border-t border-slate-200 bg-blue-50 px-4 py-3 text-xs text-slate-600">

          <div>
            Hiển thị <span class="text-slate-900 font-semibold">
              <%= pagination.from %>
            </span>–
            <span class="text-slate-900 font-semibold">
              <%= pagination.to %>
            </span>
            trong <%= pagination.totalItems %> người dùng
          </div>

          <div class="flex items-center gap-1">

            <% if (pagination.hasPrev) { %>
              <a href="<%= pagination.baseUrl + pagination.prev %>"
                class="px-2 py-1 rounded-lg bg-white border border-slate-300 hover:bg-slate-200">Trước</a>
              <% } else { %>
                <span class="px-2 py-1 bg-slate-200 rounded-lg opacity-60 cursor-not-allowed">Trước</span>
                <% } %>

                  <span class="px-2 py-1 rounded-lg bg-white border border-slate-300">
                    Trang <%= pagination.page %>/<%= pagination.totalPages %>
                  </span>

                  <% if (pagination.hasNext) { %>
                    <a href="<%= pagination.baseUrl + pagination.next %>"
                      class="px-2 py-1 rounded-lg bg-blue-200 border border-blue-300 text-blue-700 hover:bg-blue-300">Sau</a>
                    <% } else { %>
                      <span class="px-2 py-1 bg-slate-200 rounded-lg opacity-60 cursor-not-allowed">Sau</span>
                      <% } %>

          </div>

        </div>
        <% } %>
    </div>
  </section>