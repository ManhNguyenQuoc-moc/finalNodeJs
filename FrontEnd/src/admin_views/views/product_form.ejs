<% layout('layouts/admin') %>
  <% const P=(typeof product !=='undefined' && product) ? product : null; %>

    <section class="relative">
      <!-- Sticky header -->
      <div class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b">
        <div class="mx-auto max-w-6xl px-4 py-3 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="size-9 grid place-items-center rounded-xl bg-green-100 text-green-600">
              <i data-lucide="package"></i>
            </div>
            <div>
              <h2 class="text-lg font-semibold">
                <%= P ? 'Chỉnh sửa sản phẩm' : 'Thêm sản phẩm' %>
              </h2>
              <p class="text-xs text-slate-500">Quản lý thông tin, mô tả và các biến thể sản phẩm</p>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <a href="/admin/products" class="btn">Quay lại</a>
            <button form="product-form" type="submit" class="rounded-lg px-4 py-2 bg-green-600 text-white">Lưu</button>
          </div>
        </div>
      </div>

      <form id="product-form" class="mx-auto max-w-6xl px-4 py-6 space-y-6" method="post" enctype="multipart/form-data"
        action="<%= P ? '/admin/products/' + P._id : '/admin/products' %>">
        <!-- Thông tin chung -->
        <div class="rounded-2xl border bg-white p-6 space-y-6">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-lg font-semibold text-slate-800">Thông tin chung</h3>
              <p class="text-sm text-slate-500">Tên, định danh, thương hiệu và danh mục</p>
            </div>
            <span class="text-xs font-medium text-red-600">* Bắt buộc</span>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
            <div>
              <label class="block text-sm font-medium">Tên sản phẩm *</label>
              <input name="name" required class="w-full border rounded-lg px-3 py-2"
                value="<%= P ? (P.name || '') : '' %>" placeholder="VD: Áo thun nam" />
            </div>

            <div>
              <label class="block text-sm font-medium">Slug</label>
              <input name="slug" class="w-full border rounded-lg px-3 py-2" value="<%= P ? (P.slug || '') : '' %>"
                placeholder="ao-thun-nam" />
            </div>

            <div>
              <label class="block text-sm font-medium">Thương hiệu</label>
              <select name="brand" class="w-full border rounded-lg px-3 py-2">
                <% (brands||[]).forEach(b=>{ %>
                  <option value="<%= b._id %>" <%=(P && String(P.brand)===String(b._id))?'selected':'' %>><%= b.name %>
                  </option>
                  <% }) %>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium">Danh mục</label>
              <select name="category" class="w-full border rounded-lg px-3 py-2">
                <% (categories||[]).forEach(c=>{ %>
                  <option value="<%= c._id %>" <%=(P && String(P.category)===String(c._id))?'selected':'' %>><%= c.name
                      %>
                  </option>
                  <% }) %>
              </select>
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-medium">Ảnh sản phẩm</label>
              <input type="file" name="productImages" multiple accept="image/*"
                class="w-full border rounded-lg px-3 py-2" />
              <p class="text-xs text-slate-500 mt-1">Có thể chọn nhiều ảnh.</p>

              <% if (P && Array.isArray(P.images) && P.images.length) { %>
                <div class="flex flex-wrap gap-2 mt-2">
                  <% P.images.forEach(img=> { %>
                    <img src="<%= img.url %>" class="w-16 h-16 object-cover rounded border" />
                    <% }) %>
                </div>
                <% } %>
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-medium">Trạng thái nổi bật</label>
              <div class="flex gap-4">
                <% ['Bán chạy','Trending','New'].forEach(s=>{ %>
                  <label class="inline-flex items-center gap-2">
                    <input type="radio" name="statusName" value="<%= s %>" <%=(P && P.productStatus &&
                      P.productStatus.statusName===s)?'checked':'' %> />
                    <span>
                      <%= s %>
                    </span>
                  </label>
                  <% }) %>
              </div>
            </div>
          </div>
        </div>

        <!-- Mô tả -->
        <div class="rounded-2xl border bg-white p-6 space-y-5">
          <div>
            <h3 class="text-lg font-semibold text-slate-800">Mô tả</h3>
            <p class="text-sm text-slate-500">Giới thiệu ngắn gọn và chi tiết</p>
          </div>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium">Mô tả ngắn</label>
              <textarea name="short_description" rows="3"
                class="w-full border rounded-lg px-3 py-2"><%= P ? (P.short_description||'') : '' %></textarea>
            </div>

            <div>
              <label class="block text-sm font-medium">Mô tả dài</label>
              <textarea name="long_description" rows="8"
                class="w-full border rounded-lg px-3 py-2"><%= P ? (P.long_description||'') : '' %></textarea>
            </div>
          </div>
        </div>

        <!-- Biến thể -->
        <div class="rounded-2xl border bg-white p-6 space-y-4" id="variantsRoot">
          <div class="flex items-center justify-between">
            <div>
              <h3 class="text-base font-semibold text-slate-800">Biến thể</h3>
              <p class="text-sm text-slate-500">SKU, giá, tồn kho, màu, size & ảnh riêng từng biến thể</p>
            </div>
            <button type="button" id="btnAddVariant" class="rounded-lg px-3 py-2 border">+ Thêm biến thể</button>
          </div>

          <!-- Hidden JSON để BE đọc -->
          <input type="hidden" name="variants" id="variantsJson" value="[]">

          <div id="variantsList" class="space-y-3"></div>

          <div class="flex justify-end gap-2 pt-2">
            <a class="btn" href="/admin/products">Hủy</a>
            <button type="submit" class="rounded-lg px-4 py-2 bg-green-600 text-white">Lưu</button>
          </div>

          <details class="mt-2">
            <summary class="cursor-pointer text-sm text-slate-600">Debug</summary>
            <pre id="debug" class="text-xs bg-slate-900 text-slate-100 p-3 rounded-lg overflow-auto"></pre>
          </details>
        </div>

        <!-- Template 1 hàng biến thể (có ô chọn ảnh). __INDEX__ sẽ được thay bằng chỉ số thật -->
        <template id="tplVariantRow">
          <div class="variant-row grid grid-cols-12 gap-3 rounded-xl border p-3 bg-white">
            <div class="col-span-12 md:col-span-3">
              <label class="block text-sm font-medium">SKU</label>
              <input class="v-sku w-full border rounded-lg px-3 py-2" placeholder="SKU001">
            </div>

            <div class="col-span-6 md:col-span-3">
              <label class="block text-sm font-medium">Màu (id)</label>
              <select class="v-color w-full border rounded-lg px-3 py-2">
                <option value="">-- chọn màu --</option>
                <% (productColors||[]).forEach(c=>{ %>
                  <option value="<%= c._id %>">
                    <%= c.color_name %>
                  </option>
                  <% }) %>
              </select>
            </div>

            <div class="col-span-6 md:col-span-2">
              <label class="block text-sm font-medium">Size (id)</label>
              <select class="v-size w-full border rounded-lg px-3 py-2">
                <option value="">-- chọn size --</option>
                <% (productSizes||[]).forEach(s=>{ %>
                  <option value="<%= s._id %>">
                    <%= s.size_name %>
                  </option>
                  <% }) %>
              </select>
            </div>

            <div class="col-span-6 md:col-span-2">
              <label class="block text-sm font-medium">Giá (₫)</label>
              <input type="number" min="0" step="1" class="v-price w-full border rounded-lg px-3 py-2" placeholder="0">
            </div>

            <div class="col-span-6 md:col-span-1">
              <label class="block text-sm font-medium">Tồn kho</label>
              <input type="number" min="0" step="1" class="v-stock w-full border rounded-lg px-3 py-2" placeholder="0">
            </div>

            <!-- Ảnh riêng của biến thể: name sẽ thành variantImagesMap[i][] -->
            <div class="col-span-12 md:col-span-7">
              <label class="block text-sm font-medium">Ảnh biến thể (nhiều ảnh)</label>
              <input type="file" class="v-images w-full border rounded-lg px-3 py-2" name="variantImagesMap[__INDEX__]"
                multiple accept="image/*">
              <p class="text-xs text-slate-500 mt-1">Sẽ gửi theo key <code>variantImagesMap[i]</code> (theo thứ tự biến
                thể).</p>
            </div>

            <div class="col-span-12 md:col-span-5 flex items-end justify-end">
              <button type="button" class="v-remove rounded-lg px-3 py-2 bg-red-600 text-white">Xoá</button>
            </div>
          </div>
        </template>
      </form>
    </section>

    <!-- ✅ JSON init an toàn (không cần escape dấu nháy) -->
    <script id="variants-init" type="application/json">
<%- JSON.stringify(
  (P && Array.isArray(P.variants) && P.variants.length
    ? P.variants.map(v => ({
        color: v && v.color ? String(v.color) : '',
        size:  v && v.size  ? String(v.size)  : '',
        sku: String((v && v.sku) || ''),
        price: Number((v && v.price) || 0),
        stock_quantity: Number((v && v.stock_quantity) || 0)
      }))
    : [{ sku:'', price:0, stock_quantity:0, color:'', size:'' }]
), null, 0) %>
</script>

    <!-- Logic biến thể (khởi tạo, đồng bộ hidden, đánh số input file) -->
    <script>
      (function () {
        const form = document.getElementById('product-form');
        const root = document.getElementById('variantsRoot');
        const list = document.getElementById('variantsList');
        const tpl = document.getElementById('tplVariantRow');
        const debug = document.getElementById('debug');

        const getVariantInputs = () => Array.from(document.querySelectorAll('input[name="variants"]'));

        const log = (...a) => {
          console.log('[variants]', ...a);
          if (debug) debug.textContent = JSON.stringify(a, null, 2) + '\n' + (debug.textContent || '');
        };

        function readVariants() {
          return Array.from(list.querySelectorAll('.variant-row')).map(row => ({
            sku: (row.querySelector('.v-sku').value || '').trim(),
            color: (row.querySelector('.v-color').value || '').trim(),
            size: (row.querySelector('.v-size').value || '').trim(),
            price: Number(row.querySelector('.v-price').value || 0),
            stock_quantity: Number(row.querySelector('.v-stock').value || 0),
          }));
        }

        function syncHidden() {
          const arr = readVariants();
          const json = JSON.stringify(arr);
          getVariantInputs().forEach(i => i.value = json);
          log('sync -> variants JSON', arr);
        }

        function renumberVariantRows() {
          const rows = Array.from(list.querySelectorAll('.variant-row'));
          rows.forEach((row, i) => {
            row.dataset.index = String(i);
            const file = row.querySelector('.v-images');
            if (file) file.setAttribute('name', `variantImagesMap[${i}]`);
          });
        }

        function attachRowEvents(rowEl) {
          rowEl.querySelectorAll('input[type="text"], input[type="number"], select')
            .forEach(i => i.addEventListener('input', syncHidden));
          rowEl.querySelector('.v-remove').addEventListener('click', () => {
            rowEl.remove();
            renumberVariantRows();
            syncHidden();
          });
          const fileInput = rowEl.querySelector('.v-images');
          if (fileInput) {
            fileInput.addEventListener('change', () => {
              const holder = fileInput.closest('.col-span-12') || fileInput.parentElement;
              const previews = holder.querySelectorAll('[data-variant-preview]');
              previews.forEach(p => p.remove());
            });
          }
        }

        function addVariantRow(initial = { sku: '', color: '', size: '', price: 0, stock_quantity: 0 }) {
          const fragment = tpl.content.cloneNode(true);
          const el = fragment.querySelector('.variant-row');

          el.querySelector('.v-sku').value = initial.sku ?? '';
          el.querySelector('.v-color').value = initial.color ?? '';
          el.querySelector('.v-size').value = initial.size ?? '';
          el.querySelector('.v-price').value = initial.price ?? 0;
          el.querySelector('.v-stock').value = initial.stock_quantity ?? 0;

          const nextIndex = list.querySelectorAll('.variant-row').length;
          el.querySelector('.v-images').setAttribute('name', `variantImagesMap[${nextIndex}]`);

          attachRowEvents(el);
          list.appendChild(fragment);
          renumberVariantRows();
          syncHidden();
        }

        // ✅ Đọc init từ <script type="application/json">
        let init = [];
        try {
          const el = document.getElementById('variants-init');
          init = el && el.textContent ? JSON.parse(el.textContent) : [];
        } catch (e) {
          console.warn('[variants] init parse failed:', e);
          init = [];
        }

        if (Array.isArray(init) && init.length) init.forEach(v => addVariantRow(v));
        else addVariantRow();
        log('mounted with init', init);

        document.getElementById('btnAddVariant').addEventListener('click', () => addVariantRow());

        form.addEventListener('submit', () => {
          renumberVariantRows();
          syncHidden();

          const filesDebug = Array.from(list.querySelectorAll('.v-images')).map((f, i) => ({
            index: i,
            name: f.getAttribute('name'),
            filesCount: f.files ? f.files.length : 0,
            fileNames: f.files ? Array.from(f.files).map(x => x.name) : []
          }));
          log('final file inputs:', filesDebug);
          log('final variants hidden values:', getVariantInputs().map(i => i.value));
        });
      })();
    </script>

    <!-- Preview ảnh của từng biến thể (chỉ khi EDIT có P.variants) -->
    <% if (P && Array.isArray(P.variants)) { %>
      <script>
        (function () {
          const variantsFromApi = <%- JSON.stringify(P.variants || []) %>;
          setTimeout(() => {
            const rows = document.querySelectorAll('#variantsList .variant-row');
            rows.forEach((row, i) => {
              const v = variantsFromApi[i];
              if (!v || !Array.isArray(v.images) || !v.images.length) return;
              const wrap = document.createElement('div');
              wrap.className = 'mt-2 flex gap-2 flex-wrap';
              wrap.setAttribute('data-variant-preview', '1');
              v.images.forEach(img => {
                const el = document.createElement('img');
                el.src = img.url;
                el.className = 'w-14 h-14 object-cover rounded border';
                wrap.appendChild(el);
              });
              const fileCell = row.querySelector('.v-images')?.closest('.col-span-12, .md\\:col-span-7') || row.querySelector('.v-images')?.parentElement;
              if (fileCell) fileCell.appendChild(wrap);
            });
          }, 0);
        })();
      </script>
      <% } %>