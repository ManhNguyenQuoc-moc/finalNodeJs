<style>
  .checkbox-custom {
    appearance: none;
    -webkit-appearance: none;
    width: 1rem;
    /* h-4 */
    height: 1rem;
    border-radius: 0.25rem;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: 1.5px solid #cbd5e1;
    /* slate-300 */
    background-color: #f1f5f9;
    /* slate-100 */
    transition: all .15s ease;
  }

  .checkbox-custom:hover {
    border-color: #94a3b8;
    /* slate-400 */
  }

  .checkbox-custom:checked {
    background-color: #059669;
    /* emerald-600 */
    border-color: #059669;
  }

  .checkbox-custom:checked::after {
    content: "✓";
    font-size: 0.75rem;
    font-weight: 700;
    color: white;
    margin-top: -1px;
  }
</style>

<% layout('layouts/admin') %>

  <section class="space-y-6">
    <!-- HEADER -->
    <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h1 class="flex items-center gap-2 text-2xl font-semibold tracking-tight text-slate-900">
          <i data-lucide="box" class="h-8 w-8 text-emerald-500"></i>
          Sản phẩm
        </h1>
        <p class="mt-1 text-sm text-slate-500">
          Tìm kiếm, lọc và quản trị danh sách sản phẩm trong hệ thống Mixishop.
        </p>
      </div>

      <div class="flex items-center gap-2">
        <!-- Tổng số sản phẩm -->
        <div class="hidden sm:flex flex-col items-end text-sm text-slate-600">

          <div class="inline-flex items-center gap-2 rounded-xl bg-slate-100 px-3 py-1.5 shadow-sm">
            <span class="text-[12px] uppercase font-semibold tracking-wide text-slate-500">
              Tổng sản phẩm
            </span>

            <span class="text-base font-bold text-slate-900 leading-none">
              <%= (total||0).toLocaleString?.('vi-VN') || total || 0 %>
            </span>
          </div>

        </div>


        <a href="/admin/products/new"
          class="inline-flex items-center justify-center gap-2 rounded-xl bg-emerald-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm transition-all duration-150 hover:-translate-y-0.5 hover:bg-emerald-700 hover:shadow-md focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-400">
          <i data-lucide="plus" class="h-6 w-6"></i>
          <span>Thêm sản phẩm</span>
        </a>
      </div>
    </div>

    <!-- FILTERS -->
    <form id="products-filter-form"
      class="grid grid-cols-1 gap-3 rounded-2xl border border-slate-200 bg-white/70 p-4 shadow-sm backdrop-blur-sm lg:grid-cols-6"
      method="get">
      <div class="lg:col-span-2">
        <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-600">
          Từ khóa / SKU
        </label>
        <div class="relative">
          <i data-lucide="search"
            class="pointer-events-none absolute left-3 top-1/2 h-6 w-6 -translate-y-1/2 text-slate-400"></i>
          <input
            class="w-full rounded-xl border border-slate-200 bg-white px-9 py-2.5 text-sm text-slate-800 shadow-sm outline-none ring-0 placeholder:text-slate-400 focus:border-emerald-400 focus:ring-2 focus:ring-emerald-400/30"
            name="q" value="<%= (query && query.q) || '' %>" placeholder="Nhập tên sản phẩm, SKU..." />
        </div>
      </div>

      <div>
        <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-600">
          Thương hiệu
        </label>
        <div class="relative">
          <select
            class="w-full appearance-none rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm text-slate-800 shadow-sm outline-none focus:border-emerald-400 focus:ring-2 focus:ring-emerald-400/30"
            name="brand">
            <option value="">— Tất cả thương hiệu —</option>
            <% (brands||[]).forEach(b=>{ %>
              <option value="<%= b._id %>" <%=(query && query.brand)===String(b._id)?'selected':'' %>>
                <%= b.name %>
              </option>
              <% }) %>
          </select>
          <i data-lucide="chevron-down"
            class="pointer-events-none absolute right-3 top-1/2 h-6 w-6 -translate-y-1/2 text-slate-400"></i>
        </div>
      </div>

      <div>
        <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-600">
          Danh mục
        </label>
        <div class="relative">
          <select
            class="w-full appearance-none rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm text-slate-800 shadow-sm outline-none focus:border-emerald-400 focus:ring-2 focus:ring-emerald-400/30"
            name="category">
            <option value="">— Tất cả danh mục —</option>
            <% (categories||[]).forEach(c=>{ %>
              <option value="<%= c._id %>" <%=(query && query.category)===String(c._id)?'selected':'' %>>
                <%= c.name %>
              </option>
              <% }) %>
          </select>
          <i data-lucide="chevron-down"
            class="pointer-events-none absolute right-3 top-1/2 h-6 w-6 -translate-y-1/2 text-slate-400"></i>
        </div>
      </div>

      <div>
        <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-600">
          Giá từ
        </label>
        <input
          class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm text-slate-800 shadow-sm outline-none focus:border-emerald-400 focus:ring-2 focus:ring-emerald-400/30"
          type="number" name="min" step="1000" placeholder="Tối thiểu" value="<%= (query && query.min) || '' %>" />
      </div>

      <div>
        <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-600">
          Đến
        </label>
        <input
          class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm text-slate-800 shadow-sm outline-none focus:border-emerald-400 focus:ring-2 focus:ring-emerald-400/30"
          type="number" name="max" step="1000" placeholder="Tối đa" value="<%= (query && query.max) || '' %>" />
      </div>

      <div>
        <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-600">
          Sắp xếp
        </label>
        <div class="relative">
          <select
            class="w-full appearance-none rounded-xl border border-slate-200 bg-white px-3 py-2.5 text-sm text-slate-800 shadow-sm outline-none focus:border-emerald-400 focus:ring-2 focus:ring-emerald-400/30"
            name="sort">
            <option value="">— Mặc định —</option>
            <option value="name_asc" <%=(query && query.sort)==='name_asc' ?'selected':'' %>>Tên A→Z</option>
            <option value="name_desc" <%=(query && query.sort)==='name_desc' ?'selected':'' %>>Tên Z→A</option>
            <option value="price_asc" <%=(query && query.sort)==='price_asc' ?'selected':'' %>>Giá tăng dần</option>
            <option value="price_desc" <%=(query && query.sort)==='price_desc' ?'selected':'' %>>Giá giảm dần</option>
            <option value="created_desc" <%=(query && query.sort)==='created_desc' ?'selected':'' %>>Mới nhất</option>
          </select>
          <i data-lucide="chevron-down"
            class="pointer-events-none absolute right-3 top-1/2 h-6 w-6 -translate-y-1/2 text-slate-400"></i>
        </div>
      </div>

      <div class="mt-1 flex flex-wrap items-center justify-end gap-2 lg:col-span-6">
        <a href="/admin/products"
          class="inline-flex items-center justify-center gap-2 rounded-xl border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-700 shadow-sm transition hover:bg-slate-50 focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-300">
          <i data-lucide="rotate-ccw" class="h-6 w-6"></i>
          Xóa lọc
        </a>
        <button
          class="inline-flex items-center justify-center gap-2 rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-slate-800 focus:outline-none focus-visible:ring-2 focus-visible:ring-slate-900/70">
          <i data-lucide="filter" class="h-6 w-6"></i>
          Lọc
        </button>
      </div>
    </form>
    <div id="products-table-wrapper">
      <%- include('partials/_products_table', { items, total, pagination, query }) %>
    </div>

  </section>

  <script>
    // Hàm bulk checkbox bạn đã có, chỉ cần chắc chắn tên là initProductsBulkUI
    function initProductsBulkUI() {
      const master = document.getElementById("select-all-products");
      const rowChecks = Array.from(document.querySelectorAll(".product-row-check"));
      const bulkBar = document.getElementById("bulk-bar");
      const bulkCount = document.getElementById("bulk-count");

      if (!master || !rowChecks.length) {
        if (bulkBar) bulkBar.classList.add("hidden");
        return;
      }

      function updateBulkUI() {
        const selected = rowChecks.filter(c => c.checked).length;
        if (bulkCount) bulkCount.textContent = selected;
        if (bulkBar) {
          bulkBar.classList.toggle("hidden", selected === 0);
        }
      }

      master.addEventListener("change", function () {
        const checked = master.checked;
        rowChecks.forEach(c => { c.checked = checked; });
        updateBulkUI();
      });

      rowChecks.forEach(c => {
        c.addEventListener("change", function () {
          const allChecked = rowChecks.every(x => x.checked);
          master.checked = allChecked;
          updateBulkUI();
        });
      });

      updateBulkUI();
    }

    document.addEventListener("DOMContentLoaded", function () {
      const filterForm = document.getElementById("products-filter-form");
      const tableWrapper = document.getElementById("products-table-wrapper");

      if (!filterForm || !tableWrapper) return;

      initProductsBulkUI();

      // build URL từ form + page
      function buildUrl(page) {
        const fd = new FormData(filterForm);
        const params = new URLSearchParams();

        for (const [k, v] of fd.entries()) {
          if (v !== "") params.append(k, v);
        }

        if (page) params.set("page", page);
        params.set("ajax", "1");

        return "/admin/products?" + params.toString();
      }

      function loadAjax(url) {
        fetch(url, {
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            "Accept": "application/json",
          },
        })
          .then(r => r.json())
          .then(data => {
            if (!data || !data.ok) {
              console.error("products ajax error:", data && data.error);
              return;
            }

            // thay bảng
            tableWrapper.innerHTML = data.html;

            // re-init bulk checkbox cho HTML mới
            initProductsBulkUI();

            // cập nhật URL (loại ajax=1)
            try {
              const u = new URL(url, window.location.origin);
              u.searchParams.delete("ajax");
              window.history.replaceState({}, "", u.toString());
            } catch (e) {
              console.warn(e);
            }
          })
          .catch(err => console.error(err));
      }

      // --- submit form (nút Lọc hoặc Enter) ---
      filterForm.addEventListener("submit", function (e) {
        e.preventDefault();
        const url = buildUrl(1); // luôn quay về page 1 khi lọc
        loadAjax(url);
      });

      // --- tự lọc khi đổi brand/category/sort (optional) ---
      ["brand", "category", "sort"].forEach(name => {
        const el = filterForm.elements[name];
        if (el) {
          el.addEventListener("change", function () {
            const url = buildUrl(1);
            loadAjax(url);
          });
        }
      });

      // --- click phân trang dùng event delegation trên wrapper ---
      tableWrapper.addEventListener("click", function (e) {
        const link = e.target.closest("a.js-products-page");
        if (!link) return;
        e.preventDefault();

        const page = link.dataset.page || 1;
        const url = buildUrl(page);
        loadAjax(url);
      });
    });
  </script>