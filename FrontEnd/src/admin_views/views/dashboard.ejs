<% layout('layouts/admin') %>

  <!-- (Tuỳ chọn) Form filter server-side -->
  <form action="/admin" method="get" class="mb-4 flex flex-wrap items-center gap-2">
    <input type="hidden" name="mode" value="<%= (filters && filters.mode) || 'simple' %>" />
    <input type="date" class="input" name="start" value="<%= (filters && filters.start) || '' %>" />
    <span class="text-slate-400">→</span>
    <input type="date" class="input" name="end" value="<%= (filters && filters.end) || '' %>" />
    <select class="input" name="granularity">
      <option value="year" <%=(filters && filters.granularity)==='year' ?'selected':''%>>Năm</option>
      <option value="quarter" <%=(filters && filters.granularity)==='quarter' ?'selected':''%>>Quý</option>
      <option value="month" <%=(filters && filters.granularity)==='month' ?'selected':''%>>Tháng</option>
      <option value="week" <%=(filters && filters.granularity)==='week' ?'selected':''%>>Tuần</option>
    </select>
    <button class="btn-primary">Áp dụng</button>
  </form>

  <!-- React mount -->
  <div id="recharts-root"></div>

  <!-- Inject server data if available -->
  <script>
    window.__DASHBOARD__ = {
      charts: <% - JSON.stringify(charts || {}) %>,
      kpis: <% - JSON.stringify(kpis || []) %>,
      topProducts: <% - JSON.stringify(topProducts || []) %>,
      filters: <% - JSON.stringify(filters || {}) %>
  };
  </script>

  <!-- Optional tiny styles for tabs/card-title if dự án bạn chưa có -->
  <style>
    .btn-tab {
      @apply rounded-lg px-3 py-1.5 text-sm text-slate-600 hover:bg-slate-50;
    }

    .btn-tab-active {
      @apply bg-indigo-600 text-white hover:bg-indigo-600;
    }

    .card {
      @apply rounded-2xl border border-slate-200 bg-white p-4 shadow-sm;
    }

    .card-title {
      @apply text-sm font-semibold tracking-wide text-slate-800;
    }

    .hover\:shadow-soft:hover {
      box-shadow: 0 6px 24px 0 rgb(15 23 42 / 0.06);
    }
  </style>

  <!-- Recharts UI (Babel + CDN) -->
  <script type="text/babel">
    const {
      LineChart, Line, BarChart, Bar, PieChart, Pie, Cell,
      XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer,
      ComposedChart
    } = Recharts;

    const COLORS = ["#10b981", "#60a5fa", "#f59e0b", "#ef4444", "#8b5cf6", "#14b8a6", "#f43f5e", "#22c55e"];

    // ---- MOCK DATA (dùng ngay nếu server chưa bơm dữ liệu) ----
    const SAMPLE = {
      filters: { mode: "simple", granularity: "month" },
      kpis: [
        { label: "Doanh thu", value: 128_500_000, valueDisplay: "128.5M đ", delta: 12, icon: "line-chart" },
        { label: "Lợi nhuận", value: 35_200_000, valueDisplay: "35.2M đ", delta: 7, icon: "circle-dollar-sign" },
        { label: "Số đơn", value: 742, valueDisplay: "742", delta: -3, icon: "shopping-bag" },
        { label: "Tỉ lệ chuyển đổi", value: 2.8, valueDisplay: "2.8%", delta: 0.6, icon: "sparkle" }
      ],
      charts: {
        revenue: {
          labels: ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
          revenue: [8, 9.5, 10, 11.2, 10.8, 12.5, 13.6, 14.2, 15, 16.4, 17.1, 19].map(v => v * 1e6),
          profit: [2, 2.3, 2.5, 2.8, 2.6, 3.0, 3.3, 3.4, 3.6, 3.9, 4.1, 4.6].map(v => v * 1e6)
        },
        orders: {
          labels: ["01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12"],
          orders: [40, 52, 60, 65, 58, 70, 71, 72, 74, 75, 81, 94]
        },
        compare: {
          labels: ["W1", "W2", "W3", "W4", "W5", "W6", "W7", "W8"],
          revenue: [3.2, 3.9, 4.1, 4.5, 4.3, 4.9, 5.1, 5.6].map(v => v * 1e6),
          profit: [0.9, 1.1, 1.2, 1.3, 1.2, 1.4, 1.5, 1.6].map(v => v * 1e6),
          orders: [60, 62, 64, 63, 70, 75, 80, 86],
          productsCount: [120, 118, 130, 126, 140, 150, 158, 166]
        }
      },
      topProducts: Array.from({ length: 10 }).map((_, i) => ({
        name: `SP #${i + 1}`, total_sold: Math.round(100 - i * 7) + 20
      }))
    };

    function pickData() {
      const d = window.__DASHBOARD__ || {};
      const hasCharts = d.charts && d.charts.revenue && d.charts.orders && d.charts.compare;
      const hasKPIs = Array.isArray(d.kpis) && d.kpis.length > 0;
      const hasTop = Array.isArray(d.topProducts) && d.topProducts.length > 0;

      return {
        charts: hasCharts ? d.charts : SAMPLE.charts,
        kpis: hasKPIs ? d.kpis : SAMPLE.kpis,
        topProducts: hasTop ? d.topProducts : SAMPLE.topProducts,
        filters: d.filters && Object.keys(d.filters).length ? d.filters : SAMPLE.filters
      };
    }

    function AdminDashboard() {
      const { charts, kpis, topProducts, filters } = pickData();

      // Chuẩn hoá data cho charts
      const revenueData = charts.revenue.labels.map((label, i) => ({
        label, revenue: charts.revenue.revenue[i], profit: charts.revenue.profit[i]
      }));
      const ordersData = charts.orders.labels.map((label, i) => ({
        label, orders: charts.orders.orders[i]
      }));
      const compareData = charts.compare.labels.map((label, i) => ({
        label,
        revenue: charts.compare.revenue[i],
        profit: charts.compare.profit[i],
        orders: charts.compare.orders[i],
        productsCount: charts.compare.productsCount?.[i] ?? 0
      }));

      const [tab, setTab] = React.useState(filters?.mode || "simple");

      return (
        <section className="space-y-6">
          {/* Tabs */}
          <div className="flex items-center justify-between gap-3">
            <div className="flex items-center gap-2 bg-white border rounded-xl p-1">
              <button onClick={() => setTab("simple")} className={`btn-tab ${tab === 'simple' ? 'btn-tab-active' : ''}`}>Cơ bản</button>
              <button onClick={() => setTab("advanced")} className={`btn-tab ${tab === 'advanced' ? 'btn-tab-active' : ''}`}>Nâng cao</button>
            </div>
          </div>

          {/* KPI cards */}
          <div className="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-4">
            {kpis.map((k, idx) => (
              <div key={idx} className="card group hover:shadow-soft transition">
                <div className="flex items-center justify-between">
                  <div>
                    <div className="text-sm text-slate-500">{k.label}</div>
                    <div className="mt-1 text-2xl font-semibold">{k.valueDisplay ?? k.value}</div>
                    <div className="mt-1 text-xs">
                      <span className={`${k.delta >= 0 ? "text-emerald-600" : "text-rose-600"} inline-flex items-center gap-1`}>
                        {(k.delta > 0 ? `+${k.delta}` : k.delta)}% so với kỳ trước
                      </span>
                    </div>
                  </div>
                  <div className="grid h-10 w-10 place-items-center rounded-xl bg-indigo-50 text-indigo-600 ring-1 ring-indigo-200">
                    <i className={`lucide lucide-${k.icon}`}></i>
                  </div>
                </div>
              </div>
            ))}
          </div>

          {/* SIMPLE */}
          {tab === "simple" && (
            <div className="grid grid-cols-1 gap-4 lg:grid-cols-3">
              <div className="card lg:col-span-2">
                <h3 className="card-title mb-3">Doanh thu & Lợi nhuận</h3>
                <div className="h-[320px]">
                  <ResponsiveContainer width="100%" height="100%">
                    <LineChart data={revenueData}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="label" /><YAxis /><Tooltip /><Legend />
                      <Line type="monotone" dataKey="revenue" name="Doanh thu" strokeWidth={2} dot={false} />
                      <Line type="monotone" dataKey="profit" name="Lợi nhuận" strokeWidth={2} dot={false} />
                    </LineChart>
                  </ResponsiveContainer>
                </div>
              </div>

              <div className="card">
                <h3 className="card-title mb-3">Số đơn theo kỳ</h3>
                <div className="h-[320px]">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={ordersData}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="label" /><YAxis /><Tooltip /><Legend />
                      <Bar dataKey="orders" name="Số đơn" />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </div>

              <div className="card lg:col-span-3">
                <div className="mb-3 flex items-center justify-between">
                  <h3 className="card-title">Sản phẩm bán chạy</h3>
                  <span className="text-xs text-slate-500">Top 10</span>
                </div>
                <div className="grid grid-cols-1 gap-4 lg:grid-cols-2">
                  {/* Bar ngang */}
                  <div className="h-[280px]">
                    <ResponsiveContainer width="100%" height="100%">
                      <BarChart data={topProducts} layout="vertical" margin={{ left: 16 }}>
                        <CartesianGrid strokeDasharray="3 3" />
                        <XAxis type="number" /><YAxis type="category" dataKey="name" width={120} />
                        <Tooltip /><Legend />
                        <Bar dataKey="total_sold" name="Bán ra" />
                      </BarChart>
                    </ResponsiveContainer>
                  </div>
                  {/* Pie */}
                  <div className="h-[280px]">
                    <ResponsiveContainer width="100%" height="100%">
                      <PieChart>
                        <Tooltip /><Legend />
                        <Pie data={topProducts.slice(0, 6)} dataKey="total_sold" nameKey="name" outerRadius={100}>
                          {topProducts.slice(0, 6).map((_, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} />)}
                        </Pie>
                      </PieChart>
                    </ResponsiveContainer>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* ADVANCED */}
          {tab === "advanced" && (
            <div className="grid grid-cols-1 gap-4 lg:grid-cols-3">
              <div className="card lg:col-span-2">
                <h3 className="card-title mb-3">So sánh đa chỉ số (theo thời gian)</h3>
                <div className="h-[340px]">
                  <ResponsiveContainer width="100%" height="100%">
                    <ComposedChart data={compareData}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="label" /><YAxis /><Tooltip /><Legend />
                      <Bar dataKey="orders" name="Số đơn" />
                      <Line type="monotone" dataKey="revenue" name="Doanh thu" strokeWidth={2} dot={false} />
                      <Line type="monotone" dataKey="profit" name="Lợi nhuận" strokeWidth={2} dot={false} />
                    </ComposedChart>
                  </ResponsiveContainer>
                </div>
              </div>

              <div className="card">
                <h3 className="card-title mb-3">Số lượng sản phẩm bán theo kỳ</h3>
                <div className="h-[320px]">
                  <ResponsiveContainer width="100%" height="100%">
                    <BarChart data={compareData}>
                      <CartesianGrid strokeDasharray="3 3" />
                      <XAxis dataKey="label" /><YAxis /><Tooltip /><Legend />
                      <Bar dataKey="productsCount" name="Số lượng SP bán" />
                    </BarChart>
                  </ResponsiveContainer>
                </div>
              </div>
            </div>
          )}
        </section>
      );
    }

    // Mount React
    const root = ReactDOM.createRoot(document.getElementById("recharts-root"));
    root.render(<AdminDashboard />);
  </script>