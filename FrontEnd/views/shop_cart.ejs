<!DOCTYPE html>
<html dir="ltr" lang="zxx">
<head>
  <%- include('partials/head') %>
  <style>
    .cart-item {
      display: flex;
      align-items: center;
      gap: 20px;
      padding: 14px;
      border: 1px solid #eee;
      border-radius: 8px;
      background: #fff;
    }
    .item-thumb img { width: 70px; height: 90px; object-fit: cover; border-radius: 6px; }
    .item-info { flex: 1; min-width: 150px; }
    .item-name { font-weight: 700; margin-bottom: 4px; }
    .item-variant { color: #666; font-size: 14px; }

    .item-qty { display: flex; align-items: center; border: 1px solid #ddd; border-radius: 4px; overflow: hidden; }
    .qty-btn { width: 32px; height: 32px; border: none; background: #f3f4f6; cursor: pointer; }
    .qty-input { width: 50px; height: 32px; border: none; text-align: center; }

    .item-price { font-weight: 600; min-width: 90px; text-align: right; }

    .item-total { text-align: right; min-width: 120px; }
    .item-total .label { color: #555; font-size: 14px; margin-right: 4px; }
    .item-total .value { font-weight: 700; color: #d00; display: block; }
    .remove-cart { border: none; background: transparent; color: #999; cursor: pointer; margin-top: 4px; }
    .remove-cart:hover { color: #000; }

    .cart-layout{display:grid;grid-template-columns:minmax(0,1fr) 360px;gap:28px}
    @media (max-width: 992px){.cart-layout{grid-template-columns:1fr}}

    .cart-header{background:#f6f7f9;border-radius:10px;padding:12px 16px;font-weight:600}

    .cart-item{display:flex;gap:18px;padding:18px;border:1px solid #eee;border-radius:12px;background:#fff;margin-top:14px}
    .item-thumb img{width:96px;height:96px;object-fit:cover;border-radius:10px}
    .item-main{flex:1}
    .item-title a{font-weight:700;color:#111;text-decoration:none}
    .item-opts{color:#6b7280;margin-top:4px}

    .item-controls{display:flex;align-items:center;gap:18px;margin-top:12px;flex-wrap:wrap}
    .qty{display:flex;align-items:center;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden}
    .qty-btn{width:36px;height:36px;border:0;background:#fafafa;cursor:pointer}
    .qty-input{width:58px;height:36px;border:0;text-align:center;outline:none}
    .unit,.line{min-width:110px;font-weight:600}
    .trash{background:transparent;border:0;cursor:pointer;color:#9ca3af}

    .cart-note-policy{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-top:24px}
    @media (max-width: 768px){.cart-note-policy{grid-template-columns:1fr}}
    .note-title,.policy-title{font-weight:700;margin-bottom:10px}
    .note textarea{width:100%;min-height:160px;border:1px solid #e5e7eb;border-radius:10px;padding:12px}

    .cart-right .next-title{color:#6b7280;margin-bottom:10px;text-align:right}
    .summary{border:1px solid #eee;border-radius:12px;padding:18px;background:#fff;position:sticky;top:20px}
    .summary-title{font-weight:800;margin-bottom:14px;font-size:18px}
    .summary-row{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-top:1px solid #f1f5f9}
    .summary-row:first-of-type{border-top:0}
    .summary-hint{font-size:14px;color:#6b7280;margin:10px 0 18px}
    .btn-checkout{display:block;width:100%;text-align:center;background:#000;color:#fff;padding:14px;border-radius:8px;font-weight:800;text-decoration:none}
    .btn-checkout:hover{filter:brightness(.95)}
  </style>
</head>

<body>
  <%- include('partials/icons') %>
  <%- include('partials/header', { headerType: 'header' }) %>

  <main>
    <div class="mb-4 pb-4"></div>
    <section class="shop-checkout container">
      <h3 class="mb-3">Th√¥ng tin giao h√†ng</h3>

      <% if (isEmpty) { %>
  <div class="text-center my-4">Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng. Vui l√≤ng th√™m s·∫£n ph·∫©m tr∆∞·ªõc khi thanh to√°n.</div>
<% } else { 
     // CHU·∫®N HO√Å AN TO√ÄN: lu√¥n render ƒë∆∞·ª£c, kh√¥ng hi·ªán c·∫£nh b√°o
     const normalized = (carts || []).map((c, i) => {
       const p   = (c.productColor && c.productColor.product) || {};
       const pid = p.id || p._id || c.productId || c.product_id || '';
       const name= p.name || c.productName || c.name_snapshot || 'S·∫£n ph·∫©m';
       const qty = Number(c.quantity || c.qty || 1);
       const unit= Number(
         p.price ??
         c.unitPrice ??
         c.price_at_time ??
         0
       );
       const img = (c.productColor && c.productColor.imageUrls && c.productColor.imageUrls[0]) 
                   || c.img_snapshot 
                   || '/images/default.png';
       const color = (c.productColor && c.productColor.color)
                     || c.color_name_snapshot
                     || '‚Äî';
       const size  = (c.productSize && (c.productSize.size || c.productSize.name))
                     || c.size_name_snapshot
                     || '‚Äî';
       return {
         id: (typeof c.id !== 'undefined' ? c.id : i), // gi·ªØ index ƒë·ªÉ /cart/update/:idx & /cart/remove/:idx d√πng ƒë∆∞·ª£c
         pid, name, qty, unit, line: unit * qty, img, color, size
       };
     });
%>

<div class="cart-layout">
  <div class="cart-left">
    <div class="cart-header">B·∫°n ƒëang c√≥ <%= normalized.length %> s·∫£n ph·∫©m trong gi·ªè h√†ng</div>

    <% normalized.forEach(function(it){ %>
      <div class="cart-item" id="cart-item-<%= it.id %>">
        <a class="item-thumb" href="/product_detail/<%= it.pid %>">
          <img src="<%= it.img %>" alt="<%= it.name %>">
        </a>

        <div class="item-info">
          <div class="item-name"><%= it.name %></div>
          <div class="item-variant"><%= it.color %> / <%= it.size %></div>
        </div>

        <div class="item-qty">
          <button type="button" class="qty-btn btn-dec" data-id="<%= it.id %>">-</button>
          <input class="qty-input" id="qty-<%= it.id %>" type="number" min="1" value="<%= it.qty %>">
          <button type="button" class="qty-btn btn-inc" data-id="<%= it.id %>">+</button>
        </div>

        <div class="item-total">
          <span class="label">Th√†nh ti·ªÅn:</span>
          <span class="value text-danger" id="line-<%= it.id %>"><%= it.line.toLocaleString('vi-VN') %>ƒë</span>
          <button type="button" class="remove-cart" data-id="<%= it.id %>">üóë</button>
        </div>

        <div class="item-price"><%= it.unit.toLocaleString('vi-VN') %>ƒë</div>
      </div>
    <% }) %>

  </div>

  <aside class="cart-right">
    <div class="next-title">Ti·∫øp t·ª•c mua h√†ng ‚Üí</div>
    <div class="summary">
      <div class="summary-title">Th√¥ng tin ƒë∆°n h√†ng</div>
      <div class="summary-row">
        <span>T·ªïng ti·ªÅn:</span>
        <strong id="sum-total"><%= formattedTotal %></strong>
      </div>
      <div class="summary-hint">
        B·∫°n c√≥ th·ªÉ nh·∫≠p m√£ gi·∫£m gi√° ·ªü trang thanh to√°n
      </div>
      <a href="/shop-cart/checkout" class="btn-checkout">THANH TO√ÅN</a>
    </div>
  </aside>
</div>

<% } %>

    </section>
  </main>

  <div class="mb-5 pb-xl-5"></div>
  <%- include('partials/footer') %>
  <%- include('partials/login_form') %>
  <%- include('partials/cart_drawer') %>
  <%- include('partials/sitemap') %>
  <%- include('partials/quick_view') %>
  <div id="scrollTop" class="visually-hidden end-0"></div>
  <div class="page-overlay"></div>

  <script src="/mixishop/js/plugins/jquery.min.js"></script>
  <script src="/mixishop/js/plugins/bootstrap.bundle.min.js"></script>
  <script src="/mixishop/js/plugins/bootstrap-slider.min.js"></script>
  <script src="/mixishop/js/plugins/swiper.min.js"></script>
  <script src="/mixishop/js/plugins/countdown.js"></script>
  <script src="/mixishop/js/plugins/jquery.fancybox.js"></script>
  <script src="/mixishop/js/theme.js"></script>

  <script>
    const fmt = n => (Number(n||0)).toLocaleString('vi-VN') + 'ƒë';

    function updateSum(total) {
      const el = document.getElementById('sum-total');
      if (el) el.textContent = fmt(total);
    }

    async function setQty(id, qty) {
      try {
        if (qty < 1) qty = 1;
        const res = await fetch(`/cart/update/${id}`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ quantity: qty })
        });
        const data = await res.json(); // c·∫ßn JSON {ok,lineTotal,totals:{total}}
        if (!data?.ok) throw new Error(data?.message || 'C·∫≠p nh·∫≠t th·∫•t b·∫°i');
        document.getElementById(`qty-${id}`).value = qty;
        document.getElementById(`line-${id}`).textContent = fmt(data.lineTotal);
        updateSum(data.totals.total);
      } catch (err) {
        console.error('setQty error:', err);
        alert('Kh√¥ng c·∫≠p nh·∫≠t ƒë∆∞·ª£c s·ªë l∆∞·ª£ng. Vui l√≤ng th·ª≠ l·∫°i!');
      }
    }

    async function removeItem(id) {
      try {
        const res = await fetch(`/cart/remove/${id}`, { method:'POST' });
        const data = await res.json(); // c·∫ßn JSON {ok,totals:{total}}
        if (!data?.ok) throw new Error(data?.message || 'Xo√° th·∫•t b·∫°i');
        const row = document.getElementById(`cart-item-${id}`);
        if (row) row.remove();
        updateSum(data.totals.total);
      } catch (err) {
        console.error('removeItem error:', err);
        alert('Kh√¥ng xo√° ƒë∆∞·ª£c s·∫£n ph·∫©m. Vui l√≤ng th·ª≠ l·∫°i!');
      }
    }

    document.addEventListener('click', (e)=>{
      const dec = e.target.closest('.btn-dec');
      if (dec) {
        e.preventDefault();
        const id = dec.dataset.id;
        const ip = document.getElementById(`qty-${id}`);
        setQty(id, parseInt(ip.value || '1',10) - 1);
        return;
      }
      const inc = e.target.closest('.btn-inc');
      if (inc) {
        e.preventDefault();
        const id = inc.dataset.id;
        const ip = document.getElementById(`qty-${id}`);
        setQty(id, parseInt(ip.value || '1',10) + 1);
        return;
      }
      const rm = e.target.closest('.remove-cart');
      if (rm) {
        e.preventDefault();
        removeItem(rm.dataset.id);
      }
    });

    document.querySelectorAll('.qty-input').forEach(ip=>{
      ip.addEventListener('change', (e)=>{
        e.preventDefault();
        const id = ip.id.replace('qty-','');
        setQty(id, parseInt(ip.value || '1',10));
      });
    });
  </script>

</body>
</html>
