<!DOCTYPE html>
<html lang="vi">
<%- include('partials/head') %>

<style>
  .toolbar-left{display:flex;align-items:center;gap:12px;flex-wrap:nowrap}
  .search-inline{width:clamp(360px,45vw,560px);max-width:100%}
  .search-pill{border-radius:999px;border:1px solid #ddd;overflow:hidden;background:#fff}
  .search-pill .input-group-text{padding:4px 8px;font-size:14px;color:#6c757d}
  .search-pill .form-control{padding:6px 10px;height:34px;font-size:14px;border:0;box-shadow:none}
  .search-pill .btn-primary{border-radius:999px;padding:0 16px;font-size:14px;height:34px;line-height:34px}
  .search-pill .btn-clear{border:0;background:transparent;font-size:18px;line-height:1;padding:0 8px;color:#8c8c8c}
  .search-pill .btn-clear:hover{color:#555}
  .breadcrumb{margin-bottom:0}
  @media (max-width:991.98px){ .toolbar-left{flex-wrap:wrap} .search-inline{width:100%} }

  .rating-stars .on{color:#ffc107}.rating-stars .off{color:#c7c7c7}
  .swatch_active{outline:2px solid #0d6efd;border-radius:4px}
  .pc__img-wrapper{position:relative}
  .category-banner__frame{position:absolute;inset:0;width:100%;height:100%;pointer-events:none}
  .filter-item label{cursor:pointer}
</style>

<body>
  <%- include('partials/header') %>

  <main>
    <section class="shop-main container d-flex pt-4 pt-xl-5">
      <!-- SIDEBAR -->
      <aside class="shop-sidebar side-sticky bg-body" id="shopFilter">
        <div class="aside-header d-flex d-lg-none align-items-center">
          <h3 class="text-uppercase fs-6 mb-0">Lọc theo</h3>
          <button class="btn-close-lg js-close-aside btn-close-aside ms-auto"></button>
        </div>

        <!-- CATEGORIES -->
        <div class="accordion" id="categories-list">
          <div class="accordion-item mb-4 pb-3">
            <h5 class="accordion-header">
              <button class="accordion-button p-0 border-0 fs-5 text-uppercase" type="button"
                      data-bs-toggle="collapse" data-bs-target="#accordion-filter-1" aria-expanded="true">
                Đồ Hiệu Mixi
              </button>
            </h5>
            <div id="accordion-filter-1" class="accordion-collapse collapse show border-0">
              <div class="accordion-body px-0 pb-0 pt-3">
                <ul class="list list-inline mb-0">
                  <% (categories || []).forEach(c => { %>
                    <li class="list-item">
                      <a href="/category/<%= c._id %>" class="menu-link py-1"><%= c.name %></a>
                    </li>
                  <% }) %>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- BRAND (CỐ ĐỊNH) -->
        <div class="accordion" id="brand-filters">
          <div class="accordion-item mb-4 pb-3">
            <h5 class="accordion-header">
              <button class="accordion-button p-0 border-0 fs-5 text-uppercase" type="button"
                      data-bs-toggle="collapse" data-bs-target="#accordion-filter-brand" aria-expanded="true">
                Thương hiệu
              </button>
            </h5>
            <div id="accordion-filter-brand" class="accordion-collapse collapse show border-0">
              <div class="accordion-body px-0 pb-0">
                <ul class="list-unstyled mb-0">
                  <% 
                    const picked = new Set((brand || '').split(',').filter(Boolean));
                    (brands || []).forEach(b => {
                      const name = typeof b === 'string' ? b : (b?.name || '');
                      if (!name) return;
                      const checked = picked.has(name);
                  %>
                    <li class="mb-2 filter-item">
                      <label class="d-flex align-items-center gap-2">
                        <input type="checkbox" class="form-check-input js-brand" value="<%= name %>" <%= checked ? 'checked' : '' %> >
                        <span><%= name %></span>
                      </label>
                    </li>
                  <% }) %>
                </ul>
              </div>
            </div>
          </div>
        </div>

        <!-- COLOR -->
        <div class="accordion" id="color-filters">
          <div class="accordion-item mb-4 pb-3">
            <h5 class="accordion-header">
              <button class="accordion-button p-0 border-0 fs-5 text-uppercase" type="button"
                      data-bs-toggle="collapse" data-bs-target="#accordion-filter-color" aria-expanded="true">
                Màu sắc
              </button>
            </h5>
            <div id="accordion-filter-color" class="accordion-collapse collapse show border-0">
              <div class="accordion-body px-0 pb-0">
                <div class="d-flex flex-wrap">
                  <div class="color-swatch text-center me-3 mb-3">
                    <a href="#" class="swatch-color js-filter" style="color:#000000" data-color="Đen"></a>
                    <div class="color-name">Đen</div>
                  </div>
                  <div class="color-swatch text-center me-3 mb-3">
                    <a href="#" class="swatch-color js-filter" style="color:#FFFFFF" data-color="Trắng"></a>
                    <div class="color-name">Trắng</div>
                  </div>
                  <div class="color-swatch text-center me-3 mb-3">
                    <a href="#" class="swatch-color js-filter" style="color:#af0000" data-color="Đỏ"></a>
                    <div class="color-name">Đỏ</div>
                  </div>
                  <div class="color-swatch text-center me-3 mb-3">
                    <a href="#" class="swatch-color js-filter" style="color:#d38585" data-color="Hồng"></a>
                    <div class="color-name">Hồng</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- RATING -->
        <div class="accordion" id="rating-filters">
          <div class="accordion-item mb-4 pb-3">
            <h5 class="accordion-header">
              <button class="accordion-button p-0 border-0 fs-5 text-uppercase" type="button"
                      data-bs-toggle="collapse" data-bs-target="#accordion-filter-rating" aria-expanded="true">
                Đánh giá
              </button>
            </h5>
            <div id="accordion-filter-rating" class="accordion-collapse collapse show border-0">
              <ul class="list-unstyled mb-0">
                <% const r = parseInt(rating || '0', 10); %>
                <% [5,4,3,2,1].forEach(st => { %>
                  <li class="mb-2">
                    <label class="d-flex align-items-center gap-2">
                      <input type="radio" name="rating" class="form-check-input js-rating" value="<%= st %>" <%= r===st ? 'checked' : '' %> >
                      <span>
                        <% for(let i=1;i<=5;i++){ %>
                          <span class="<%= i<=st ? 'text-warning' : 'text-muted' %>">★</span>
                        <% } %>
                        <small class="text-muted">từ <%= st %> sao</small>
                      </span>
                    </label>
                  </li>
                <% }) %>
                <li><button class="btn btn-sm btn-outline-secondary mt-1" id="clearRating">Xóa đánh giá</button></li>
              </ul>
            </div>
          </div>
        </div>

        <!-- PRICE -->
        <div class="accordion" id="price-filters">
          <div class="accordion-item mb-4">
            <h5 class="accordion-header mb-2">
              <button class="accordion-button p-0 border-0 fs-5 text-uppercase" type="button"
                      data-bs-toggle="collapse" data-bs-target="#accordion-filter-price" aria-expanded="true">
                Mức giá
              </button>
            </h5>
            <div id="accordion-filter-price" class="accordion-collapse collapse show border-0">
              <!-- Inputs -->
              <div class="d-flex align-items-center gap-2">
                <input type="number" min="0" class="form-control" id="minPrice" placeholder="Từ"
                       value="<%= (price_range && price_range.split(',')[0]) || '' %>">
                <span class="text-muted">—</span>
                <input type="number" min="0" class="form-control" id="maxPrice" placeholder="Đến"
                       value="<%= (price_range && price_range.split(',')[1]) || '' %>">
              </div>
              <div class="d-flex gap-2 mt-2">
                <button class="btn btn-sm btn-primary" id="applyPrice">Áp dụng</button>
                <button class="btn btn-sm btn-outline-secondary" id="clearPrice">Xóa</button>
              </div>

              <!-- Quick ranges (checkbox – chỉ chọn 1) -->
              <ul class="mt-3 list-unstyled">
                <li>
                  <label class="d-flex align-items-center gap-2">
                    <input type="checkbox" class="form-check-input js-quick-price" data-min="" data-max="">
                    <span>Tất cả</span>
                  </label>
                </li>
                <li>
                  <label class="d-flex align-items-center gap-2">
                    <input type="checkbox" class="form-check-input js-quick-price" data-min="0" data-max="100000">
                    <span>Dưới 1 trăm</span>
                  </label>
                </li>
                <li>
                  <label class="d-flex align-items-center gap-2">
                    <input type="checkbox" class="form-check-input js-quick-price" data-min="100000" data-max="200000">
                    <span>1 trăm - 2 trăm</span>
                  </label>
                </li>
                <li>
                  <label class="d-flex align-items-center gap-2">
                    <input type="checkbox" class="form-check-input js-quick-price" data-min="200000" data-max="500000">
                    <span>2 trăm - 5 trăm</span>
                  </label>
                </li>
                <li>
                  <label class="d-flex align-items-center gap-2">
                    <input type="checkbox" class="form-check-input js-quick-price" data-min="500000" data-max="">
                    <span>Trên 5 trăm</span>
                  </label>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </aside>

      <!-- LIST -->
      <div class="shop-list flex-grow-1">
        <!-- Top toolbar -->
        <div class="d-flex justify-content-between mb-4 pb-md-2">
          <div class="toolbar-left">
            <!-- Search -->
            <form class="search-inline" method="GET" action="/category/<%= selectedCategoryId || 'alls' %>">
              <input type="hidden" name="sort"        value="<%= sort || '' %>">
              <input type="hidden" name="price_range" value="<%= price_range || '' %>">
              <input type="hidden" name="brand"       value="<%= brand || '' %>">
              <input type="hidden" name="rating"      value="<%= rating || '' %>">
              <input type="hidden" name="color"       value="<%= color || '' %>">
              <input type="hidden" name="pageNo"      value="1">

              <div class="input-group search-pill">
                <span class="input-group-text border-0 bg-transparent">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M21 21l-4.2-4.2M10.8 18a7.2 7.2 0 1 1 0-14.4 7.2 7.2 0 0 1 0 14.4z"
                          stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </span>
                <input type="text" name="q" class="form-control border-0" placeholder="Tìm sản phẩm..."
                       value="<%= q || '' %>" aria-label="Tìm sản phẩm"/>
                <% if (q && q.trim() !== '') { %>
                  <button class="btn btn-clear" type="button" id="btnClearKeyword" title="Xóa tìm kiếm">×</button>
                <% } %>
                <button class="btn btn-primary px-4" type="submit">Tìm</button>
              </div>
            </form>
          </div>

          <!-- Sort -->
          <form method="GET" action="/category/<%= selectedCategoryId || 'alls' %>">
            <div class="shop-acs d-flex align-items-center justify-content-between justify-content-md-end flex-grow-1">
              <select class="shop-acs__select form-select w-auto border-0 py-0" aria-label="Sort Items" name="sort" onchange="this.form.submit();">
                <option <%= sort == null ? 'selected' : '' %> value="">Mặc định</option>
                <option <%= sort === 'a_z' ? 'selected' : '' %> value="a_z">Tên A-Z</option>
                <option <%= sort === 'z_a' ? 'selected' : '' %> value="z_a">Tên Z-A</option>
                <option <%= sort === 'price_low_to_high' ? 'selected' : '' %> value="price_low_to_high">Giá tăng dần</option>
                <option <%= sort === 'price_high_to_low' ? 'selected' : '' %> value="price_high_to_low">Giá giảm dần</option>
              </select>
            </div>
          </form>
        </div>

        <!-- TITLE -->
        <div class="mb-3 pb-2 pb-xl-3">
          <h1 class="text-uppercase" style="font-size:2rem"><%= selectedCategoryName %></h1>
        </div>

        <!-- GRID -->
        <div class="products-grid row row-cols-2 row-cols-md-4" id="products-grid">
          <% (products.content || []).forEach(product => { %>
            <div class="product-card-wrapper">
              <div class="product-card mb-3 mb-md-4 mb-xxl-5">
                <div class="pc__img-wrapper">
                  <a href="/product_detail/<%= product._id || product.id %>">
                    <img loading="lazy"
                         src="<%= product.colors?.length ? (product.colors[0]?.imageUrls?.[0] || '/images/default.png') : '/images/default.png' %>"
                         width="258" height="313" alt="<%= product.name %>" class="pc__img">
                    <img loading="lazy"
                         src="<%= product.colors?.length && (product.colors[0]?.imageUrls?.length>1) ? product.colors[0].imageUrls[1] : (product.colors?.length ? product.colors[0].imageUrls?.[0] : '/images/default.png') %>"
                         width="258" height="313" alt="<%= product.name %>" class="pc__img pc__img-second">
                    <% 
                      let statusFrame = '/mixishop/images/frame_new.png';
                      const s = product.productStatus?.statusName;
                      if (s === 'Bán chạy') statusFrame = '/mixishop/images/frame_banchay.png';
                      else if (s === 'Trending') statusFrame = '/mixishop/images/frame_trending.png';
                    %>
                    <img class="category-banner__frame" src="<%= statusFrame %>" alt="Status Frame">
                  </a>
                </div>

                <!-- Color swatches per product -->
                <div class="d-flex align-items-center mt-1 custom-swatch-container">
                  <% (product.colors || []).forEach(pc => { %>
                    <a href="#"
                       class="swatch-color custom-swatch-color"
                       style="background-image:url('<%= pc.imageUrls?.[0] || '' %>');background-size:cover;"
                       data-images="<%= (pc.imageUrls || []).join(',') %>"
                       onclick="changeColor(this);return false;"
                       title="<%= pc.color %>"></a>
                  <% }) %>
                </div>

                <div class="pc__info position-relative">
                  <p class="pc__category"><%= product.category?.name || product.category_id?.name || '' %></p>
                  <h6 class="pc__title"><a href="/product_detail/<%= product._id || product.id %>"><%= product.name %></a></h6>

                  <div class="rating-stars d-flex align-items-center mb-2">
                    <% const _avg = Math.round(product.avg_rating || 0); %>
                    <% for (let i=1;i<=5;i++){ %>
                      <span class="<%= i<=_avg ? 'on' : 'off' %>">★</span>
                    <% } %>
                    <small class="ms-2 text-muted">(<%= product.rating_count || 0 %> đánh giá)</small>
                  </div>

                  <div class="product-card__price d-flex">
                    <span class="money price" style="color:blue;"><%= formatPrice(product.price) %></span>
                  </div>

                  <div class="small text-muted">
                    Thương hiệu: <strong><%= product.brand_id?.name || product.brand?.name || 'Đang cập nhật' %></strong>
                  </div>

                  <button class="pc__btn-wl position-absolute top-0 end-0 bg-transparent border-0 js-add-wishlist" title="Thêm vào danh sách yêu thích">
                    <svg width="16" height="16" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg"><use href="/images/sprite.svg#icon_heart" /></svg>
                  </button>
                </div>
              </div>
            </div>
          <% }) %>
        </div>

        <!-- PAGINATION -->
        <%
          const totalPages  = Math.max((products && products.totalPages) || 1, 1);
          const currentPage = ((products && products.number) || 0) + 1;
          const hasPrev     = !!(products && products.hasPrevious);
          const hasNext     = !!(products && products.hasNext);

          const qs = (page) =>
            `pageNo=${page}`
            + `&sort=${encodeURIComponent(sort || '')}`
            + `&price_range=${encodeURIComponent(price_range || '')}`
            + `&brand=${encodeURIComponent(brand || '')}`
            + `&rating=${encodeURIComponent(rating || '')}`
            + `&color=${encodeURIComponent(color || '')}`
            + `&q=${encodeURIComponent(q || '')}`;

          const baseUrl = `/category/${selectedCategoryId || 'alls'}`;
        %>

        <nav class="shop-pages d-flex justify-content-between mt-3" aria-label="Phân trang">
          <a href="<%= hasPrev ? (baseUrl + '?' + qs(currentPage - 1)) : '#' %>"
             class="btn-link d-inline-flex align-items-center <%= hasPrev ? '' : 'disabled' %>"
             aria-disabled="<%= hasPrev ? 'false' : 'true' %>"
             style="opacity:<%= hasPrev ? 1 : 0.5 %>; pointer-events:<%= hasPrev ? 'auto' : 'none' %>;">
            <svg class="me-1" width="7" height="11" viewBox="0 0 7 11" xmlns="http://www.w3.org/2000/svg">
              <use href="/images/sprite.svg#icon_prev_sm" />
            </svg>
            <span class="fw-medium">TRƯỚC</span>
          </a>

          <ul class="pagination mb-0">
            <% for (let i = 1; i <= totalPages; i++) { %>
              <li class="page-item">
                <a href="<%= baseUrl + '?' + qs(i) %>"
                   class="btn-link px-1 mx-2 <%= currentPage === i ? 'btn-link_active' : '' %>"><%= i %></a>
              </li>
            <% } %>
          </ul>

          <a href="<%= hasNext ? (baseUrl + '?' + qs(currentPage + 1)) : '#' %>"
             class="btn-link d-inline-flex align-items-center <%= hasNext ? '' : 'disabled' %>"
             aria-disabled="<%= hasNext ? 'false' : 'true' %>"
             style="opacity:<%= hasNext ? 1 : 0.5 %>; pointer-events:<%= hasNext ? 'auto' : 'none' %>;">
            <span class="fw-medium me-1">TIẾP</span>
            <svg width="7" height="11" viewBox="0 0 7 11" xmlns="http://www.w3.org/2000/svg">
              <use href="/images/sprite.svg#icon_next_sm" />
            </svg>
          </a>
        </nav>
      </div>
    </section>
  </main>

  <%- include('partials/footer') %>
    <%- include('partials/icons') %>
    <%- include('partials/login_form') %>
    <%- include('partials/cart_drawer') %>
    <%- include('partials/quick_view') %>
    <%- include('partials/sitemap') %>

  <!-- External JavaScripts -->
    <script src="/mixishop/js/plugins/jquery.min.js"></script>
    <script src="/mixishop/js/plugins/bootstrap.bundle.min.js"></script>
    <script src="/mixishop/js/plugins/bootstrap-slider.min.js"></script>

    <script src="/mixishop/js/plugins/swiper.min.js"></script>
    <script src="/mixishop/js/plugins/countdown.js"></script>

    <!-- Footer Scripts -->
    <script src="/mixishop/js/theme.js"></script>

  <script>
    function changeColor(swatch){
      const images = (swatch.getAttribute('data-images')||'').split(',').filter(Boolean);
      const card = swatch.closest('.product-card');
      const first = card?.querySelector('.pc__img');
      const second = card?.querySelector('.pc__img-second');
      if(first){ first.src = images[0] || first.src; }
      if(second){ second.src = images[1] || images[0] || second.src; }
      card?.querySelectorAll('.custom-swatch-color').forEach(el=>el.classList.remove('swatch_active'));
      swatch.classList.add('swatch_active');
    }
  </script>

  <script>
    (function(){
      const getURL = () => new URL(window.location.href);
      const setParam = (url, key, val) => { if(!val) url.searchParams.delete(key); else url.searchParams.set(key,val); };
      const go = (url) => { url.searchParams.set('pageNo','1'); window.location.href = url.toString(); };

      // Brand (giữ cố định, multi-select)
      document.querySelectorAll('.js-brand').forEach(cb=>{
        cb.addEventListener('change', ()=>{
          const url = getURL();
          const values = [...document.querySelectorAll('.js-brand:checked')].map(x=>x.value.trim());
          setParam(url,'brand', values.join(','));
          go(url);
        });
      });

      // Rating
      document.querySelectorAll('.js-rating').forEach(r=>{
        r.addEventListener('change', ()=>{
          const url = getURL();
          setParam(url, 'rating', r.checked ? r.value : '');
          go(url);
        });
      });
      document.getElementById('clearRating')?.addEventListener('click', (e)=>{
        e.preventDefault();
        const url = getURL();
        setParam(url, 'rating', '');
        go(url);
      });

      // Color
      document.querySelectorAll('.swatch-color.js-filter').forEach(el=>{
        el.addEventListener('click', (e)=>{
          e.preventDefault();
          const url = getURL();
          setParam(url, 'color', el.dataset.color || '');
          go(url);
        });
      });
      // reflect color active from URL
      const curColor = getURL().searchParams.get('color');
      if(curColor){
        document.querySelectorAll('.swatch-color.js-filter').forEach(el=>{
          el.classList.toggle('swatch_active', el.dataset.color===curColor);
        });
      }

      // Price
      const minI = document.getElementById('minPrice');
      const maxI = document.getElementById('maxPrice');
      const uncheckQuick = () => document.querySelectorAll('.js-quick-price').forEach(cb => cb.checked = false);

      function applyPrice(min, max){
        const url = getURL();
        if(!min && !max) url.searchParams.delete('price_range');
        else url.searchParams.set('price_range', (min||'')+','+(max||''));
        url.searchParams.set('pageNo','1');
        window.location.href = url.toString();
      }
      document.getElementById('applyPrice')?.addEventListener('click', ()=>{ uncheckQuick(); applyPrice(minI.value, maxI.value); });
      document.getElementById('clearPrice')?.addEventListener('click', ()=>{
        minI.value=''; maxI.value='';
        const allCb = document.querySelector('.js-quick-price[data-min=""][data-max=""]'); if(allCb) allCb.checked = true;
        applyPrice('','');
      });

      // Quick price (single-select)
      document.querySelectorAll('.js-quick-price').forEach(cb=>{
        cb.addEventListener('change', ()=>{
          document.querySelectorAll('.js-quick-price').forEach(o=>{ if(o!==cb) o.checked=false; });
          applyPrice(cb.dataset.min || '', cb.dataset.max || '');
        });
      });

      // Reflect quick price from URL on load
      (function reflectQuickPrice(){
        const url = getURL();
        const pr = url.searchParams.get('price_range') || '';
        const [curMin, curMax] = pr.split(',');
        let matched = false;
        document.querySelectorAll('.js-quick-price').forEach(cb=>{
          const m = cb.dataset.min || '';
          const x = cb.dataset.max || '';
          const ok = (curMin ?? '')===m && (curMax ?? '')===x && pr !== null && (m!=='' || x!=='');
          cb.checked = ok;
          if(ok) matched = true;
        });
        if(!matched){
          const allCb = document.querySelector('.js-quick-price[data-min=""][data-max=""]');
          if(allCb) allCb.checked = true;
        }
      })();

      // Clear keyword button
      (function(){
        const btn = document.getElementById('btnClearKeyword');
        if(!btn) return;
        btn.addEventListener('click', function(){
          const form = this.closest('form');
          const input = form.querySelector('input[name="q"]');
          input.value = '';
          const page = form.querySelector('input[name="pageNo"]');
          if(page) page.value = '1';
          form.submit();
        });
      })();
    })();
  </script>
</body>
</html>
